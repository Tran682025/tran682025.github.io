<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiChordify Kingdom</title>
  <link rel="icon" href="data:,"/>
  <style>
    :root{--pi:#7b2bf9;--ink:#261b39;--bg:#f3eaff}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:920px;margin:24px auto;padding:16px}
    .note{opacity:.7;margin:8px 0;font-size:14px;letter-spacing:.5px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);
      padding:16px;margin:14px 0}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{border:0;background:var(--pi);color:#fff;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-outline{background:#fff;color:var(--pi);border:2px solid var(--pi)}
    .mono{font-family:ui-monospace,Consolas,monospace}
    label{font-size:14px;opacity:.9}
    input,select{padding:10px;border:1px solid #ddd;border-radius:10px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eee;margin:4px;font-family:ui-monospace,Consolas,monospace}
    .muted{opacity:.65}
    .chords{line-height:1.9}
    .eagle{font-weight:800;letter-spacing:.6px}
  </style>

  <!-- Pi SDK v2 -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>PiChordify <span class="eagle">Kingdom</span></h1>
    <div class="note">
      Bản minh hoạ <b>thanh toán Pi</b> + <b>mở khoá hợp âm</b> kèm transposer.
      <span class="muted mono">Mẹo: thêm <code>?sandbox=1</code> vào URL khi test Sandbox.</span>
    </div>

    <!-- Đăng nhập & trạng thái -->
    <div class="card">
      <div class="row" style="margin-top:2px">
        <button id="loginBtn">🔐 Đăng nhập với Pi</button>
        <button id="logoutBtn" class="btn-outline">🚪 Đăng xuất</button>
        <div id="hello" class="pill mono">Chưa đăng nhập</div>
      </div>

      <div style="margin-top:10px">
        <b>Premium:</b>
        <span id="premium-status" class="pill">🔒 Chưa mua Premium</span>
      </div>

      <div style="margin-top:10px">
        <button id="buyBtn">💎 Mua Premium — 1 Pi</button>
        <span class="muted mono">Giao dịch sẽ gọi Worker <code>/approve</code> & <code>/complete</code>.</span>
      </div>
    </div>

    <!-- Transposer & Hợp âm -->
    <div class="card">
      <div class="row">
        <div>
          <label for="songSel">Chọn bài: </label>
          <select id="songSel"></select>
        </div>
        <div>
          <label for="shiftInp">Transpose (semitones): </label>
          <input id="shiftInp" class="mono" type="number" value="0" step="1" style="width:120px"/>
        </div>
        <button id="applyBtn" class="btn-outline">Áp dụng</button>
      </div>
      <div id="lockMsg" class="note" style="margin-top:8px;display:none">
        🔒 Đây là nội dung Premium. Hãy mua để mở khoá hơn 100+ tune (demo).
      </div>
      <div id="chords" class="chords" style="margin-top:12px"></div>
    </div>

    <div class="note">
      🦅 <b>Backend:</b> <code>https://pichordifykingdom.workers.dev</code> → <code>/approve</code>, <code>/complete</code>.
      Đổi domain trong hằng số <code>WORKER_BASE</code> nếu Trẫm đặt tên khác.
    </div>
  </div>

  <script>
  // ========= CONFIG =========
  // 👉 Nếu Worker của Trẫm có tên khác, sửa dòng này:
  const WORKER_BASE = 'https://pichordifykingdom.workers.dev';

  // Sandbox switch: ?sandbox=1
  const url = new URL(location.href);
  const forceSandbox = url.searchParams.get('sandbox') === '1';

  // ========= Pi SDK init =========
  // Ở Pi Browser production, bỏ sandbox; khi test thì bật với ?sandbox=1
  Pi.init({ version: "2.0", sandbox: forceSandbox });

  // ========= Mini songbook (demo) =========
  // basic = free; premium = cần mua
  const SONGS = {
    free: [
      {
        id: 'free_001',
        title: 'Happy Day (Free)',
        lines: [
          'C  G  Am  F',
          'C  G  Am  F',
          'F  G  C   -'
        ]
      },
      {
        id: 'free_002',
        title: 'Sunny Road (Free)',
        lines: [
          'Dm  G  C  Am',
          'Dm  G  C  C',
          'F   G  Em Am'
        ]
      }
    ],
    premium: [
      {
        id: 'pro_101',
        title: 'Kingdom Anthem (Pro)',
        lines: [
          'G   D   Em   C',
          'G   D   C    C',
          'Am  D   G    -'
        ]
      },
      {
        id: 'pro_102',
        title: 'Eagle Flight (Pro)',
        lines: [
          'Bm  G  D  A',
          'Bm  G  D  A',
          'Em  A  D  -'
        ]
      }
    ]
  };

  const ALL_SONGS = [...SONGS.free, ...SONGS.premium];

  // ========= Helpers =========
  const $ = sel => document.querySelector(sel);

  function isPremium() {
    return localStorage.getItem('pck_premium') === 'true';
  }

  function updatePremiumStatus(flag){
    const el = $('#premium-status');
    if(flag){
      el.textContent = '✅ Đã mua Premium';
      el.classList.remove('pill');
      el.classList.add('pill');
    }else{
      el.textContent = '🔒 Chưa mua Premium';
    }
    const lock = $('#lockMsg');
    lock.style.display = flag ? 'none' : 'block';
  }

  // Very small transposer (C C# D ... B)
  const ORDER = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  function transposeChord(ch, shift){
    // keep minor/7/maj etc
    const m = ch.match(/^([A-G](?:#|b)?)(.*)$/);
    if(!m) return ch;
    let [_, root, tail] = m;
    // flats -> sharps
    const flat = {Db:'C#', Eb:'D#', Gb:'F#', Ab:'G#', Bb:'A#'};
    if(flat[root]) root = flat[root];
    const idx = ORDER.indexOf(root);
    if(idx<0) return ch;
    const next = ORDER[(idx + shift + 12*1000) % 12];
    return next + tail;
  }
  function transposeLine(line, shift){
    if(!shift) return line;
    return line.split(/\s+/).map(tok => {
      if(!tok) return tok;
      return transposeChord(tok, shift);
    }).join('  ');
  }

  function renderBasicChords(songObj){
    const shift = parseInt($('#shiftInp').value||'0',10);
    const html = songObj.lines
      .map(l => `<div class="mono">${transposeLine(l, shift)}</div>`)
      .join('');
    $('#chords').innerHTML = html;
  }

  function buildSongSelect(){
    const sel = $('#songSel');
    sel.innerHTML = '';
    ALL_SONGS.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.title + (SONGS.premium.find(p=>p.id===s.id)?' 🔒':'');
      sel.appendChild(opt);
    });
  }

  function getSelectedSong(){
    const id = $('#songSel').value;
    return ALL_SONGS.find(s => s.id === id);
  }

  // ========= Backend call (Worker) =========
  async function callAPI(path, body){
    const r = await fetch(`${WORKER_BASE}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      credentials: 'omit',
      mode: 'cors'
    });
    if(!r.ok){
      const t = await r.text().catch(()=>r.statusText);
      throw new Error(`API ${path} failed: ${r.status} ${t}`);
    }
    return r.json().catch(()=> ({}));
  }

  // ========= Auth =========
  async function login(){
    try{
      const scopes = ['username','payments'];
      await Pi.authenticate(scopes, function (payment) {
        console.log('Incomplete payment found:', payment);
      }).then(function(auth){
        $('#hello').textContent = `Xin chào: @${auth.user.username} 🎵`;
      });
      alert('Đăng nhập thành công!');
    }catch(e){
      alert('Đăng nhập thất bại: ' + (e?.message||e));
    }
  }

  function logout(){
    // Client chỉ xóa trạng thái cục bộ (Pi Browser tự quản phiên)
    $('#hello').textContent = 'Chưa đăng nhập';
  }

  // ========= Payment (Premium) =========
  async function payPremium(){
    try{
      await Pi.createPayment({
        amount: 1,
        memo: 'PiChordify Premium Access',
        metadata: { type:'premium', item:'access' }
      }, {
        onReadyForServerApproval: async function (paymentId) {
          // gọi Worker /approve
          await callAPI('/approve', { paymentId });
        },
        onReadyForServerCompletion: async function (paymentId, txid) {
          // gọi Worker /complete
          await callAPI('/complete', { paymentId, txid });
          localStorage.setItem('pck_premium','true');
          updatePremiumStatus(true);
          alert('Thanh toán thành công ✅');
        },
        onCancel: function (paymentId) {
          console.log('User cancelled', paymentId);
          alert('Đã huỷ thanh toán.');
        },
        onError: function (error, paymentId) {
          console.error('Payment error', error, paymentId);
          alert('Lỗi thanh toán: ' + (error?.message||error));
        }
      });
    }catch(e){
      alert('Có lỗi khi mua Premium: ' + (e?.message||e));
    }
  }

  // ========= UI bindings =========
  document.getElementById('loginBtn').onclick = login;
  document.getElementById('logoutBtn').onclick = logout;
  document.getElementById('buyBtn').onclick = payPremium;
  document.getElementById('applyBtn').onclick = () => renderBasicChords(getSelectedSong());
  document.getElementById('songSel').onchange = () => renderBasicChords(getSelectedSong());

  // ========= Init view =========
  buildSongSelect();
  updatePremiumStatus(isPremium());
  renderBasicChords(getSelectedSong());
  </script>
</body>
</html>
