<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PiChordify Kingdom ‚Äî v7.1.3</title>
  <style>
    :root{
      --bg:#0b1120; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#a78bfa;
      --pill:#1f2937; --btn:#374151; --btn2:#4c1d95;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto;
      color:var(--text); background:radial-gradient(1200px 600px at 10% 0%,#0b132b 0,#0b1120 60%,#050816 100%)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .title{display:flex;align-items:end;gap:10px}
    .h1{font-weight:800;line-height:.95;font-size:clamp(28px,6vw,64px)}
    .badge{background:#312e81;color:#c7d2fe;border:1px solid #4338ca;padding:.25rem .55rem;border-radius:.6rem}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;margin-top:10px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:18px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .lab{color:var(--muted);font-size:.9rem}
    select,input,textarea,button{background:#0f172a;color:var(--text);border:1px solid #1f2937;border-radius:12px}
    select,input{height:40px;padding:0 12px}
    textarea{width:100%;min-height:160px;padding:12px;border-radius:14px;resize:vertical;line-height:1.5}
    button{height:40px;padding:0 14px;cursor:pointer}
    .btn{background:var(--btn)}
    .btn:hover{filter:brightness(1.12)}
    .btn-accent{background-image:linear-gradient(135deg,#8b5cf6,#06b6d4)}
    .pill{background:var(--pill);padding:.3rem .7rem;border-radius:999px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .right{display:flex;flex-direction:column;gap:18px}
    .logbox{height:220px;overflow:auto;white-space:pre-wrap;background:#0a0f1f;border:1px solid #1f2937;border-radius:14px;padding:12px}
    .small{font-size:.85rem;color:var(--muted)}
    .range{width:100%}
    .muted{color:var(--muted)}
    .footer{opacity:.7;text-align:center;margin-top:26px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div class="h1">PiChordify<br/>Kingdom</div>
      <span class="badge">v7.1.3</span>
      <span class="pill">Theme: t√≠m‚Äìng·ªçc</span>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row">
          <label class="lab">Gi·ªçng (key)</label>
          <select id="selKey">
            <option>C</option><option>Db</option><option>D</option><option>Eb</option><option>E</option>
            <option>F</option><option>Gb</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
          </select>

          <label class="lab">Ti·∫øn tr√¨nh</label>
          <select id="selProg">
            <option>I‚ÄìV‚Äìvi‚ÄìIV</option>
            <option>I‚Äìvi‚ÄìIV‚ÄìV</option>
            <option>ii‚ÄìV‚ÄìI</option>
            <option>I‚ÄìIV‚ÄìV‚ÄìIV</option>
            <option>vi‚ÄìIV‚ÄìI‚ÄìV</option>
          </select>

          <button class="btn" id="btnSuggest">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="title" placeholder="Ti√™u ƒë·ªÅ" style="flex:1"/>
          <span class="pill">Sandbox</span>
        </div>

        <div class="split" style="margin-top:12px">
          <div>
            <div class="lab">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî d·∫°ng: <span class="mono">mm:ss Em / D</span>)</div>
            <textarea id="lyrics" placeholder="00:12 Em / D ..."></textarea>
          </div>
          <div>
            <div class="lab">G·ª£i √Ω h·ª£p √¢m</div>
            <textarea id="suggest" placeholder="Nh·∫•n 'T·ª± g·ª£i √Ω h·ª£p √¢m'..." readonly></textarea>
          </div>
        </div>

        <div class="split" style="margin-top:12px">
          <div class="card" style="padding:12px">
            <div class="lab">Audio (mp3)</div>
            <input id="audioUrl" placeholder="https://.../song.mp3"/>
            <div class="toolbar" style="margin-top:10px">
              <button class="btn" id="btnPlay">Play</button>
              <button class="btn" id="btnPause">Pause</button>
              <button class="btn" id="btnStop">Stop</button>
              <span class="small" id="timeLbl">0:00 / 0:00</span>
            </div>
            <input type="range" min="0" max="1000" value="0" id="progress" class="range"/>
            <div class="row">
              <label class="lab">BPM</label><input id="bpm" type="number" value="60" style="width:90px"/>
              <label class="lab">Offset (gi√¢y, ¬±)</label><input id="offset" type="number" value="0" style="width:110px"/>
            </div>
          </div>

          <div class="card" style="padding:12px">
            <div class="lab">Xu·∫•t/Nh·∫≠p</div>
            <div class="toolbar" style="margin-top:8px">
              <button class="btn" id="btnSave">Save</button>
              <button class="btn" id="btnLoad">Load</button>
              <button class="btn" id="btnShare">Share link</button>
            </div>
            <div class="small" style="margin-top:8px">L∆∞u c·ª•c b·ªô (localStorage). ‚ÄúShare link‚Äù ch·ªâ hi·ªÉn th·ªã d·ªØ li·ªáu m√£ h√≥a trong URL.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div class="lab">ƒêƒÉng nh·∫≠p & thanh to√°n</div>
            <div class="toolbar">
              <button class="btn" id="btnPiLogin">Pi Login</button>
              <button class="btn" id="btnPremium">Ki·ªÉm tra Premium</button>
              <button class="btn btn-accent" id="btnPiPay">Pi Pay (sandbox)</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="lab">Log</div>
            <span class="pill small">Console mirror</span>
          </div>
          <div id="log" class="logbox mono"></div>
        </div>
      </div>
    </div>

    <div class="footer small">¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù v7.1.3</div>
  </div>

  <!-- Hidden audio -->
  <audio id="audio" preload="auto"></audio>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
  /* ========= Helpers & Logger ========= */
  const $ = (id) => document.getElementById(id);
  const logBox = $('log');
  function log(...args){
    const line = '['+new Date().toLocaleTimeString()+'] ' + args.map(x => typeof x==='string'?x:JSON.stringify(x)).join(' ');
    logBox.textContent += line + '\n';
    logBox.scrollTop = logBox.scrollHeight;
    console.log(...args);
  }
  window.onerror = (m,s,l,c,e)=>{ log('‚ùå', m, s+':'+l, e?.stack||''); };
  window.addEventListener('unhandledrejection', ev=>log('‚ùå promise', ev.reason?.message||ev.reason));

  /* ========= Chords Engine ========= */
  const KEYS = {
    C: ['C','Dm','Em','F','G','Am','Bdim'],
    Db:['Db','Ebm','Fm','Gb','Ab','Bbm','Cdim'],
    D: ['D','Em','F#m','G','A','Bm','C#dim'],
    Eb:['Eb','Fm','Gm','Ab','Bb','Cm','Ddim'],
    E: ['E','F#m','G#m','A','B','C#m','D#dim'],
    F: ['F','Gm','Am','Bb','C','Dm','Edim'],
    Gb:['Gb','Abm','Bbm','B','Db','Ebm','Fdim'],
    G: ['G','Am','Bm','C','D','Em','F#dim'],
    Ab:['Ab','Bbm','Cm','Db','Eb','Fm','Gdim'],
    A: ['A','Bm','C#m','D','E','F#m','G#dim'],
    Bb:['Bb','Cm','Dm','Eb','F','Gm','Adim'],
    B: ['B','C#m','D#m','E','F#','G#m','A#dim'],
  };
  const DEG = { 'I':0,'ii':1,'II':1,'iii':2,'III':2,'IV':3,'V':4,'vi':5,'VI':5,'vii':6,'VII':6 };

  function suggestChords(){
    const key = $('selKey').value;
    const prog = $('selProg').value;
    const bank = KEYS[key] || KEYS.C;
    const parts = prog.replace(/\s+/g,'').split(/[‚Äì-]/g);
    const out = parts.map(p=>{
      const d = DEG[p] ?? null;
      return d==null ? '?' : bank[d];
    }).join('  |  ');
    $('suggest').value = `${key} major ‚Ä¢ ${prog}\n${out}`;
    log('üéº suggest:', out);
  }

  /* ========= Audio ========= */
  const audio = $('audio'); const progress = $('progress'); const timeLbl = $('timeLbl');
  audio.addEventListener('timeupdate', ()=>{
    if (!isFinite(audio.duration)) return;
    progress.value = Math.floor(1000*audio.currentTime/audio.duration);
    timeLbl.textContent = fmt(audio.currentTime)+' / '+fmt(audio.duration);
  });
  audio.addEventListener('canplay', ()=>log('‚úÖ AUDIO canplay, duration:', audio.duration.toFixed(2)));
  audio.addEventListener('stalled', ()=>log('‚ö†Ô∏è AUDIO stalled'));
  audio.addEventListener('error', ()=>log('‚ùå AUDIO error code:', audio.error?.code));

  function fmt(s){ if (!isFinite(s)) return '0:00'; const m=Math.floor(s/60); const ss=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
  function setSrc(url){
    try{
      const clean = encodeURI(url.trim());
      audio.crossOrigin = 'anonymous';
      audio.src = clean; audio.load();
      log('üéµ audio src =', clean);
    }catch(e){ log('‚ùå setSrc', e.message); }
  }
  $('btnPlay').addEventListener('click', ()=>{ const u=$('audioUrl').value.trim(); if(u) setSrc(u); audio.play().catch(e=>log('‚ùå play', e.message)); });
  $('btnPause').addEventListener('click', ()=>audio.pause());
  $('btnStop').addEventListener('click', ()=>{ audio.pause(); audio.currentTime=0; });
  progress.addEventListener('input', ()=>{
    if (isFinite(audio.duration)) audio.currentTime = (progress.value/1000)*audio.duration;
  });

  /* ========= Save/Load/Share ========= */
  const LSKEY='pichordify_state';
  function state(){
    return {
      title:$('title').value, key:$('selKey').value, prog:$('selProg').value,
      lyrics:$('lyrics').value, audio:$('audioUrl').value,
      bpm:$('bpm').value, offset:$('offset').value,
    };
  }
  function apply(s){
    if(!s) return;
    $('title').value = s.title||'';
    $('selKey').value = s.key||'C';
    $('selProg').value = s.prog||'I‚ÄìV‚Äìvi‚ÄìIV';
    $('lyrics').value = s.lyrics||'';
    $('audioUrl').value = s.audio||'';
    $('bpm').value = s.bpm||60;
    $('offset').value = s.offset||0;
  }
  $('btnSave').addEventListener('click', ()=>{ localStorage.setItem(LSKEY, JSON.stringify(state())); log('üíæ save: ok'); });
  $('btnLoad').addEventListener('click', ()=>{ const s=localStorage.getItem(LSKEY); if(s){ apply(JSON.parse(s)); log('üìÇ load: ok'); } });
  $('btnShare').addEventListener('click', ()=>{
    const enc = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(state())))));
    const url = location.origin+location.pathname+'#s='+enc;
    navigator.clipboard?.writeText(url);
    log('üîó copied share link.');
  });
  (function tryOpen(){
    const m = location.hash.match(/s=([^&]+)/); if(!m) return;
    try{ const obj = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(m[1])))));
      apply(obj); log('üì• open from share link: ok');
    }catch(e){ log('‚ùå open share', e.message); }
  })();

  /* ========= Pi SDK & Payments ========= */
  async function initPi(){
    try{
      await Pi.init({ version:'2.0', sandbox:true });
      log('‚úÖ Pi SDK initialized (v2, sandbox)');
    }catch(e){ log('‚ùå Pi init', e.message); }
    if (!Pi?.isPiBrowser?.()){
      log('‚ö†Ô∏è H√£y m·ªü trang n√†y trong Pi Browser ƒë·ªÉ d√πng Pi Login / Pi Pay.');
      $('btnPiLogin').disabled = $('btnPiPay').disabled = true;
    }
  }

  async function piLogin(){
    try{
      const scopes=['payments','username','wallet_address'];
      const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
      log('üôã Login OK:', auth.user?.username||'(unknown)');
      return auth;
    }catch(e){ log('‚ùå Login', e.message); }
  }

  async function piPaySandbox(amount=0.01){
    try{
      const auth = await piLogin(); if(!auth) return;
      const pay = await Pi.createPayment({
        amount:String(amount),
        memo:'PiChordify v7.1.3 sandbox test',
        metadata:{feature:'premium',v:'7.1.3'},
        callbacks:{
          onReadyForServerApproval:(pid)=>log('ü™ô readyForApproval', pid),
          onReadyForServerCompletion:(pid,txid)=>log('‚úÖ completed', pid, txid),
          onCancel:(pid)=>log('üö´ canceled', pid),
          onError:(err)=>log('‚ö†Ô∏è onError', err?.message||err),
        },
      });
      log('createPayment ->', pay);
    }catch(e){ log('‚ùå Payment', e.message); }
  }
  function onIncompletePaymentFound(p){ log('‚ö†Ô∏è incomplete payment:', p?.identifier||p); }

  $('btnPiLogin').addEventListener('click', piLogin);
  $('btnPiPay').addEventListener('click', ()=>piPaySandbox(0.01));
  $('btnPremium').addEventListener('click', ()=>log('‚≠ê Premium (demo sandbox): h√£y thanh to√°n ƒë·ªÉ m·ªü kho√°.'));

  /* ========= Wire UI ========= */
  $('btnSuggest').addEventListener('click', suggestChords);

  /* ========= Boot ========= */
  window.addEventListener('load', ()=>{
    suggestChords();
    initPi();
    log('Ready');
  });
  </script>
</body>
</html>
