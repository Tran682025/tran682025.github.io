<!-- index.html  (PiChordify Kingdom â€“ Sandbox Payment + Transposer Demo â€“ v2) -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
  <title>PiChordify Kingdom</title>
  <style>
    :root{--pri:#6b21a8;--bg:#f3eaff;}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:24px}
    .wrap{max-width:760px;margin:auto}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{color:var(--pri);margin:0;font-size:38px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:20px;margin:16px 0}
    button{padding:12px 16px;border-radius:12px;border:0;background:var(--pri);color:#fff;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:#555}
    .ok{color:#047857}
    .err{color:#b91c1c}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    select,input[type="number"]{padding:10px;border-radius:10px;border:1px solid #ddd}
    .chords{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .pill{border:1px solid #ddd;border-radius:12px;padding:8px 12px;background:#fafafa}
    .hint{background:#f8f3ff;border-left:4px solid var(--pri);padding:8px 12px;border-radius:8px}
    .badge{background:#fae8ff;color:#7e22ce;border-radius:999px;padding:2px 10px;font-size:12px;margin-left:6px}
    .divider{height:1px;background:#eee;margin:14px 0}
  </style>
  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- ===== Logo / Nháº¡c cá»¥ ===== -->
    <div class="brand">
      <!-- SVG logo Ä‘Æ¡n giáº£n (ná»‘t nháº¡c + kÃ½ hiá»‡u Pi) -->
      <svg width="42" height="42" viewBox="0 0 64 64" fill="none" aria-hidden="true">
        <circle cx="32" cy="32" r="30" stroke="#6b21a8" stroke-width="4"/>
        <path d="M22 40a6 6 0 1 0 0 12a6 6 0 0 0 0-12Zm0-16V16h20v20a6 6 0 1 0 4 5.657V20H26v16a6 6 0 0 0-4-12Z" fill="#6b21a8"/>
        <text x="31" y="38" font-size="16" text-anchor="middle" fill="#6b21a8">Ï€</text>
      </svg>
      <h1>PiChordify Kingdom <span class="badge">Sandbox</span></h1>
    </div>
    <p class="muted">Báº£n minh há»a **thanh toÃ¡n Pi** + **má»Ÿ khÃ³a bÃ i há»£p Ã¢m** kÃ¨m <b>transposer</b>.</p>

    <!-- ===== Auth ===== -->
    <div class="card">
      <div id="authState" class="muted">ChÆ°a Ä‘Äƒng nháº­p</div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnLogin">ğŸ” ÄÄƒng nháº­p vá»›i Pi</button>
        <button id="btnLogout" disabled>ğŸšª ÄÄƒng xuáº¥t</button>
      </div>
      <div class="hint" style="margin-top:10px">Tip: ÄÃ¢y lÃ  mÃ´i trÆ°á»ng <b>Sandbox</b>. Báº¡n cáº§n má»Ÿ báº±ng <b>Pi Browser</b> (sandbox) Ä‘á»ƒ thá»­ thanh toÃ¡n.</div>
    </div>

    <!-- ===== Product / Payment ===== -->
    <div class="card">
      <h3>ğŸ’ GÃ³i Dáº¡o Nháº¡c â€” 0.3 Pi</h3>
      <p class="muted">Mua gÃ³i Ä‘á»ƒ má»Ÿ khoÃ¡ 1 bÃ i há»£p Ã¢m máº«u + cÃ´ng cá»¥ transpose.</p>
      <button id="btnBuy" disabled>ğŸ›’ Mua ngay (0.3 Pi)</button>
      <div id="status" style="margin-top:12px" class="mono muted"></div>
      <pre id="log" class="mono" style="white-space:pre-wrap"></pre>
      <div class="divider"></div>
      <p class="muted">Sau khi thanh toÃ¡n thÃ nh cÃ´ng, pháº§n ná»™i dung bÃªn dÆ°á»›i sáº½ tá»± má»Ÿ.</p>
    </div>

    <!-- ===== Unlocked Content: Chords + Transposer ===== -->
    <div class="card" id="content" style="display:none">
      <h3>âœ… Ná»™i dung Ä‘Ã£ má»Ÿ khÃ³a</h3>
      <p class="ok">ChÃºc má»«ng! Huynh Ä‘Ã£ má»Ÿ <b>GÃ³i Dáº¡o Nháº¡c</b>. HÃ£y khÃ¡m phÃ¡ há»£p Ã¢m vÃ  Ä‘á»•i tÃ´ng tá»©c thÃ¬.</p>

      <div class="controls">
        <label>ğŸ¼ Chá»n ca khÃºc:
          <select id="songSel">
            <option value="demo1">Demo 1 â€” (C  G  Am  F | C  G  F  F)</option>
            <option value="demo2">Demo 2 â€” (G  D  Em  C | G  D  C  C)</option>
          </select>
        </label>
        <label>â™¯/â™­ Dá»‹ch tÃ´ng (semitone):
          <input id="shiftInp" type="number" min="-6" max="6" value="0" />
        </label>
        <button id="applyBtn">ğŸ”„ Transpose</button>
      </div>

      <div class="hint">Há»£p Ã¢m (Ä‘Ã£ dá»‹ch tÃ´ng):</div>
      <div id="chordView" class="chords" aria-live="polite"></div>
    </div>
  </div>

  <script>
    /************* Pi SDK (SANDBOX) *************/
    Pi.init({ version: "2.0", sandbox: true });

    const $ = (id) => document.getElementById(id);
    const log = (m) => { $("log").textContent += m + "\n"; };
    const setStatus = (t, cls="muted") => { const el=$("status"); el.className = "mono " + cls; el.textContent=t; };

    let currentUser = null;
    const onIncompletePaymentFound = (p) => log("âš ï¸ Incomplete payment: " + p.identifier);

    $("btnLogin").onclick = async () => {
      try {
        const auth = await Pi.authenticate(["username","payments"], onIncompletePaymentFound);
        currentUser = auth.user;
        $("authState").textContent = "ÄÃ£ Ä‘Äƒng nháº­p: @" + auth.user.username;
        $("btnLogout").disabled = false;
        $("btnBuy").disabled = false;
        log("âœ… Auth ok: " + JSON.stringify(auth.user));
      } catch (e) {
        setStatus("ÄÄƒng nháº­p tháº¥t báº¡i: " + e?.message, "err");
      }
    };

    $("btnLogout").onclick = () => {
      currentUser = null;
      $("authState").textContent = "ChÆ°a Ä‘Äƒng nháº­p";
      $("btnLogout").disabled = true;
      $("btnBuy").disabled = true;
      setStatus("ÄÃ£ Ä‘Äƒng xuáº¥t.", "muted");
    };

    $("btnBuy").onclick = async () => {
      if (!currentUser) return setStatus("HÃ£y Ä‘Äƒng nháº­p trÆ°á»›c.", "err");

      const paymentData = {
        amount: 0.3,
        memo: "PiChordify: GoÌi Dáº¡o Nháº¡c",
        metadata: { productId: "chordify_demo_01" }
      };

      const onCancel = (r) => { setStatus("âŒ NgÆ°á»i dÃ¹ng há»§y: " + r, "err"); log("cancel: " + r); };
      const onError  = (e) => { setStatus("ğŸ’¥ Lá»—i: " + (e?.message || e), "err"); log("error: " + JSON.stringify(e)); };

      const onReadyForServerApproval = async (paymentId) => {
        setStatus("Äang gá»­i lÃªn server phÃª duyá»‡tâ€¦", "muted");
        const r = await fetch("https://YOUR_SERVER_HOST/api/approve", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ paymentId })
        });
        if (!r.ok) throw new Error((await r.json())?.error || "Approve failed");
        setStatus("Server Ä‘Ã£ phÃª duyá»‡t. Chá» hoÃ n táº¥tâ€¦", "muted");
      };

      const onReadyForServerCompletion = async (paymentId, txId) => {
        setStatus("Äang hoÃ n táº¥t giao dá»‹ch trÃªn serverâ€¦", "muted");
        const r = await fetch("https://YOUR_SERVER_HOST/api/complete", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ paymentId, txId })
        });
        if (!r.ok) throw new Error((await r.json())?.error || "Complete failed");
        setStatus("ğŸ‰ Thanh toÃ¡n thÃ nh cÃ´ng!", "ok");
        $("content").style.display = "block";
        // hiá»ƒn thá»‹ ngay bÃ i máº·c Ä‘á»‹nh
        renderChords();
      };

      try { await Pi.createPayment(paymentData, onReadyForServerApproval, onReadyForServerCompletion, onCancel, onError); }
      catch(e){ onError(e); }
    };

    /************* Transposer Ä‘Æ¡n giáº£n *************/
    const CHROMA = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const altToSharp = { "Db":"C#", "Eb":"D#", "Gb":"F#", "Ab":"G#", "Bb":"A#" };

    const SONGS = {
      demo1: "C  G  Am  F  |  C  G  F  F",
      demo2: "G  D  Em  C  |  G  D  C  C"
    };

    function normalizeRoot(root){
      if (altToSharp[root]) return altToSharp[root];
      return root;
    }

    function transposeChord(ch, shift){
      // TÃ¡ch pháº§n root + quality (m, 7, maj7â€¦ á»Ÿ Ä‘Ã¢y chá»‰ xá»­ lÃ½ 'm')
      const m = ch.match(/^([A-G](?:#|b)?)(m?)/i);
      if (!m) return ch;
      const root = normalizeRoot(m[1].toUpperCase());
      const quality = m[2] || "";
      const idx = CHROMA.indexOf(root);
      if (idx === -1) return ch;
      const next = (idx + (shift%12) + 12) % 12;
      return CHROMA[next] + quality;
    }

    function transposeLine(line, shift){
      return line.split(/\s+/).map(tok=>{
        if (/^[|]$/.test(tok)) return tok;
        if (!tok) return "";
        return transposeChord(tok, shift);
      }).join("  ");
    }

    function renderChords(){
      const song = $("songSel").value;
      const shift = parseInt($("shiftInp").value || "0", 10);
      const lines = SONGS[song].split("|").map(s=>s.trim());
      $("chordView").innerHTML = "";
      lines.forEach((ln,i)=>{
        const div = document.createElement("div");
        div.className = "pill mono";
        div.textContent = transposeLine(ln, shift);
        $("chordView").appendChild(div);
        if (i < lines.length-1) {
          const bar = document.createElement("div");
          bar.className = "pill";
          bar.textContent = "|";
          $("chordView").appendChild(bar);
        }
      });
    }

    $("applyBtn").onclick = renderChords;
    $("songSel").onchange = renderChords;
  </script>
</body>
  <!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
  // Báº¬T sandbox khi test báº±ng Pi Browser: thÃªm ?onSandbox=1 vÃ o URL
  const WORKER = "https://pichordify-worker.<WORKER_URL_SUBDOMAIN>.workers.dev";

  // Khá»Ÿi táº¡o SDK (v2)
  Pi.init({ version: "2.0" });

  // Helper gá»i backend
  async function callAPI(path, body) {
    const r = await fetch(`${WORKER}${path}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error(`API ${path} failed`);
    return r.json();
  }

  // Mua 1 â€œtuneâ€ 0.3 Pi (Ä‘á»•i sá»‘ tiá»n/memo theo Ã½)
  async function buyTune() {
    try {
      // ÄÄƒng nháº­p vÃ  xin scope payments
      await Pi.authenticate(["username","payments"], () => {});
      await Pi.createPayment(
        { amount: 0.3, memo: "Unlock one chord tune", metadata: { item: "chord_001" } },
        {
          onReadyForServerApproval: (paymentId) =>
            callAPI("/approve", { paymentId }),
          onReadyForServerCompletion: (paymentId, txid) =>
            callAPI("/complete", { paymentId, txid })
              .then(() => {
                localStorage.setItem("unlocked_chord_001","true");
                const btn = document.getElementById("pi-buy-btn");
                if (btn) btn.innerText = "âœ… ÄÃƒ Má» KHÃ“A (chord_001)";
                alert("ÄÃ£ má»Ÿ khÃ³a 1 tune!");
              }),
          onCancel: (paymentId) => console.log("User cancelled", paymentId),
          onError: (error, paymentId) => console.error("Payment error", error, paymentId),
        }
      );
    } catch (e) {
      console.error(e);
      alert("CÃ³ lá»—i khi thanh toÃ¡n. Xem console Ä‘á»ƒ debug.");
    }
  }
</script>

<!-- NÃºt mua Pi: thÃªm style nháº¹ Ä‘á»ƒ dá»… tháº¥y -->
<style>
  .pi-cta{
    display:inline-block;padding:12px 18px;border-radius:10px;
    font-weight:700;border:none;cursor:pointer;font-size:16px;
    box-shadow:0 6px 20px rgba(0,0,0,.1)
  }
</style>
<div style="margin:24px 0">
  <button id="pi-buy-btn" class="pi-cta" onclick="buyTune()">ğŸ¶ Mua gÃ³i 0.3 Pi Ä‘á»ƒ má»Ÿ 1 tune</button>
  <div style="opacity:.7;margin-top:8px;font-size:14px">
    Tip: test trong <b>Pi Browser</b> kÃ¨m <code>?onSandbox=1</code>.
  </div>
</div>

</html>
