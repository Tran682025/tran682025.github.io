<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiChordify Kingdom ‚Äî v0.51</title>

  <!-- Pi SDK (ch·ªâ ho·∫°t ƒë·ªông trong Pi Browser). C√≥ c≈©ng kh√¥ng sao, kh√¥ng c√≥ th√¨ code t·ª± ·∫©n n√∫t thanh to√°n -->
  <script src="https://sdk.minepi.com/pi-sdk.js" defer></script>

  <style>
    :root{
      --ink:#222; --bg:#fff; --muted:#737; --warm:#f0f3ff; --pi:#6b4ad0; --green:#11a36a; --red:#e34d4d;
      --card:#ffffff; --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--warm);color:var(--ink);font:500 16px/1.6 ui-sans-serif,system-ui,Segoe UI,Roboto}
    h1{font-size:clamp(28px,5vw,56px); line-height:1.05; margin:.25rem 0}
    small.badge{background:#f6f3ff;border:1px solid #e7e0ff;color:#6a4fd9;padding:.15rem .5rem;border-radius:999px}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .grid{display:grid;gap:18px;grid-template-columns:1.15fr .85fr}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    label{display:block;font:600 13px/1.2 ui-sans-serif;color:#111;margin:10px 0 6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;border:1px solid #d9dbe3;background:#fff;border-radius:12px;padding:12px 14px;font:500 15px/1.45 ui-sans-serif;
    }
    textarea{min-height:170px; font-family:ui-monospace,Consolas,Menlo,monospace}

    .btn{cursor:pointer;user-select:none; border:1px solid #d9dbe3; background:#fff; padding:11px 14px; border-radius:12px; 
         font:700 15px/1 ui-sans-serif}
    .btn:hover{background:#f7f7fb}
    .btn.primary{background:var(--pi); color:#fff; border-color:#5e3dd7}
    .btn.success{background:var(--green); color:#fff; border-color:#0e8f5d}
    .btn.danger{background:var(--red); color:#fff; border-color:#d13a3a}
    .btn.mini{padding:8px 10px;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .panel{background:#0b0b10;color:#cfd2e8;border-radius:14px;padding:14px;font:600 15px/1.6 ui-monospace,Consolas}
    .panel .muted{opacity:.75}
    footer{color:#7b7f98;text-align:center;padding:26px 10px}
    kbd{background:#f0f2ff;border:1px solid #e6e8ff;border-bottom-color:#d2d7ff;border-radius:8px;padding:.1rem .35rem;font:700 12px ui-monospace}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px dashed #e5e7ef;border-radius:999px;background:#fff}
    .sep{height:1px;background:#eceff6;margin:8px 0}

    .staff{width:100%;height:180px;background:#fff;border:1px solid #e4e6ee;border-radius:12px;display:flex;align-items:center;overflow:hidden}
    .staff svg{width:100%;height:100%}
    .mutetxt{color:#9aa0b5}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="align-items:flex-end;gap:16px">
      <div style="flex:1">
        <h1>PiChordify<br/>Kingdom <small class="badge">v0.51</small></h1>
      </div>
      <div class="row" style="flex:1;justify-content:flex-end">
        <button id="btnLogin" class="btn">Pi Login</button>
        <button id="btnCheck" class="btn">Ki·ªÉm tra Premium</button>
        <button id="btnPay" class="btn primary">Thanh to√°n Premium</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <h3 style="margin:6px 0 12px">Demo Core</h3>

        <div class="row" style="margin-top:12px">
  <label>Gi·ªçng (Key) & ti·∫øn tr√¨nh:</label>
  <div class="grid" style="grid-template-columns:1fr 1fr 1fr; gap:8px">
    <select id="selKey">
      <option>C</option><option>G</option><option>D</option><option>A</option><option>E</option>
      <option>F</option><option>Bb</option><option>Eb</option><option>Ab</option>
      <option>Am</option><option>Em</option><option>Dm</option><option>Gm</option>
    </select>
    <select id="selProg" title="Chord progression">
      <option value="I-V-vi-IV">I‚ÄìV‚Äìvi‚ÄìIV</option>
      <option value="I-vi-IV-V">I‚Äìvi‚ÄìIV‚ÄìV</option>
      <option value="ii-V-I-vi">ii‚ÄìV‚ÄìI‚Äìvi</option>
      <option value="I-IV-V-IV">I‚ÄìIV‚ÄìV‚ÄìIV</option>
    </select>
    <button id="btnAutoChord" type="button">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
  </div>
  <small>App s·∫Ω r·∫£i h·ª£p √¢m theo t·ª´ng √¥ nh·ªãp (4/4). Tr·∫´m c√≥ th·ªÉ ch·ªânh l·∫°i sau khi sinh.</small>
</div>

        <div class="row" style="margin-top:12px">
  <label>Gi·ªçng (Key) & ti·∫øn tr√¨nh:</label>
  <div class="grid" style="grid-template-columns:1fr 1fr 1fr; gap:8px">
    <select id="selKey">
      <option>C</option><option>G</option><option>D</option><option>A</option><option>E</option>
      <option>F</option><option>Bb</option><option>Eb</option><option>Ab</option>
      <option>Am</option><option>Em</option><option>Dm</option><option>Gm</option>
    </select>
    <select id="selProg" title="Chord progression">
      <option value="I-V-vi-IV">I‚ÄìV‚Äìvi‚ÄìIV</option>
      <option value="I-vi-IV-V">I‚Äìvi‚ÄìIV‚ÄìV</option>
      <option value="ii-V-I-vi">ii‚ÄìV‚ÄìI‚Äìvi</option>
      <option value="I-IV-V-IV">I‚ÄìIV‚ÄìV‚ÄìIV</option>
    </select>
    <button id="btnAutoChord">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
  </div>
  <small>App s·∫Ω r·∫£i h·ª£p √¢m theo t·ª´ng √¥ nh·ªãp (4/4). Tr·∫´m c√≥ th·ªÉ ch·ªânh l·∫°i sau khi sinh.</small>
</div>

        <div class="row" style="margin: 6px 0 12px">
          <button id="demo1" class="btn mini">T·∫£i demo 1</button>
          <button id="demo2" class="btn mini">T·∫£i demo 2</button>
          <button id="clearAll" class="btn danger mini">X√≥a</button>
        </div>

        <label for="title">Ti√™u ƒë·ªÅ</label>
        <input id="title" type="text" placeholder="T√™n b√†i..." />

        <label for="lyrics">L·ªùi + h·ª£p √¢m <span class="mutetxt">(m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî ƒë·ªãnh d·∫°ng: <b>mm:ss n·ªôi dung / h·ª£p √¢m</b>, v√≠ d·ª•: <i>00:12 Em / D</i>)</span></label>
        <textarea id="lyrics" placeholder="mm:ss  n·ªôi dung / h·ª£p √¢m..."></textarea>

        <div class="row">
          <div class="card" style="flex:1">
            <div class="row">
              <div style="flex:1">
                <label>BPM (nh·ªãp)</label>
                <input id="bpm" type="number" min="30" max="240" step="1" value="80" />
              </div>
              <div style="flex:1">
                <label>Offset (gi√¢y, +/-)</label>
                <input id="offset" type="number" step="0.1" value="0" />
              </div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <button id="btnMetronome" class="btn">Ph√°t nh·ªãp th·ª≠</button>
              <button id="btnCompile" class="btn">Bi√™n d·ªãch & xem tr∆∞·ªõc</button>
              <button id="btnExportSvg" class="btn">Export .svg</button>
            </div>

            <div class="sep"></div>

            <label>Audio (mp3)</label>
            <div class="row">
              <input id="audioUrl" type="text" placeholder="https://‚Ä¶/song.mp3" />
              <label for="fileMp3" class="btn" style="flex:0 0 auto;display:inline-flex;align-items:center;gap:8px">
                üéµ Ch·ªçn file MP3
              </label>
              <input id="fileMp3" type="file" accept="audio/mpeg" style="display:none" />
            </div>

            <div class="row" style="margin-top:10px">
              <button id="btnPlay"  class="btn">Play</button>
              <button id="btnPause" class="btn">Pause</button>
              <button id="btnStop"  class="btn">Stop</button>
            </div>

            <audio id="player" preload="none" style="width:100%;margin-top:8px;display:block"></audio>
            <div id="clock" style="text-align:right;opacity:.6">00:00</div>
          </div>

          <div class="card" style="flex:1;min-height:220px">
            <div class="staff" id="staffBox">
              <!-- SVG staff injected here -->
              <div class="mutetxt" style="margin:0 auto">S·∫µn s√†ng. Nh·∫•n ‚ÄúBi√™n d·ªãch & xem tr∆∞·ªõc‚Äù.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT (LOG PANEL) -->
      <aside class="card">
        <div class="panel" id="logs">
          <div>üñ§ <b>Ready.</b></div>
          <div class="muted" id="sdkLine">ƒêang ki·ªÉm tra Pi SDK‚Ä¶</div>
        </div>
      </aside>
    </div>

    <footer>¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù v0.51</footer>
  </div>

  <script>
    /** ---------- UTILS & STATE ---------- */
    const $ = sel => document.querySelector(sel);
    const logBox = $("#logs");
    const log = (...args)=>{ const d=document.createElement("div"); d.textContent = "¬∑ " + args.join(" "); logBox.appendChild(d); logBox.scrollTop = logBox.scrollHeight; };
    const setMuted = (el,txt)=>{ el.innerHTML = '<span class="muted">'+txt+'</span>'; };

    const state = {
      pi: undefined,
      premium: false,
      loginUser: null,
      demoLoaded: 0
    };

    // Safe Pi SDK check
    function hasPiSDK(){
      return typeof window.Pi !== "undefined" && window.Pi && typeof window.Pi.init === "function";
    }

    async function initPi(){
      if(!hasPiSDK()){
        setMuted($("#sdkLine"), "Kh√¥ng c√≥ Pi SDK. M·ªü trong Pi Browser ƒë·ªÉ test thanh to√°n.");
        $("#btnPay").style.display="none";
        return;
      }
      state.pi = window.Pi;
      $("#btnPay").style.display="";
      setMuted($("#sdkLine"), "Pi SDK ƒë√£ s·∫µn s√†ng.");
      try{
        state.pi.init({ version: "2.6", sandbox: true });
        log("Pi SDK init xong.");
      }catch(err){ log("Pi SDK init l·ªói:", err.message); }
    }

    // ====== AUTO CHORD SUGGESTION ======
const MAJOR_KEYS = {
  C: ["C","Dm","Em","F","G","Am","Bdim"],
  G: ["G","Am","Bm","C","D","Em","F#dim"],
  D: ["D","Em","F#m","G","A","Bm","C#dim"],
  A: ["A","Bm","C#m","D","E","F#m","G#dim"],
  E: ["E","F#m","G#m","A","B","C#m","D#dim"],
  F: ["F","Gm","Am","Bb","C","Dm","Edim"],
  Bb:["Bb","Cm","Dm","Eb","F","Gm","Adim"],
  Eb:["Eb","Fm","Gm","Ab","Bb","Cm","Ddim"],
  Ab:["Ab","Bbm","Cm","Db","Eb","Fm","Gdim"],
};
const MINOR_REL = { Am:"C", Em:"G", Dm:"F", Gm:"Bb" }; // x·ª≠ l√Ω nhanh natural minor

function romanToChord(key, token){
  // token: I, ii, V, vi ...
  const isMinorKey = !!MINOR_REL[key];
  const useKey = isMinorKey ? MINOR_REL[key] : key;
  const scale = MAJOR_KEYS[useKey] || MAJOR_KEYS.C;
  const map = { "I":0,"ii":1,"II":1,"iii":2,"III":2,"IV":3,"iv":3,"V":4,"v":4,"vi":5,"VI":5,"vii":6,"VII":6 };
  const idx = map[token] ?? 0;
  let chord = scale[idx];

  // √©p v·ªÅ m√†u theo ch·ªØ hoa/th∆∞·ªùng c·ªßa token
  const wantMinor = /ii|iii|iv|v|vi|vii/.test(token);
  if(wantMinor && !/m|dim/.test(chord)) chord += "m";
  if(!wantMinor && /m/.test(chord) && !/dim/.test(chord)) chord = chord.replace("m","");
  return chord;
}

function parseProg(str){
  return str.split("-").map(s=>s.trim());
}

function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

async function autoSuggestChords(){
  // l·∫•y tham s·ªë
  const key = document.getElementById("selKey").value;
  const prog = parseProg(document.getElementById("selProg").value); // v√≠ d·ª• ["I","V","vi","IV"]
  const bpm = Number(document.getElementById("bpm").value || 80);   // id="bpm" l√† √¥ BPM hi·ªán c√≥
  const offset = Number(document.getElementById("offset").value || 0);

  // ƒë·ªô d√†i b√†i t·ª´ audio#player
  const audio = document.querySelector("audio#player") || document.querySelector("audio");
  const duration = (audio && isFinite(audio.duration)) ? audio.duration : 180; // fallback 3 ph√∫t

  // m·ªói √¥ nh·ªãp (4/4)
  const barLen = 60 / bpm * 4; // gi√¢y
  const lines = [];
  let t = 0, i = 0;

  while(t < duration){
    const tok = prog[i % prog.length];
    const chord = romanToChord(key, tok);
    lines.push(`${fmtTime(t + offset)}  ‚Ä¶ / ${chord}`);
    t += barLen;
    i++;
  }

  // gh√©p v√†o khung l·ªùi (id hi·ªán c√≥ l√† "lyrics" theo b·∫£n c·ªßa Tr·∫´m)
  const box = document.getElementById("lyrics");
  const prev = (box.value || "").trim();
  box.value = (prev ? prev + "\n" : "") + lines.join("\n");

  // log & cho xem nhanh
  const log = (msg)=>{ const el = document.getElementById("console"); if(el) el.textContent += `\n‚Ä¢ ${msg}`; };
  log(`ƒê√£ g·ª£i √Ω ${lines.length} √¥ nh·ªãp theo ${key} ‚Äì ${prog.join("-")}.`);

  // g·ªçi l·∫°i compile preview n·∫øu c√≥
  if(typeof compilePreview === "function") compilePreview();
}

// g·∫Øn handler n√∫t
document.addEventListener("click", (e)=>{
  if(e.target && e.target.id === "btnAutoChord"){
    e.preventDefault();
    autoSuggestChords();
  }
});

    /** ---------- AUDIO ---------- */
    const player = $("#player");
    const audioUrl = $("#audioUrl");
    let ctx, tickOsc, tickGain, metroTimer = null;

    function ensureAudioCtx(){
      if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
      return ctx;
    }
    function formatClock(sec){
      sec = Math.max(0, sec|0);
      const m = String((sec/60)|0).padStart(2,"0");
      const s = String(sec%60).padStart(2,"0");
      return `${m}:${s}`;
    }
    setInterval(()=>{ if(!isNaN(player.currentTime)) $("#clock").textContent = formatClock(player.currentTime); }, 250);

    function useFile(file){
      const url = URL.createObjectURL(file);
      player.src = url;
      audioUrl.value = "";
      log("ƒê√£ n·∫°p file mp3:", file.name);
    }
    function useUrl(url){
      player.src = url;
      log("ƒê√£ n·∫°p mp3 t·ª´ URL.");
    }

    /** ---------- METRONOME ---------- */
    function startMetronome(){
      try{
        const bpm = Number($("#bpm").value) || 80;
        const interval = 60 / bpm; // gi√¢y / beat
        const c = ensureAudioCtx();
        stopMetronome();

        tickGain = c.createGain();
        tickGain.gain.value = 0.2;
        tickGain.connect(c.destination);

        function playTick(){
          tickOsc = c.createOscillator();
          tickOsc.type = "square";
          tickOsc.frequency.value = 880;
          tickOsc.connect(tickGain);
          tickGain.gain.setValueAtTime(0.25, c.currentTime);
          tickGain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.08);
          tickOsc.start();
          tickOsc.stop(c.currentTime + 0.09);
        }
        playTick();
        metroTimer = setInterval(playTick, interval*1000);
        log(`B·∫≠t metronome ${bpm} BPM`);
      }catch(e){ log("Metronome l·ªói:", e.message); }
    }
    function stopMetronome(){
      if(metroTimer) { clearInterval(metroTimer); metroTimer=null; }
      try{ tickOsc && tickOsc.stop(); }catch(_){}
    }

    /** ---------- PARSER & PREVIEW ---------- */
    // Input format per line: "mm:ss  text / Chord"
    function parseLines(txt){
      const out=[];
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      for(const line of lines){
        const m = line.match(/^(\d{1,2}):(\d{2})\s+(.+?)(?:\s*\/\s*([A-G][#b]?m?(?:7|maj7|sus4|dim)?))?$/i);
        if(!m) continue;
        const sec = Number(m[1])*60 + Number(m[2]);
        out.push({ t: sec, text: m[3], chord: m[4]||"" });
      }
      return out;
    }

    function drawStaffPreview(items){
      const box = $("#staffBox");
      box.innerHTML = "";
      const w = box.clientWidth || 600, h = box.clientHeight || 180, pad=16;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);

      // staff lines
      for(let i=0;i<5;i++){
        const y = pad + i*16 + 36;
        const ln = document.createElementNS(svgNS, "line");
        ln.setAttribute("x1", pad);
        ln.setAttribute("x2", w-pad);
        ln.setAttribute("y1", y);
        ln.setAttribute("y2", y);
        ln.setAttribute("stroke", "#cfd4e6");
        ln.setAttribute("stroke-width","1");
        svg.appendChild(ln);
      }

      // timeline scale based on items range (fallback 120s)
      const minT = items.length? Math.min(...items.map(i=>i.t)) : 0;
      const maxT = items.length? Math.max(...items.map(i=>i.t)) : 120;
      const span = Math.max(30, maxT-minT);

      for(const it of items){
        const x = pad + ((it.t - minT) / span) * (w-2*pad);
        // chord flag
        if(it.chord){
          const t = document.createElementNS(svgNS,"text");
          t.setAttribute("x", x);
          t.setAttribute("y", 26);
          t.setAttribute("text-anchor","middle");
          t.setAttribute("font-weight","700");
          t.setAttribute("font-size","14");
          t.setAttribute("fill","#1f2a44");
          t.textContent = it.chord;
          svg.appendChild(t);
        }
        // tick
        const tick = document.createElementNS(svgNS,"line");
        tick.setAttribute("x1", x);
        tick.setAttribute("x2", x);
        tick.setAttribute("y1", 44);
        tick.setAttribute("y2", h-22);
        tick.setAttribute("stroke","#e5e7f2");
        tick.setAttribute("stroke-dasharray","2 6");
        svg.appendChild(tick);

        // lyric near bottom
        const ly = document.createElementNS(svgNS,"text");
        ly.setAttribute("x", x+4);
        ly.setAttribute("y", h-14);
        ly.setAttribute("font-size","12");
        ly.setAttribute("fill","#4b556b");
        ly.textContent = it.text.slice(0,48);
        svg.appendChild(ly);
      }

      box.appendChild(svg);
    }

    function compilePreview(){
      const raw = $("#lyrics").value;
      const offs = Number($("#offset").value || 0);
      const items = parseLines(raw).map(i=>({ ...i, t: i.t + offs }));
      drawStaffPreview(items);
      log(`Compile xong: ${items.length} d√≤ng.`);
      return items;
    }

    function exportSVG(){
      const box = $("#staffBox");
      const svg = box.querySelector("svg");
      if(!svg){ log("Ch∆∞a c√≥ preview ƒë·ªÉ export."); return; }
      const title = ($("#title").value || "PiChordify Sheet").trim();
      const s = new XMLSerializer().serializeToString(svg);
      const blob = new Blob([s], {type:"image/svg+xml"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${title.replace(/\s+/g,"_")}.svg`;
      a.click();
      log("ƒê√£ export SVG.");
    }

    /** ---------- PI PAYMENT (DEMO) ---------- */
    async function piLogin(){
      if(!state.pi){ log("SDK Pi kh√¥ng s·∫µn s√†ng."); return; }
      try{
        const scopes = ['username','payments'];
        const res = await state.pi.authenticate(scopes, onIncomplete);
        state.loginUser = res && res.user ? res.user : null;
        log("ƒêƒÉng nh·∫≠p:", state.loginUser ? state.loginUser.username : "(kh√¥ng r√µ)");
      }catch(e){ log("Login l·ªói:", e.message); }
    }
    function onIncomplete(i){ log("Incomplete:", i?.identifier || "(?)"); }

    async function checkPremium(){
      // b·∫£n demo (ch∆∞a backend) lu√¥n false
      state.premium = false;
      log("checkPremium: (demo) ch∆∞a c√≥ backend ‚Üí false");
      return false;
    }

    async function payPremium(){
      if(!state.pi){ log("SDK Pi kh√¥ng s·∫µn s√†ng."); return; }
      try{
        const payment = await state.pi.createPayment({
          amount: 1,
          memo: "PiChordify Premium (demo)",
          metadata: { plan: "premium_v1" }
        }, {
          onReadyForServerApproval: async (paymentId)=>{
            log("onReadyForServerApproval:", paymentId);
            // Demo: b·ªè qua server approval ‚Äî ch·ªâ log
          },
          onReadyForServerCompletion: async (paymentId, txid)=>{
            log("onReadyForServerCompletion:", paymentId, txid||"");
          },
          onCancel: (pid)=> log("‚ùå H·ªßy thanh to√°n:", pid),
          onError:  (err)=> log("‚ö†Ô∏è L·ªói thanh to√°n:", err?.message || err)
        });
        log("Payment created (demo).");
      }catch(e){ log("T·∫°o payment l·ªói:", e.message); }
    }

    /** ---------- DEMO LOADERS ---------- */
    function loadDemo(id){
      const data = [
`00:10 V√†o ƒëi·ªáp kh√∫c / G
00:20 Tr√°i tim anh / Em
00:30 Kh√∫c ca x∆∞a / C
00:40 Ta c√πng h√°t / D`,
`00:05 Intro th·∫≠t nh·∫π / Am
00:12 D√≤ng s√¥ng tr√¥i / F
00:24 N·∫Øng v·ª´a ch√≠n / C
00:38 Em g·ªçi t√™n / G`
      ];
      $("#title").value = id===1 ? "Demo 1" : "Demo 2";
      $("#lyrics").value = data[id-1];
      compilePreview();
      log(`T·∫£i demo ${id} xong.`);
    }
    function clearAll(){
      $("#title").value = "";
      $("#lyrics").value = "";
      $("#audioUrl").value = "";
      player.removeAttribute("src");
      player.load();
      $("#staffBox").innerHTML = '<div class="mutetxt" style="margin:0 auto">ƒê√£ x√≥a. Nh·∫≠p l·ªùi/h·ª£p √¢m r·ªìi ‚ÄúBi√™n d·ªãch & xem tr∆∞·ªõc‚Äù.</div>';
      log("ƒê√£ x√≥a n·ªôi dung.");
    }

    /** ---------- WIRING ---------- */
    window.addEventListener("DOMContentLoaded", ()=>{
      // Pi
      initPi();
      // Actions
      $("#btnMetronome").addEventListener("click", startMetronome);
      $("#btnCompile").addEventListener("click", compilePreview);
      $("#btnExportSvg").addEventListener("click", exportSVG);

      $("#btnPlay").addEventListener("click", ()=>{ 
        if(audioUrl.value.trim()) useUrl(audioUrl.value.trim());
        player.play().catch(e=>log("Play l·ªói:", e.message));
      });
      $("#btnPause").addEventListener("click", ()=> player.pause());
      $("#btnStop").addEventListener("click", ()=>{ player.pause(); player.currentTime=0; });

      $("#fileMp3").addEventListener("change", e=>{
        const f = e.target.files?.[0]; if(f) useFile(f);
      });

      $("#btnLogin").addEventListener("click", piLogin);
      $("#btnCheck").addEventListener("click", checkPremium);
      $("#btnPay").addEventListener("click", payPremium);

      $("#demo1").addEventListener("click", ()=>loadDemo(1));
      $("#demo2").addEventListener("click", ()=>loadDemo(2));
      $("#clearAll").addEventListener("click", clearAll);

      // live guards
      $("#bpm").addEventListener("change", ()=> log("BPM =", Number($("#bpm").value)||80));
      $("#offset").addEventListener("change", ()=> log("Offset (s) =", Number($("#offset").value)||0));

      log("DOM loaded. JS ƒëang ch·∫°y.");
    });

    // stop audio when leaving
    window.addEventListener("beforeunload", ()=>{ stopMetronome(); try{ player.pause(); }catch(_){ } });
  </script>
</body>
</html>
