<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PiChordify Kingdom ‚Äî v0.51</title>

<!-- Pi SDK: ch·ªâ ho·∫°t ƒë·ªông trong Pi Browser -->
<script src="https://sdk.minepi.com/pi-sdk/v2.7.0/pi-sdk.min.js" defer></script>

<style>
:root{
  --ink:#222; --muted:#667; --pi:#6f3cff; --bg:#f7f7fb; --ok:#12a150; --warn:#ffb020;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
main{max-width:1100px;margin:28px auto;padding:0 16px}
h1{font-size:42px;line-height:1.05;margin:0 0 6px}
.badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:10px;background:#fff;border:1px solid #eee;box-shadow:0 1px 0 rgba(0,0,0,.04)}
.pi{background:rgba(111,60,255,.09);border:1px solid rgba(111,60,255,.25);color:#3c278f}

.grid{display:grid;grid-template-columns: 340px 1fr;gap:18px;margin-top:18px}
.card{background:#fff;border:1px solid #ececf5;border-radius:14px;padding:14px 14px 16px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
label{display:block;margin:10px 0 6px;font-weight:600;color:#444}
input[type="text"], input[type="number"], textarea, select{
  width:100%;padding:10px 12px;border:1px solid #d8d8e8;border-radius:10px;background:#fff;font:inherit
}
textarea{min-height:140px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{cursor:pointer;user-select:none;display:inline-block;border-radius:12px;border:1px solid #dcdcf0;padding:10px 14px;background:#fff}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--pi);border-color:var(--pi);color:#fff;font-weight:700}
.btn.ghost{background:transparent}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 6px}
footer{margin-top:22px;color:#777;text-align:center}

.log{background:#0f0f14;color:#eee;border-radius:12px;padding:12px 14px;font-family:ui-monospace,Consolas,Menlo,monospace}
.log b{color:#c5b3ff}
.ok{color:#75e19b} .warn{color:#ffd47a} .muted{color:#9aa0b5}

.khuong-wrap{background:#fff;border:1px dashed #e0e0f0;border-radius:12px;padding:10px}
canvas#staff{width:100%;height:220px;display:block}
.svg-chords{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
svg{background:#fff}
.small{font-size:12px;color:#666}

.audio-ui{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
audio{width:100%}
.file-row{display:flex;gap:8px;align-items:center}
.badge.ver{background:#f3f3ff;border-color:#e5e4ff;color:#5b47c4;margin-left:8px}
</style>
</head>
<body>
<main>
  <h1>PiChordify <span class="muted">Kingdom</span> <span class="badge ver">v0.51</span></h1>

  <div class="toolbar">
    <button id="btnLogin" class="btn">Pi Login</button>
    <button id="btnCheck" class="btn">Ki·ªÉm tra Premium</button>
    <button id="btnPay" class="btn primary">Thanh to√°n Premium</button>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="row">
        <button id="btnLoad1" class="btn">T·∫£i demo 1</button>
        <button id="btnLoad2" class="btn">T·∫£i demo 2</button>
      </div>

      <label for="title">Ti√™u ƒë·ªÅ</label>
      <input id="title" type="text" placeholder="T√™n b√†i..." />

      <label for="lyrics">L·ªùi + h·ª£p √¢m <span class="small">(m·ªói d√≤ng c√≥ m·ªëc mm:ss, vd: <b>00:12 Em / D</b>)</span></label>
      <textarea id="lyrics" placeholder="mm:ss   n·ªôi dung / h·ª£p √¢m..."></textarea>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="bpm">BPM (nh·ªãp)</label>
          <input id="bpm" type="number" min="40" max="220" value="80" />
        </div>
        <div>
          <label for="offset">Offset (gi√¢y, +/-)</label>
          <input id="offset" type="number" step="0.01" value="0" />
        </div>
      </div>

      <label>Nh·∫°c c·ª• &amp; khu√¥ng nh·∫°c</label>
      <div class="row">
        <select id="instrument">
          <option value="guitar">Guitar</option>
          <option value="piano">Piano</option>
          <option value="ukulele">Ukulele</option>
        </select>
        <div class="toolbar">
          <button id="btnMetronome" class="btn">Ph√°t nh·ªãp th·ª≠</button>
          <button id="btnCompile" class="btn">Bi√™n d·ªãch &amp; xem tr∆∞·ªõc</button>
          <button id="btnExport" class="btn">Export .svg</button>
        </div>
      </div>

      <label for="url">URL audio (mp3)</label>
      <div class="file-row">
        <input id="url" type="text" placeholder="https://.../song.mp3" />
        <button id="btnPick" class="btn">üéµ Ch·ªçn file MP3</button>
        <input id="file" type="file" accept="audio/mpeg" hidden />
      </div>

      <div class="audio-ui">
        <audio id="player" preload="none" controls></audio>
        <div class="toolbar">
          <button id="btnPlay" class="btn">Play</button>
          <button id="btnPause" class="btn">Pause</button>
          <button id="btnStop" class="btn">Stop</button>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="khuong-wrap">
        <canvas id="staff" width="1024" height="220" title="Khu√¥ng nh·∫°c"></canvas>
        <div id="svgChords" class="svg-chords"></div>
      </div>
      <div id="preview" class="card" style="margin-top:12px;padding:12px">
        <b>Xem tr∆∞·ªõc</b>
        <div id="sheet" style="white-space:pre-wrap;margin-top:8px"></div>
      </div>
      <div class="log" id="log" style="margin-top:12px"></div>
    </section>
  </div>

  <footer>¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù v0.51</footer>
</main>

<script>
/* ====== C·∫§U H√åNH BACKEND (n·∫øu d√πng Pi Payments) ====== */
const BACKEND_BASE = ""; // v√≠ d·ª•: "https://pichordify-backend.onrender.com"

/* ====== TI·ªÜN √çCH ====== */
const $ = sel => document.querySelector(sel);
function log(...args){
  const el = $("#log");
  const line = args.map(x=> (typeof x==="object"? JSON.stringify(x): String(x))).join(" ");
  el.innerHTML = "üñ§ <b>Ready.</b><br>" + (window.Pi ? 
    "‚úÖ <span class='ok'>C√≥ Pi SDK.</span><br>":"‚ÑπÔ∏è <span class='muted'>Kh√¥ng c√≥ Pi SDK. M·ªü trong Pi Browser ƒë·ªÉ test thanh to√°n.</span><br>")
    + (el.dataset.tail || "");
  el.dataset.tail = (el.dataset.tail||"") + `<span class="muted">¬∑</span> ${line}<br>`;
}
function seconds(mmss){ // "mm:ss" -> seconds
  const m = /^(\d+):(\d{2})(?:\.(\d+))?$/.exec(mmss.trim());
  if(!m) return 0;
  const ms = m[3] ? Number("0."+m[3]) : 0;
  return Number(m[1])*60 + Number(m[2]) + ms;
}

/* ====== PI SDK ====== */
let piUser=null, piPayment=null;
async function piInit(){
  try{
    if(!window.Pi) { log("Kh√¥ng ·ªü Pi Browser ‚Üí ·∫©n thanh to√°n."); return; }
    Pi.init({version:"2.7", sandbox:true});
    log("Pi SDK init xong.");
  }catch(e){ log("L·ªói Pi.init:", e.message); }
}
async function piLogin(){
  if(!window.Pi) return;
  try{
    const scopes=['username','payments'];
    piUser = await Pi.authenticate(scopes, onIncompletePaymentFound);
    log("ƒêƒÉng nh·∫≠p:", piUser && piUser.user && piUser.user.username);
  }catch(e){ log("Login l·ªói:", e.message); }
}
async function onIncompletePaymentFound(p){
  log("C√≥ payment treo:", p && p.identifier);
}
async function checkPremium(){
  // demo: lu√¥n false n·∫øu kh√¥ng c√≥ BACKEND
  if(!BACKEND_BASE){ log("checkPremium: (demo) ch∆∞a c√≥ backend ‚Üí false"); return false; }
  try{
    const id = (piUser && piUser.user && piUser.user.username) || "guest";
    const r = await fetch(`${BACKEND_BASE}/check?id=${encodeURIComponent(id)}`);
    const j = await r.json();
    log("Premium?", j && j.premium);
    return !!(j && j.premium);
  }catch(e){ log("L·ªói check:", e.message); return false; }
}
async function payPremium(){
  if(!window.Pi){ log("Kh√¥ng c√≥ Pi SDK."); return; }
  try{
    const amount = 1; // 1 PI demo
    const memo = "PiChordify Premium";
    const paymentData = { amount, memo, metadata:{tier:"premium"} };
    piPayment = await Pi.createPayment(paymentData, {
      onReadyForServerApproval: async (paymentId)=>{
        if(!BACKEND_BASE){ log("Demo: thi·∫øu BACKEND ƒë·ªÉ approve."); return; }
        await fetch(`${BACKEND_BASE}/approve`, {method:"POST",headers:{'Content-Type':'application/json'}, body:JSON.stringify({paymentId})});
        log("Server approve xong:", paymentId);
      },
      onReadyForServerCompletion: async (paymentId)=>{
        if(!BACKEND_BASE){ log("Demo: thi·∫øu BACKEND ƒë·ªÉ complete."); return; }
        await fetch(`${BACKEND_BASE}/complete`, {method:"POST",headers:{'Content-Type':'application/json'}, body:JSON.stringify({paymentId})});
        log("Server complete xong:", paymentId);
      },
      onCancel: (p)=> log("User h·ªßy giao d·ªãch."),
      onError: (e)=> log("Payment l·ªói:", e.message),
    });
  }catch(e){ log("Pay l·ªói:", e.message); }
}

/* ====== AUDIO + METRONOME ====== */
const player = $("#player");
function loadAudioUrl(u){
  if(!u) return;
  player.src = u; player.load();
  log("ƒê√£ n·∫°p audio URL.");
}
function loadAudioFile(f){
  const url = URL.createObjectURL(f);
  $("#url").value = "";
  loadAudioUrl(url);
}
$("#btnPick").onclick = ()=> $("#file").click();
$("#file").onchange = (e)=>{ const f=e.target.files?.[0]; if(f) loadAudioFile(f); };
$("#url").addEventListener("change", e=> loadAudioUrl(e.target.value.trim()));
$("#btnPlay").onclick = ()=> player.play();
$("#btnPause").onclick = ()=> player.pause();
$("#btnStop").onclick = ()=> { player.pause(); player.currentTime = 0; };

let metro=null;
$("#btnMetronome").onclick = ()=>{
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const bpm = Number($("#bpm").value||80);
    const interval = 60/bpm;
    let n=0;
    if(metro){ clearInterval(metro); metro=null; log("T·∫Øt nh·ªãp."); return; }
    metro = setInterval(()=>{
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.frequency.value = (n%4===0)? 1200: 900;
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.08);
      osc.connect(g).connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime+0.09);
      n++;
    }, interval*1000);
    log("B·∫≠t metronome", bpm, "BPM");
  }catch(e){ log("Metronome l·ªói:", e.message); }
};

/* ====== PARSER L·ªúI & H·ª¢P √ÇM ====== */
function parseLines(txt){
  // m·ªói d√≤ng: "mm:ss n·ªôi_dung / h·ª£p_√¢m"
  return txt.split(/\r?\n/).map(x=>x.trim()).filter(Boolean).map(line=>{
    const m = /^(\d+:\d{2}(?:\.\d+)?)\s+(.+?)(?:\s*\/\s*([A-G][#b]?(?:m|maj7|m7|7)?))?$/.exec(line);
    if(!m) return null;
    return {t: seconds(m[1]), lyric: m[2], chord: m[3]||""};
  }).filter(Boolean);
}

/* ====== KHU√îNG NH·∫†C (Canvas) + CHORD SVG ====== */
const staff = $("#staff"), ctx = staff.getContext("2d");
function drawStaff(measures){
  // n·ªÅn
  ctx.clearRect(0,0,staff.width,staff.height);
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,staff.width,staff.height);
  // 5 d√≤ng khu√¥ng
  const top = 40, gap=12, left=40, right=20;
  ctx.strokeStyle="#666"; ctx.lineWidth=1;
  for(let i=0;i<5;i++){
    const y = top + i*gap;
    ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(staff.width-right,y); ctx.stroke();
  }
  // √¥ nh·ªãp
  const w = (staff.width-left-right)/measures;
  ctx.strokeStyle="#bbb";
  for(let i=0;i<=measures;i++){
    const x = left + i*w;
    ctx.beginPath(); ctx.moveTo(x, top-6); ctx.lineTo(x, top+gap*4+6); ctx.stroke();
  }
  return {left,top,gap,w};
}

const CHORD_DICT = {
  // voicing ƒë∆°n gi·∫£n cho Guitar (fret, string 6‚Üí1; -1 = mute, 0 = open)
  guitar:{
    C:  [-1,3,2,0,1,0],
    G:  [3,2,0,0,0,3],
    Am: [-1,0,2,2,1,0],
    F:  [1,3,3,2,1,1],
    D:  [-1,-1,0,2,3,2],
    Dm: [-1,-1,0,2,3,1],
    Em: [0,2,2,0,0,0],
    E:  [0,2,2,1,0,0],
    A:  [-1,0,2,2,2,0],
    Bm: [-1,2,4,4,3,2]
  },
  // Ukulele (string 4‚Üí1; 0=open)
  ukulele:{
    C:  [0,0,0,3],  G:[0,2,3,2], Am:[2,0,0,0], F:[2,0,1,0], D:[2,2,2,0], Dm:[2,2,1,0], Em:[0,4,3,2], E:[1,4,0,2], A:[2,1,0,0], Bm:[4,2,2,2]
  },
  // Piano: n·ªët MIDI c∆° b·∫£n (root triad; r·∫•t g·ªçn ƒë·ªÉ t√¥ ph√≠m)
  piano:{
    C:[60,64,67], G:[55,59,62], Am:[57,60,64], F:[53,57,60], D:[50,54,57], Dm:[50,53,57], Em:[52,55,59], E:[52,56,59], A:[57,61,64], Bm:[59,62,66]
  }
};
function chordSvgGuitar(shape, title){
  // v·∫Ω √¥ ph√≠m 4 ngƒÉn (fret 1‚Äì4)‚Ä¶ ƒë∆°n gi·∫£n
  const cell=16, strings=6, frets=4, w=cell*(strings-1)+20, h=cell*frets+26;
  const s = [`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">`];
  s.push(`<text x="${w/2}" y="12" text-anchor="middle" font-size="12">${title}</text>`);
  // d√¢y d·ªçc
  for(let i=0;i<strings;i++){
    const x = 10 + i*cell;
    s.push(`<line x1="${x}" y1="18" x2="${x}" y2="${18+cell*frets}" stroke="#333" stroke-width="1"/>`);
  }
  // ngƒÉn ngang
  for(let f=0; f<=frets; f++){
    const y = 18 + f*cell;
    s.push(`<line x1="10" y1="${y}" x2="${10+cell*(strings-1)}" y2="${y}" stroke="#333" stroke-width="${f===0?2:1}"/>`);
  }
  // ch·∫•m n·ªët
  for(let i=0;i<strings;i++){
    const v = shape[i];
    const x = 10 + i*cell;
    if(v===-1){ s.push(`<text x="${x}" y="14" font-size="10">√ó</text>`); }
    else if(v===0){ s.push(`<circle cx="${x}" cy="12" r="3" fill="#000"/>`); }
    else{
      const y = 18 + v*cell - cell/2;
      s.push(`<circle cx="${x}" cy="${y}" r="5" fill="#6f3cff"/>`);
    }
  }
  s.push("</svg>");
  return s.join("");
}
function chordSvgUkulele(shape, title){
  const cell=16, strings=4, frets=4, w=cell*(strings-1)+20, h=cell*frets+26;
  const s = [`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">`];
  s.push(`<text x="${w/2}" y="12" text-anchor="middle" font-size="12">${title}</text>`);
  for(let i=0;i<strings;i++){
    const x=10+i*cell;
    s.push(`<line x1="${x}" y1="18" x2="${x}" y2="${18+cell*frets}" stroke="#333"/>`);
  }
  for(let f=0;f<=frets;f++){
    const y=18+f*cell;
    s.push(`<line x1="10" y1="${y}" x2="${10+cell*(strings-1)}" y2="${y}" stroke="#333" stroke-width="${f===0?2:1}"/>`);
  }
  for(let i=0;i<strings;i++){
    const v=shape[i], x=10+i*cell;
    if(v===0){ s.push(`<circle cx="${x}" cy="12" r="3" fill="#000"/>`); }
    else{ const y=18+v*cell - cell/2; s.push(`<circle cx="${x}" cy="${y}" r="5" fill="#6f3cff"/>`); }
  }
  s.push("</svg>"); return s.join("");
}
function chordSvgPiano(notes, title){
  // b√†n ph√≠m 14 ph√≠m tr·∫Øng (C‚ÄìB x1+), t√¥ 3 n·ªët
  const white=14, w=14*12+20, h=70, blackW=8, blackH=40;
  const base=60; // C4
  const s=[`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">`];
  s.push(`<text x="${w/2}" y="12" text-anchor="middle" font-size="12">${title}</text>`);
  // tr·∫Øng
  for(let i=0;i<white;i++){
    const x=10+i*12; s.push(`<rect x="${x}" y="18" width="12" height="${h-24}" fill="#fff" stroke="#333"/>`);
  }
  // map MIDI ‚Üí x pos
  const whiteOrder=[0,2,4,5,7,9,11,12,14,16,17,19,21,23]; // offsets
  function xOf(n){
    const d=n-base; // rough map
    // try to place near
    return 10 + (d+0.5)*6; // coarse; enough for highlight
  }
  // ƒëen (t∆∞·ª£ng tr∆∞ng)
  for(let i=0;i<white;i++){
    const x=10+i*12;
    if([0,1,3,4,5,7,8,10,11].includes(i)){
      s.push(`<rect x="${x+8}" y="18" width="${blackW}" height="${blackH}" fill="#111"/>`);
    }
  }
  // highlight n·ªët
  notes.forEach(n=>{
    const x = xOf(n);
    s.push(`<rect x="${x-5}" y="${h-24-18}" width="10" height="16" fill="#6f3cff" opacity=".9"/>`);
  });
  s.push("</svg>"); return s.join("");
}

function renderChords(instrument, chords){
  const box=$("#svgChords"); box.innerHTML="";
  chords.slice(0,12).forEach(ch=>{
    let svg="";
    if(instrument==="guitar" && CHORD_DICT.guitar[ch]){
      svg = chordSvgGuitar(CHORD_DICT.guitar[ch], ch);
    }else if(instrument==="ukulele" && CHORD_DICT.ukulele[ch]){
      svg = chordSvgUkulele(CHORD_DICT.ukulele[ch], ch);
    }else if(instrument==="piano" && CHORD_DICT.piano[ch]){
      svg = chordSvgPiano(CHORD_DICT.piano[ch], ch);
    }else{
      svg = `<div class="badge">${ch}</div>`;
    }
    const wrap = document.createElement("div");
    wrap.innerHTML = svg;
    box.appendChild(wrap.firstChild);
  });
}

/* ====== COMPILE (v·∫Ω khu√¥ng + preview) ====== */
function compilePreview(){
  const items = parseLines($("#lyrics").value);
  const measures = Math.max(4, Math.ceil(items.length/2));
  const g = drawStaff(measures);
  // ghi h·ª£p √¢m tr√™n √¥ nh·ªãp
  ctx.fillStyle="#222"; ctx.font="bold 14px ui-monospace,Consolas";
  items.forEach((it,i)=>{
    const m = Math.min(measures-1, Math.floor(i/2));
    const x = g.left + m*g.w + 8 + (i%2? g.w/2 : 0);
    const y = g.top - 10;
    if(it.chord) ctx.fillText(it.chord, x, y);
  });
  // sheet preview
  const s = items.map(it => `${String(it.t).padStart(5," ")}  | ${it.lyric}${it.chord? "  / "+it.chord:""}`).join("\n");
  $("#sheet").textContent = s || "‚Äî";
  const uniqChords=[...new Set(items.map(i=>i.chord).filter(Boolean))];
  renderChords($("#instrument").value, uniqChords);
  log("Compile xong:", items.length, "d√≤ng.");
}
$("#btnCompile").onclick = compilePreview;

/* ====== EXPORT SVG (chord shapes) ====== */
function exportSVG(){
  const svgWrap = $("#svgChords");
  if(!svgWrap.firstChild){ log("Ch∆∞a c√≥ SVG ƒë·ªÉ export."); return; }
  // g·ªôp t·∫•t c·∫£ SVG v√†o m·ªôt file
  const svgs = Array.from(svgWrap.querySelectorAll("svg")).map(x=>x.outerHTML).join("\n");
  const blob = new Blob([`<svg xmlns="http://www.w3.org/2000/svg"><foreignObject>${svgs}</foreignObject></svg>`], {type:"image/svg+xml"});
  const a=document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = ( ($("#title").value.trim()||"PiChordify") + "_chords.svg");
  a.click();
  log("ƒê√£ xu·∫•t SVG h·ª£p √¢m.");
}
$("#btnExport").onclick = exportSVG;

/* ====== DEMO DATA ====== */
function loadDemo(which=1){
  $("#title").value = which===1 ? "ƒê·∫øm Ng∆∞·ª£c" : "C·∫ßu Nguy·ªán";
  $("#lyrics").value = (which===1
  ? `00:05  V·∫ßn th∆° ƒë·∫ßu / C
00:15  Con ƒë∆∞·ªùng d√†i / G
00:25  Ng√†y mai t·ªõi / Am
00:35  Ni·ªÅm hy v·ªçng / F`
  : `00:06  L·∫°y Cha n∆°i ch·ªën r·∫•t cao / D
00:16  Xin g√¨n gi·ªØ ch√∫ng con / Bm
00:26  Qua b√£o t·ªë d√¢ng tr√†n / G
00:36  T√¨nh y√™u Ch√∫a lu√¥n c√≤n / A`);
  compilePreview();
  log("ƒê√£ n·∫°p demo", which);
}
$("#btnLoad1").onclick = ()=> loadDemo(1);
$("#btnLoad2").onclick = ()=> loadDemo(2);

/* ====== BOOT ====== */
window.addEventListener("load", ()=>{
  piInit();
  $("#btnLogin").onclick = piLogin;
  $("#btnCheck").onclick = checkPremium;
  $("#btnPay").onclick = payPremium;
  $("#instrument").addEventListener("change", compilePreview);
  // ƒë·ªìng h·ªì nh·ªè trong log
  log("DOM loaded. JS ƒëang ch·∫°y.");
});
</script>
</body>
</html>
