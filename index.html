<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PiChordify Kingdom ‚Äî v7.3</title>
<style>
:root{
  --bg:#0b1120; --card:#111827; --muted:#9ca3af; --accent:#7c3aed; --accent2:#06b6d4; --text:#e5e7eb;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);
  background:radial-gradient(1200px at 10% 0%,#0f172a 0%,#0b1120 60%,#060913 100%)}
.wrap{max-width:1180px;margin:24px auto;padding:0 16px}
.title{display:flex;gap:12px;align-items:baseline}
h1{margin:0;font-size:32px} .pill{background:#1f2937;border:1px solid #334155;border-radius:10px;padding:4px 10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
.card{background:var(--card);border:1px solid #334155;border-radius:14px;padding:12px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
label{color:var(--muted);font-size:14px}
select,input,textarea{width:100%;background:#0b1324;color:var(--text);border:1px solid #334155;border-radius:12px;padding:10px}
textarea{height:140px;resize:vertical;line-height:1.5}
button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn{background:#0b1324;border:1px solid #334155}
.btn-accent{background:linear-gradient(135deg,#7c3aed,#06b6d4)}
.small{font-size:12px;color:var(--muted)}
.footer{opacity:.7;text-align:center;margin:16px 0}
.logbox{height:220px;overflow:auto;background:#0b1324;border:1px solid #334155;border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
.mono{white-space:pre-wrap;line-height:1.5}
.badge{display:inline-flex;gap:8px;align-items:center}
.badge .dot{width:8px;height:8px;border-radius:50%}
.lock{opacity:.6;filter:grayscale(.2)}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">

  <div class="title">
    <h1>PiChordify Kingdom</h1>
    <span class="pill">v7.3</span>
    <span id="theme" class="pill small">Theme: t√≠m-ng·ªçc</span>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label>Gi·ªçng (key)</label>
          <select id="selKey">
            <option>C</option><option>Db</option><option>D</option><option>Eb</option>
            <option>E</option><option>F</option><option>Gb</option><option>G</option>
            <option>Ab</option><option>A</option><option>Bb</option><option>B</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Ti·∫øn tr√¨nh</label>
          <select id="selProg">
            <option>I-V-vi-IV</option>
            <option>vi-IV-I-V</option>
            <option>I-vi-IV-V</option>
            <option>ii-V-I</option>
            <option>12-bar-blues</option>
          </select>
        </div>
        <button id="btnSuggest" class="btn">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
      </div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>Ti√™u ƒë·ªÅ</label>
          <input id="titleI" placeholder="T√™n b√†i"/>
        </div>
        <div style="flex:1;display:flex;justify-content:flex-end;align-items:center">
          <span id="premiumBadge" class="badge small">
            <span id="pDot" class="dot" style="background:#ef4444"></span>
            <span id="pText">Premium: locked</span>
          </span>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî mm:ss  Em / D ...)</label>
          <textarea id="lyrics" placeholder="00:12  Em / D ..."></textarea>
        </div>
        <div style="flex:1">
          <label>G·ª£i √Ω h·ª£p √¢m</label>
          <textarea id="suggest" readonly></textarea>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1">
            <label>Audio (mp3)</label>
            <input id="audioUrl" placeholder="https://.../song.mp3"/>
          </div>
          <div class="row" style="gap:8px">
            <button id="btnPlay" class="btn">Play</button>
            <button id="btnPause" class="btn">Pause</button>
            <button id="btnStop" class="btn">Stop</button>
          </div>
        </div>
        <input type="range" min="0" max="1000" value="0" id="progress" class="range" style="width:100%;margin-top:8px"/>
        <div class="row">
          <label class="small">BPM</label><input id="bpm" type="number" value="68" style="width:90px"/>
          <label class="small">Offset (gi√¢y, ¬±)</label><input id="offset" type="number" value="0" style="width:120px"/>
          <span id="timelbl" class="small" style="margin-left:auto">0:00 / 0:00</span>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="card" style="flex:1">
          <div class="small">L∆∞u c·ª•c b·ªô (localStorage). ‚ÄúShare link‚Äù ch·ªâ hi·ªÉn th·ªã d·ªØ li·ªáu m√£ h√≥a trong URL.</div>
          <div class="row" style="margin-top:8px;gap:8px">
            <button id="btnSave" class="btn lock">Save (Premium)</button>
            <button id="btnLoad" class="btn lock">Load (Premium)</button>
            <button id="btnShare" class="btn-accent">Share link</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title" style="gap:10px">
          <div class="pill">ƒêƒÉng nh·∫≠p & thanh to√°n</div>
        </div>
        <div class="pill">Sandbox</div>
      </div>

      <div class="row" style="margin-top:8px;gap:10px">
        <button id="btnPiLogin" class="btn">Pi Login</button>
        <button id="btnCheckP" class="btn">Ki·ªÉm tra Premium</button>
        <button id="btnPiPay" class="btn-accent">Pi Pay (sandbox)</button>
      </div>

      <div class="row" style="margin-top:10px;justify-content:space-between;align-items:center">
        <div class="label">Log</div><span class="pill small">Console mirror</span>
      </div>
      <div id="log" class="logbox mono"></div>
    </div>
  </div>

  <div class="footer small">¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù</div>
</div>

<!-- Hidden audio -->
<audio id="audio" preload="auto"></audio>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
/* ======= Helpers & Logger ======= */
const $ = (id)=>document.getElementById(id);
const logBox = $('log');
function log(...args){
  const line = `[${new Date().toLocaleTimeString()}] ` + args.map(x=> typeof x==='string'?x:JSON.stringify(x)).join(' ');
  logBox.textContent += line + '\\n';
  logBox.scrollTop = logBox.scrollHeight;
  console.log(...args);
}
window.onerror = (e,s,l,c,err)=>{ log('‚ùå', s+':'+l, err?.stack||''); };
window.addEventListener('unhandledrejection', ev=>log('‚ùå promise', ev.reason?.message||ev.reason));

/* ======= Premium state ======= */
const LKEY='pichordify_v7_state';
const PKEY='pichordify_premium';
function premiumOn(){
  localStorage.setItem(PKEY,'true');
  $('pText').textContent='Premium: unlocked';
  $('pDot').style.background='#22c55e';
  ['btnSave','btnLoad'].forEach(id=>$(id).classList.remove('lock'));
}
function premiumOff(){
  localStorage.removeItem(PKEY);
  $('pText').textContent='Premium: locked';
  $('pDot').style.background='#ef4444';
  ['btnSave','btnLoad'].forEach(id=>$(id).classList.add('lock'));
}
function isPremium(){ return localStorage.getItem(PKEY)==='true'; }

/* ======= Chords Engine ======= */
const KEYS = {
  C:['C','Dm','Em','F','G','Am','Bdim'], Db:['Db','Ebm','Fm','Gb','Ab','Bbm','Cdim'],
  D:['D','Em','F#m','G','A','Bm','C#dim'], Eb:['Eb','Fm','Gm','Ab','Bb','Cm','Ddim'],
  E:['E','F#m','G#m','A','B','C#m','D#dim'], F:['F','Gm','Am','Bb','C','Dm','Edim'],
  Gb:['Gb','Abm','Bbm','B','Db','Ebm','Fdim'], G:['G','Am','Bm','C','D','Em','F#dim'],
  Ab:['Ab','Bbm','Cm','Db','Eb','Fm','Gdim'], A:['A','Bm','C#m','D','E','F#m','G#dim'],
  Bb:['Bb','Cm','Dm','Eb','F','Gm','Adim'], B:['B','C#m','D#m','E','F#','G#m','A#dim'],
};
const DEG = { 'I':0,'ii':1,'iii':2,'IV':3,'V':4,'vi':5,'VII':6 };
function parseProg(str){
  // "I-V-vi-IV" or "I-V-vi-IV"
  return str.replace(/[^\w-]/g,'').split(/[-‚Äì‚Äî]/g).map(p=>DEG[p] ?? 0);
}
function suggestChords(){
  const key = $('selKey').value;
  const prog = $('selProg').value;
  const bank = KEYS[key] || KEYS.C;
  const parts = parseProg(prog);
  const out = parts.map(i=>bank[i]).join(' ¬∑ ');
  $('suggest').value = `${key} major: ${out}`;
  log('üéº','suggest:', out);
}

/* ======= Audio ======= */
const audio = $('audio'), progress=$('progress'), timelbl=$('timelbl');
function setSrc(u){ audio.src = (u||'').trim(); }
audio.addEventListener('timeupdate',()=>{
  if(!isFinite(audio.duration)) return;
  progress.value = Math.floor(1000*audio.currentTime/audio.duration);
  timelbl.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`;
});
function fmt(n){ n=Math.floor(n||0); const m=Math.floor(n/60); const s=String(n%60).padStart(2,'0'); return `${m}:${s}`;}
$('btnPlay').addEventListener('click',()=>{ setSrc($('audioUrl').value); audio.currentTime=Math.max(0, (Number($('offset').value)||0)); audio.play().catch(e=>log('‚ùå play',e.message)); });
$('btnPause').addEventListener('click',()=>audio.pause());
$('btnStop').addEventListener('click',()=>{ audio.pause(); audio.currentTime=0; });

/* ======= Save/Load/Share (Premium) ======= */
function stateObj(){
  return {
    title:$('titleI').value,key:$('selKey').value, prog:$('selProg').value,
    lyrics:$('lyrics').value, suggest:$('suggest').value,
    audioUrl:$('audioUrl').value, bpm:$('bpm').value, offset:$('offset').value
  };
}
$('btnSave').addEventListener('click',()=>{
  if(!isPremium()) return log('üîí Premium locked: c·∫ßn thanh to√°n ƒë·ªÉ Save.');
  localStorage.setItem(LKEY, JSON.stringify(stateObj()));
  log('üíæ save ok');
});
$('btnLoad').addEventListener('click',()=>{
  if(!isPremium()) return log('üîí Premium locked: c·∫ßn thanh to√°n ƒë·ªÉ Load.');
  const s = localStorage.getItem(LKEY); if(!s) return log('‚ö†Ô∏è ch∆∞a c√≥ d·ªØ li·ªáu');
  const o = JSON.parse(s);
  $('titleI').value=o.title||''; $('selKey').value=o.key||'C'; $('selProg').value=o.prog||'I-V-vi-IV';
  $('lyrics').value=o.lyrics||''; $('suggest').value=o.suggest||''; $('audioUrl').value=o.audioUrl||'';
  $('bpm').value=o.bpm||'68'; $('offset').value=o.offset||'0';
  log('üìÇ load ok');
});
$('btnShare').addEventListener('click',()=>{
  const enc = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(stateObj())))));
  const url = location.origin+location.pathname+'#d='+enc;
  navigator.clipboard?.writeText(url); log('üîó copied share link.');
});
(function tryOpen(){
  const m = location.hash.match(/#d=(.+)$/); if(!m) return;
  try{ const o=JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(m[1]))))); 
    $('titleI').value=o.title||''; $('selKey').value=o.key||'C'; $('selProg').value=o.prog||'I-V-vi-IV';
    $('lyrics').value=o.lyrics||''; $('suggest').value=o.suggest||''; $('audioUrl').value=o.audioUrl||'';
    $('bpm').value=o.bpm||'68'; $('offset').value=o.offset||'0'; log('üîì opened from share link');
  }catch(e){ log('‚ùå open share', e.message); }
})();

/* ======= Pi SDK & Payments (sandbox) ======= */
async function initPi(){
  try{
    await Pi.init({ version:'2.0', sandbox:true });  // ‚Üê ƒë·ªïi sandbox:false khi sang production
    log('‚úÖ Pi SDK initialized (sandbox)');
  }catch(e){ log('‚ùå Pi init', e.message); }
}
async function piLogin(){
  try{
    const scopes=['payments','username','wallet_address'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
    log('üë§ Login OK:', auth.user?.username||'(unknown)');
    return auth;
  }catch(e){ log('‚ùå Login', e.message); }
}
async function piPaySandbox(amount=0.01){
  try{
    const auth = await piLogin(); if(!auth) return;
    const pay = await Pi.createPayment({
      amount:String(amount),
      memo:'PiChordify v7.3 sandbox test',
      metadata:{feature:'premium', ver:'7.3'},
      callbacks:{
        onReadyForServerApproval: (pid)=>log('ü™ô readyForApproval', pid),
        onReadyForServerCompletion:(pid,txid)=>{ 
          log('‚úÖ completed', pid, txid);
          // demo: m·ªü kh√≥a ngay ·ªü client
          premiumOn();
          log('‚ú® Premium unlocked (demo client).');
        },
        onCancel:(pid)=>log('üö´ canceled', pid),
        onError:(err)=>log('‚ö†Ô∏è onError', err?.message||err),
      }
    });
    log('createPayment ->', pay);
  }catch(e){ log('‚ùå Payment', e.message); }
}
function onIncompletePaymentFound(p){ log('‚ö†Ô∏è incomplete payment:', p?.identifier||p); }

/* ======= Wire UI ======= */
$('btnSuggest').addEventListener('click', suggestChords);
$('btnPiLogin').addEventListener('click', piLogin);
$('btnPiPay').addEventListener('click', ()=>piPaySandbox(0.01));
$('btnCheckP').addEventListener('click', ()=> log(isPremium()?'‚úÖ Premium ƒëang m·ªü':'üîí Premium ƒëang kh√≥a'));

/* ======= Boot ======= */
window.addEventListener('load', ()=>{
  suggestChords();
  initPi();
  isPremium()?premiumOn():premiumOff();
  log('üü£ Ready (Pi SDK loaded)');
});
</script>
</body>
</html>
