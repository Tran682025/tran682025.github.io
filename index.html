<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PiChordify Kingdom ‚Äî v7.6</title>

<!-- ===== Palette / Reset ===== -->
<style>
:root{
  --bg:#0f1320; --panel:#131a2a; --muted:#8892b0; --text:#e6e9ef;
  --brand1:#8a5cff; --brand2:#49c6ff; --accent:#9b7bff; --ok:#24d17e; --warn:#ffb347; --err:#ff5d73;
  --ring:rgba(138,92,255,.35);
  --mono:"SFMono-Regular","JetBrains Mono",ui-monospace,Consolas,monospace;
  --sans:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Noto Sans",sans-serif;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:var(--sans)}
h1,h2,h3{margin:0 0 .5rem}
small{color:var(--muted)}
a{color:var(--brand2);text-decoration:none}
.wrap{max-width:1200px;margin:auto;padding:20px}
.grid{display:grid;gap:16px}
@media(min-width:970px){.grid{grid-template-columns:1.2fr .9fr}}

.card{background:var(--panel);border:1px solid #1b2236;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
select,input,button,textarea{background:#0c1322;color:var(--text);border:1px solid #25304d;border-radius:12px;padding:10px 12px;font-size:15px}
select,input,textarea{outline:none}
select:focus,input:focus,textarea:focus,button:focus{box-shadow:0 0 0 3px var(--ring);border-color:#3b4b77}
button{cursor:pointer}
.btn{background:linear-gradient(90deg,var(--brand1),var(--brand2));border:none}
.btn.ghost{background:#0c1322}
.btn.bad{background:#2a0f18;border:1px solid #4b1122}
.btn.ok{background:#0f2a22;border:1px solid #11553c}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0e1629;border:1px solid #232e4a;font-size:13px;color:#cfd6e6}

h1.title{font-weight:800;letter-spacing:.5px;font-size:42px;line-height:1.05}
.ver{margin-left:10px;border-radius:999px;padding:6px 10px;background:#1a2033;border:1px solid #2a365d;color:#bfc7de;font-weight:600}

#logoPi svg{filter:drop-shadow(0 6px 12px rgba(138,92,255,.35))}
.mono{font-family:var(--mono);white-space:pre-wrap}
textarea{min-height:160px;width:100%;resize:vertical}
#suggest{min-height:112px}
.progress{height:8px;border-radius:999px;background:#0c1322;border:1px solid #25304d;position:relative}
.progress>i{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,#3e5cf5,#34d1ff);border-radius:999px}
.kbd{padding:2px 6px;border-radius:6px;border:1px solid #2a2f45;background:#0e1324;font-family:var(--mono);font-size:12px;color:#c6cee1}
.iconTab{display:flex;gap:10px}
.iconTab button{flex:1;display:flex;align-items:center;gap:10px;justify-content:center;padding:12px;border-radius:14px;background:#0e1629;border:1px solid #252c44}
.iconTab button.active{outline:2px solid var(--ring);border-color:#3b48ff;background:#121a30}
.iconTab img{height:18px;opacity:.9}
.rightBox{min-height:320px}
.hidden{display:none}
.small{font-size:13px;color:#9fb0d1}

  
/* === MK HERO (Musickingdom header) =================== */

.mk-hero {
  position: relative;
  padding: 2.5rem 1.5rem 2rem;
  background-image:
    linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(76, 29, 149, 0.96)),
    url("assets/musickingdom-christmas-bg.jpg");
  background-size: cover;
  background-position: center;
  border-bottom: 1px solid rgba(148, 163, 184, 0.4);
}

.mk-hero-inner {
  max-width: 960px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 1.75rem;
}

.mk-hero-art {
  flex-shrink: 0;
}

.mk-hero-img {
  display: block;
  width: 38px;          /* ‚Üì t·ª´ 110px ‚Üí 42px */
  height: auto;
  border-radius: 15px;
  box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
}

@media (min-width: 768px) {
  .mk-hero-img {
    width: 55px;        /* ‚Üì t·ª´ 150px ‚Üí 55px */
  }
}

.mk-hero-text h1 {
  margin: 0 0 0.35rem;
  font-size: clamp(1.9rem, 2.6vw, 2.4rem);
  font-weight: 800;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: #f9fafb;
}

.mk-hero-text p {
  margin: 0;
  color: #e5e7eb;
  font-size: 0.98rem;
  max-width: 30rem;
  line-height: 1.55;
}

</style>
</head>

<body>
<!-- ƒê·∫∂T NGAY D∆Ø·ªöI <body> TRONG index.html C·ª¶A Musickingdom -->

<header class="mk-hero">
  <div class="mk-hero-inner">
    <div class="mk-hero-art">
      <img
        src="assets/musickingdom-golden-turtle.jpg"
        alt="Musickingdom Golden Turtle"
        class="mk-hero-img"
      />
    </div>

    <div class="mk-hero-text">
      <h1>Musickingdom</h1>
      <p>
        C√¥ng c·ª• g·ª£i √Ω h·ª£p √¢m &amp; luy·ªán h√°t trong h·ªá sinh th√°i Pi ‚Äì 
        kh√¥ng gian th·ªù ph∆∞·ª£ng v√† s√°ng t·∫°o d√†nh cho Pioneers.
      </p>
    </div>
  </div>
</header>
  

  <!-- Logo Pi t√≠m-ng·ªçc (SVG chu·∫©n t√¥ng Pi + glow) -->
  <svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#8a5cff"/>
        <stop offset="1" stop-color="#49c6ff"/>
      </linearGradient>
    </defs>
    <circle cx="32" cy="32" r="30" fill="#20163a" stroke="#8a5cff" stroke-width="2"/>
    <path fill="url(#g)" d="M42 19v20.5a6.5 6.5 0 1 1-4 0V26h-4.5v13.5a6.5 6.5 0 1 1-4 0V26H25v-7h17zM19 26h7v7h-7z"/>
  </svg>
</div>

<div class="wrap">
  <div class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:10px">
    <h1 class="title">PiChordify Kingdom</h1>
    <span class="ver">v7.6</span>
  </div>

  <div class="grid">
    <!-- ===== Left: Editor ===== -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small" style="margin-bottom:8px">Nh·∫°c c·ª•</div>
          <div class="iconTab" role="tablist" aria-label="instrument">
            <button id="tabPiano" class="active" aria-selected="true"><img alt="piano" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Crect width='24' height='14' y='5' rx='3' fill='%23aab7ef'/%3E%3Crect x='3' y='5' width='3' height='14' fill='%230c1322'/%3E%3Crect x='8' y='5' width='2' height='14' fill='%230c1322'/%3E%3Crect x='12' y='5' width='2' height='14' fill='%230c1322'/%3E%3Crect x='16' y='5' width='2' height='14' fill='%230c1322'/%3E%3Crect x='19' y='5' width='3' height='14' fill='%230c1322'/%3E%3C/svg%3E"/>Piano</button>
            <button id="tabGuitar"><img alt="guitar" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M18 6l3-3 2 2-3 3a3 3 0 01-3 3l-2 2 2 2-3 3-4-4 3-3 2 2 2-2a3 3 0 003-3z' fill='%23ff7d7d'/%3E%3C/svg%3E"/>Guitar</button>
            <button id="tabUke"><img alt="ukulele" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Ccircle cx='8' cy='16' r='5' fill='%23b5e6ff'/%3E%3Crect x='12' y='14' width='8' height='4' rx='2' fill='%237bd1ff'/%3E%3Crect x='20' y='13' width='3' height='6' rx='1' fill='%237bd1ff'/%3E%3C/svg%3E"/>Ukulele</button>
          </div>
        </div>
        <div>
          <div class="small" style="margin-bottom:8px">Gi·ªçng (key)</div>
          <div class="row">
            <select id="selKey"></select>
            <div class="row">
              <button id="btnDown" class="btn ghost" title="Transpose -1">‚àí1</button>
              <button id="btnUp"   class="btn ghost" title="Transpose +1">+1</button>
              <span class="badge"><span id="transposeView">0</span> semitones</span>
            </div>
          </div>
        </div>
        <div>
          <div class="small" style="margin-bottom:8px">Ti·∫øn tr√¨nh</div>
          <select id="selProg">
            <option>I‚ÄìV‚Äìvi‚ÄìIV</option>
            <option>vi‚ÄìIV‚ÄìI‚ÄìV</option>
            <option>I‚Äìvi‚ÄìIV‚ÄìV</option>
            <option>ii‚ÄìV‚ÄìI</option>
            <option>12-bar</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <input id="title" placeholder="T√™n b√†i" style="flex:1"/>
        <button id="btnSuggest" class="btn">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
      </div>

      <div class="row" style="margin-top:12px">
        <div style="flex:1">
          <div class="small">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî d·∫°ng: <span class="kbd">mm:ss Em / D</span>)</div>
          <textarea id="lyrics" placeholder="00:12   Em  /  D ..."></textarea>
        </div>
        <div style="flex:1">
          <div class="small">G·ª£i √Ω h·ª£p √¢m</div>
          <textarea id="suggest" class="mono" readonly></textarea>
        </div>
      </div>

      <!-- ===== Audio ===== -->
      <div style="margin-top:10px">
        <div class="row">
          <input id="audioUrl" placeholder="https://‚Ä¶/song.mp3" style="flex:1"/>
          <input id="filePick" type="file" accept="audio/mpeg" class="hidden"/>
          <button id="btnPick" class="btn ghost">Ch·ªçn MP3</button>
          <button id="btnLoad" class="btn ghost">Load</button>
        </div>
        <div class="row" style="margin-top:10px;align-items:center">
          <button id="btnPlay" class="btn">Play</button>
          <button id="btnPause" class="btn ghost">Pause</button>
          <button id="btnStop" class="btn bad">Stop</button>
          <span id="time" class="mono small">0:00 / 0:00</span>
        </div>
        <div class="progress" style="margin-top:8px"><i id="bar"></i></div>
      </div>

      <!-- ===== Local save / Export ===== -->
      <div class="row" style="margin-top:12px">
        <button id="btnSave" class="btn ghost">Save</button>
        <button id="btnLoadLocal" class="btn ghost">Load</button>
        <button id="btnShare" class="btn">Share link</button>
        <button id="btnPDF" class="btn ok">Export Lead Sheet (PDF)</button>
        <span class="small">L∆∞u c·ª•c b·ªô (localStorage). ‚ÄúShare link‚Äù m√£ ho√° trong URL.</span>
      </div>

      <audio id="audio" preload="auto"></audio>
    </div>

    <!-- ===== Right: Pi Login / Pay & Log ===== -->
    <div class="card rightBox">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>ƒêƒÉng nh·∫≠p & thanh to√°n</h3>
        <span class="badge">Sandbox</span>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnPiLogin" class="btn ghost">Pi Login</button>
        <button id="btnCheck" class="btn ghost">Ki·ªÉm tra Premium</button>
        <button id="btnPiPay" class="btn">Pi Pay (sandbox)</button>
      </div>

      <div style="margin-top:12px">
        <div class="small">Log</div>
        <textarea id="log" class="mono" style="height:260px"></textarea>
        <div class="small">Console mirror (copy/paste ƒë∆∞·ª£c)</div>
      </div>
    </div>
  </div>

  <div class="small" style="margin-top:10px">¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù</div>
</div>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<!-- jsPDF for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ========== Helpers ========== */
const $ = (id)=>document.getElementById(id);
const logBox = $('log');
function log(...args){
  const t = new Date().toLocaleTimeString();
  const line = `[${t}] ` + args.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ');
  logBox.value = (logBox.value? logBox.value+'\n':'') + line;
  logBox.scrollTop = logBox.scrollHeight;
  console.log(...args);
}
window.onerror=(m,s,l,c,e)=>{ log('‚ùå', m, s+':'+l, e?.stack||''); };
window.addEventListener('unhandledrejection',ev=>log('‚ùå promise', ev.reason?.message||ev.reason));

/* ========== Chords & Transpose ========== */
const KEYS = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
const DEG  = { 'I':0,'ii':2,'iii':4,'IV':5,'V':7,'vi':9,'vii¬∞':11 };
const BANK = {
  Piano:{ triad:(deg,maj=true)=> triadName(deg,maj) },
  Guitar:{ triad:(deg,maj=true)=> triadName(deg,maj)+' (open)' },
  Ukulele:{ triad:(deg,maj=true)=> triadName(deg,maj)+' (C6)' }
};
let state = { key:"C", prog:"I‚ÄìV‚Äìvi‚ÄìIV", inst:"Piano", transpose:0 };

function triadName(deg,maj){
  const map = {'I':'','ii':'m','iii':'m','IV':'','V':'','vi':'m','vii¬∞':'dim'};
  const suffix = maj? map[deg] : (map[deg]==='m'?'':'m'); // quick toggle
  return rootFor(deg) + (suffix||'');
}
function rootFor(deg){
  // rotate chroma by current key
  const base = noteIndex(state.key);
  const deg2semi = {'I':0,'ii':2,'iii':4,'IV':5,'V':7,'vi':9,'vii¬∞':11}[deg];
  return KEYS[(base + deg2semi + (state.transpose%12+12)%12) % 12];
}
function noteIndex(k){ return KEYS.indexOf(k); }

function suggest(){
  const p = state.prog.replace(/‚Äì/g,'-');
  let seq;
  if(p==='12-bar' || p==='12-bar'){ seq = ['I','I','I','I','IV','IV','I','I','V','IV','I','V']; }
  else { seq = p.split('-'); }
  const mk = BANK[state.inst].triad;
  const lines = [];
  lines.push(`${state.key} major  ¬∑  ${state.prog}`);
  lines.push(seq.map(d=>mk(d,true)).join('  ¬∑  '));
  $('suggest').value = lines.join('\n');
  log('üéº suggest:', seq.map(d=>rootFor(d)).join(' ¬∑ '));
}

/* transpose controls */
function applyTranspose(delta){
  state.transpose = Math.max(-12, Math.min(12, state.transpose + delta));
  $('transposeView').textContent = state.transpose;
  suggest();
}

/* ========== Audio player ========== */
const audio = $('audio');
const bar = $('bar');
function loadAudio(url){
  audio.src = url; audio.load();
}
audio.addEventListener('timeupdate', ()=>{
  if(isFinite(audio.duration)){
    const p = audio.currentTime / audio.duration;
    bar.style.width = (p*100)+'%';
    $('time').textContent = fmt(audio.currentTime)+' / '+fmt(audio.duration);
  }
});
function fmt(s){ if(!isFinite(s)) return '0:00';
  const m = Math.floor(s/60), ss=Math.floor(s%60).toString().padStart(2,'0');
  return `${m}:${ss}`;
}

/* ========== Local Save / Share ========== */
const LKEY='pichordify_v76';
function stateObj(){
  return {
    title:$('title').value, key:$('selKey').value, prog:$('selProg').value, inst:state.inst, tr:state.transpose,
    lyrics:$('lyrics').value, suggest:$('suggest').value, url:$('audioUrl').value
  };
}
function apply(o){
  if(!o) return;
  $('title').value=o.title||'';
  $('selKey').value=o.key||'C';
  $('selProg').value=o.prog||'I‚ÄìV‚Äìvi‚ÄìIV';
  $('lyrics').value=o.lyrics||'';
  $('suggest').value=o.suggest||'';
  $('audioUrl').value=o.url||'';
  state.key=$('selKey').value; state.prog=$('selProg').value; state.inst=o.inst||'Piano'; state.transpose=o.tr||0;
  $('transposeView').textContent = state.transpose;
  pickInstrument(state.inst);
  if(o.url) loadAudio(o.url);
}
$('btnSave').addEventListener('click',()=>{ localStorage.setItem(LKEY, JSON.stringify(stateObj())); log('üíæ saved'); });
$('btnLoadLocal').addEventListener('click',()=>{ const o=JSON.parse(localStorage.getItem(LKEY)||'null'); apply(o); log('üìÇ loaded'); });

$('btnShare').addEventListener('click',()=>{
  const enc = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(stateObj())))));
  const url = location.origin + location.pathname + '#d=' + enc;
  navigator.clipboard.writeText(url);
  log('üîó copied share link');
});
(function tryOpen(){
  const m = location.hash.match(/d=([^&]+)/); if(!m) return;
  try{ const o = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(m[1]))))); apply(o); log('üîó opened from share'); }
  catch(e){ log('‚ùå open share', e.message); }
})();

/* ========== UI wires ========== */
function pickInstrument(name){
  state.inst = name;
  ['tabPiano','tabGuitar','tabUke'].forEach(id=>$(id).classList.remove('active'));
  if(name==='Piano') $('tabPiano').classList.add('active');
  if(name==='Guitar') $('tabGuitar').classList.add('active');
  if(name==='Ukulele') $('tabUke').classList.add('active');
  $('title').placeholder = name;
  suggest();
}
$('tabPiano').onclick=()=>pickInstrument('Piano');
$('tabGuitar').onclick=()=>pickInstrument('Guitar');
$('tabUke').onclick=()=>pickInstrument('Ukulele');

$('selKey').addEventListener('change',e=>{ state.key=e.target.value; suggest(); });
$('selProg').addEventListener('change',e=>{ state.prog=e.target.value; suggest(); });
$('btnSuggest').addEventListener('click', suggest);
$('btnUp').onclick = ()=>applyTranspose(+1);
$('btnDown').onclick = ()=>applyTranspose(-1);

$('btnPick').onclick = ()=> $('filePick').click();
$('filePick').addEventListener('change', (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  $('audioUrl').value = url; loadAudio(url); log('üéµ loaded file:', f.name);
});
$('btnLoad').onclick = ()=>{ if($('audioUrl').value){ loadAudio($('audioUrl').value); log('üéµ loaded url'); }};

$('btnPlay').onclick = ()=> audio.play();
$('btnPause').onclick = ()=> audio.pause();
$('btnStop').onclick = ()=> { audio.pause(); audio.currentTime=0; };

/* Build key options */
(function fillKeys(){ $('selKey').innerHTML = KEYS.map(k=>`<option>${k}</option>`).join(''); })();

/* ========== Export PDF (Lead Sheet) ========== */
$('btnPDF').addEventListener('click', async()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const margin = 36, lh=20;
  const title = $('title').value||'Untitled';
  const lines = [
    `PiChordify Kingdom ‚Äî Lead Sheet`,
    `Title: ${title}`,
    `Instrument: ${state.inst}    Key: ${state.key}    Progression: ${state.prog}    Transpose: ${state.transpose}`,
    ``,
    `Suggestion:`,
    ...$('suggest').value.split('\n'),
    ``,
    `Lyrics & Chords:`,
    ...$('lyrics').value.split('\n')
  ];
  doc.setFont('helvetica','bold'); doc.setFontSize(18);
  doc.text(title, margin, 60);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  let y=90;
  for(const ln of lines){ doc.text(ln, margin, y); y+=lh; if(y>780){ doc.addPage(); y=60; } }
  // logo circle
  doc.setDrawColor(138,92,255); doc.setLineWidth(2); doc.circle(530,60,18); 
  doc.setTextColor(138,92,255); doc.setFontSize(16); doc.text('œÄ', 524, 66);
  doc.save((title||'lead-sheet')+'.pdf');
  log('üìÑ exported PDF');
});

/* ========== Pi SDK & Payments (sandbox) ========== */
async function initPi(){
  try{
    await Pi.init({ version:'2.0', sandbox:true });
    log('‚úÖ Pi SDK initialized (sandbox)');
    // enable buttons (in case previous session disabled)
    ['btnPiLogin','btnPiPay','btnCheck'].forEach(id=>$(id).removeAttribute('disabled'));
    // detect Pi Browser
    const isPi = !!window.Pi;
    const inPiBrowser = isPi && Pi.isPiBrowser?.()===true;
    if(!inPiBrowser){ log('‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c Pi Browser ‚Äî v·∫´n cho ph√©p test sandbox.'); }
  }catch(e){ log('‚ùå Pi init', e.message); }
}
async function piLogin(){
  try{
    const scopes=['payments','username','wallet_address'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
    log('üîê Login OK:', auth?.user?.username||'(unknown)');
    return auth;
  }catch(e){ log('‚ùå Login:', e.message); }
}
async function piPaySandbox(amount=0.01){
  try{
    const auth = await piLogin(); if(!auth) return;
    const pay = await Pi.createPayment({
      amount:String(amount),
      memo:'PiChordify v7.6 sandbox test',
      metadata:{feature:'premium', ver:'7.6'},
      callbacks:{
        onReadyForServerApproval:(pid)=>log('ü™ô readyForApproval', pid),
        onReadyForServerCompletion:(pid,txid)=>{ log('‚úÖ completed', pid, txid); premiumOn(); },
        onCancel:(pid)=>log('üö´ canceled', pid),
        onError:(err)=>log('‚ö†Ô∏è onError', err?.message||err),
      },
    });
    log('üßæ createPayment ->', pay);
  }catch(e){ log('‚ùå Payment', e.message); }
}
function onIncompletePaymentFound(p){ log('‚ö†Ô∏è incomplete payment:', p?.identifier||p); }
// Premium flag (demo client only)
function premiumOn(){ $('btnSave').classList.add('ok'); log('‚≠ê Premium (demo): h√£y thanh to√°n ƒë·ªÉ m·ªü kho√°.'); }

/* ========== Boot ========== */
window.addEventListener('load', ()=>{
  state.key='C'; state.prog=$('selProg').value; state.inst='Piano'; state.transpose=0;
  $('selKey').value='C'; $('transposeView').textContent='0';
  suggest(); initPi(); log('üü£ Ready (Pi SDK loaded)');
});
</script>

 
</body>
</html>
