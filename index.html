<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiChordify Kingdom ‚Äî v0.4</title>

  <!-- Pi SDK (ch·ªâ ho·∫°t ƒë·ªông trong Pi Browser) -->
  <script src="https://sdk.minepi.com/pi-sdk-js/2.7.0/pi-sdk.min.js" defer></script>
  <!-- jsPDF cho Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

  <style>
    :root{
      --pi:#6d41ff; --ink:#222; --bg:#f7f7ff; --ok:#17a34a; --warn:#f59e0b; --bad:#ef4444;
      --muted:#666;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 18px}
    h1{margin:0;font-size:28px;color:var(--pi)}
    .badge{background:#eee;border:#ddd solid 1px;border-radius:12px;padding:6px 10px;font-weight:700}
    main{max-width:1100px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    label{display:block;margin:8px 0 6px;font-weight:600}
    input[type="text"],input[type="url"],input[type="number"],textarea{
      width:100%;min-height:38px;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px
    }
    textarea{min-height:260px;font:14px/1.5 ui-monospace,Consolas,Menlo,monospace}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer;border:none;border-radius:12px;padding:11px 14px;font-weight:700}
    .primary{background:var(--pi);color:#fff}
    .ghost{background:#f1f5f9;color:#111}
    .ok{background:var(--ok);color:#fff}
    .bad{background:var(--bad);color:#fff}
    .warn{background:var(--warn);color:#111}
    .kara{min-height:260px;white-space:pre-wrap;background:#fff;border:1px dashed #d2d6ff;border-radius:12px;padding:12px;overflow:auto}
    .status{min-height:180px;white-space:pre-wrap;background:#111;color:#fff;border-radius:12px;padding:12px;font:13px/1.45 ui-monospace,Consolas,Menlo,monospace}
    footer{padding:12px 0;text-align:center;color:#777}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>

  <script>
    // ====== CONFIG ======
    // ƒê·ªîI URL n√†y sang backend c·ªßa anh (Render/Vercel/Railway‚Ä¶)
    const BACKEND_BASE = "https://pichordifykingdom-backend.onrender.com"; // <-- ƒê·ªîI N·∫æU C·∫¶N

    // ====== TI·ªÜN √çCH ======
    const $ = sel => document.querySelector(sel);
    const log = msg => { const el = $("#status"); el.textContent += (el.textContent? "\n":"") + msg; el.scrollTop = el.scrollHeight; };
    const isPi = () => typeof window.Pi !== "undefined";

    // ====== PI SDK ======
    async function piInit(){
      if(!isPi()){ log("‚ÑπÔ∏è Kh√¥ng ·ªü Pi Browser ‚Üí ·∫©n thanh to√°n. V√†o Pi Browser ƒë·ªÉ test SDK."); return; }
      try{
        window.Pi.init({ version: "2.0", sandbox: false });
        window.Pi.authenticate({ onIncompletePaymentFound: p => log("üßæ Incomplete payment: " + p.identifier) });
        log("‚úÖ Pi SDK s·∫µn s√†ng.");
      }catch(e){ log("‚ùå Pi init l·ªói: " + e.message); }
    }

    async function piLogin(){
      if(!isPi()) return log("‚ÑπÔ∏è Kh√¥ng c√≥ Pi SDK.");
      try{
        const scopes = ['username','payments'];
        const auth = await window.Pi.authenticate(scopes, onIncomplete => log("üßæ Incomplete: " + onIncomplete.identifier));
        $("#who").textContent = "@" + auth.user.username;
        log("üôå ƒêƒÉng nh·∫≠p: @" + auth.user.username);
      }catch(e){ log("‚ùå Login l·ªói: " + e.message); }
    }

    async function checkPremium(){
      try{
        const uid = $("#who").textContent.replace("@","");
        if(!uid){ log("‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p Pi."); return; }
        const r = await fetch(`${BACKEND_BASE}/check?uid=${encodeURIComponent(uid)}`);
        const j = await r.json();
        const tier = j?.premium ? "Premium" : "Free";
        $("#tier").textContent = tier;
        log(j?.premium ? "üíé Premium ƒë√£ k√≠ch ho·∫°t." : "üîì Ch∆∞a Premium.");
        return !!j?.premium;
      }catch(e){ log("‚ö†Ô∏è Kh√¥ng g·ªçi ƒë∆∞·ª£c backend /check."); return false; }
    }

    async function payPremium(){
      if(!isPi()) return log("‚ÑπÔ∏è Kh√¥ng c√≥ Pi SDK.");
      const uid = $("#who").textContent.replace("@","");
      if(!uid){ log("‚ö†Ô∏è ƒêƒÉng nh·∫≠p tr∆∞·ªõc ƒë√£."); return; }
      try{
        // 1) y√™u c·∫ßu server t·∫°o payment
        const make = await fetch(`${BACKEND_BASE}/payments/create`,{
          method:"POST", headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ uid })
        }).then(r=>r.json());
        const amount = make.amount ?? 0.01;
        const memo   = make.memo   ?? "PiChordify Premium";

        // 2) Pi.createPayment
        const payment = await window.Pi.createPayment({
          amount, memo, metadata:{ tier:"premium", uid }
        },{
          onReadyForServerApproval: async (paymentId)=>{
            log("üü£ onReadyForServerApproval: " + paymentId);
            await fetch(`${BACKEND_BASE}/payments/approve`,{
              method:"POST", headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ paymentId, uid })
            });
          },
          onReadyForServerCompletion: async (paymentId)=>{
            log("üü£ onReadyForServerCompletion: " + paymentId);
            await fetch(`${BACKEND_BASE}/payments/approve`,{
              method:"POST", headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ paymentId, uid, complete:true })
            });
            $("#tier").textContent = "Premium"; log("üéâ Premium ƒë√£ m·ªü.");
          },
          onCancel: (p)=> log("üö´ H·ªßy thanh to√°n."),
          onError:  (e)=> log("‚ùå L·ªói thanh to√°n: " + e)
        });
      }catch(e){ log("‚ùå payPremium l·ªói: " + e.message); }
    }

    // ====== AUDIO & METRONOME ======
    let player;
    function ensurePlayer(){
      if(!player){ player = $("#player"); }
      return player;
    }
    function loadAudio(){
      const url = $("#audioUrl").value.trim();
      if(!url){ log("‚ö†Ô∏è ƒêi·ªÅn URL mp3 tr∆∞·ªõc."); return; }
      ensurePlayer().src = url;
      log("üì• ƒê√£ n·∫°p audio.");
    }
    function aPlay(){ ensurePlayer().play().then(()=>log("‚ñ∂Ô∏è Play")).catch(e=>log("‚ùå Play l·ªói: "+e.message)); }
    function aPause(){ ensurePlayer().pause(); log("‚è∏Ô∏è Pause"); }
    function aStop(){ ensurePlayer().pause(); ensurePlayer().currentTime=0; log("‚èπÔ∏è Stop"); }
    function metronome16(){
      const bpm = Number($("#bpm").value||80);
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const interval = 60/bpm;
      let n=0;
      function tick(i){
        const t = ctx.currentTime + i*interval;
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.type="square"; o.frequency.value = (i%4===0? 1200:800);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.35, t+0.005);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.08);
        o.connect(g).connect(ctx.destination);
        o.start(t); o.stop(t+0.09);
      }
      for(let i=0;i<16;i++) tick(i);
      log(`üîä Play metronome 16 nh·ªãp @ ${bpm} BPM`);
    }

    // ====== SRT & PREVIEW ======
    function parseLines(txt){
      // ƒê·ªãnh d·∫°ng: mm:ss  <chords or lyrics>
      const rows = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      return rows.map((l,idx)=>{
        const m = l.match(/^(\d\d)\s*:\s*(\d\d)\s+(.*)$/);
        if(!m) return null;
        const start = Number(m[1])*60 + Number(m[2]);
        return { idx: idx+1, start, text: m[3] };
      }).filter(Boolean);
    }
    function toTimestamp(sec){
      const s = Math.max(0,sec)|0, ms = 0;
      const h = String((s/3600|0)).padStart(2,"0");
      const m = String(((s%3600)/60|0)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${h}:${m}:${ss},000`;
    }
    function compilePreview(){
      const t = $("#lyrics").value;
      const off = Number($("#offset").value||0);
      const items = parseLines(t);
      if(items.length===0){ log("‚ö†Ô∏è Kh√¥ng th·∫•y d√≤ng h·ª£p l·ªá mm:ss ..."); return; }
      $("#preview").textContent = items.map(x=>`${x.text}`).join("\n");
      log("üß© ƒê√£ bi√™n d·ªãch & hi·ªÉn th·ªã xem tr∆∞·ªõc.");
    }
    function exportSRT(){
      const t = $("#lyrics").value;
      const off = Number($("#offset").value||0);
      const items = parseLines(t);
      if(items.length===0){ log("‚ö†Ô∏è Kh√¥ng th·∫•y d√≤ng h·ª£p l·ªá."); return; }
      let srt = "";
      for(let i=0;i<items.length;i++){
        const a = items[i], b = items[i+1];
        const st = toTimestamp(a.start + off);
        const et = toTimestamp((b? b.start: a.start+4) + off);
        srt += `${i+1}\n${st} --> ${et}\n${a.text}\n\n`;
      }
      const blob = new Blob([srt], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = ( $("#title").value.trim() || "pichordify" ) + ".srt";
      a.click();
      log("üíæ ƒê√£ xu·∫•t .srt.");
    }
    async function exportPDF(){
      // Ch·ªâ cho Premium
      const ok = await checkPremium();
      if(!ok){ log("üîê C·∫ßn Premium. B·∫•m Thanh to√°n."); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });
      const title = $("#title").value || "PiChordify Sheet";
      doc.setFontSize(18); doc.text(title, 40, 50);
      doc.setFontSize(12);
      const lines = ($("#lyrics").value||"").split(/\r?\n/);
      let y=80;
      for(const L of lines){ doc.text(L, 40, y); y+=16; if(y>780){ doc.addPage(); y=50; } }
      doc.save(title.replace(/\s+/g,"_") + ".pdf");
      log("üìÑ ƒê√£ xu·∫•t PDF.");
    }

    // ====== DEMO ======
    function loadDemo(i){
      $("#title").value = "T√¨nh N·ªìng Vi·ªát (demo)";
      $("#lyrics").value =
`00:00 Am
00:05 F
00:10 C
00:15 G
00:20 Dm
00:25 E
00:30 Am`;
      $("#audioUrl").value = i===1
        ? "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Komiku/It's_time_for_adventure/Komiku_-_07_-_Battle_Of_Pogs.mp3"
        : "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Komiku/It's_time_for_adventure/Komiku_-_01_-_Time_for_Adventure.mp3";
      compilePreview();
      log(i===1 ? "üì• ƒê√£ n·∫°p Demo 1" : "üì• ƒê√£ n·∫°p Demo 2");
    }
    function clearAll(){
      $("#title").value=""; $("#lyrics").value=""; $("#preview").textContent="";
      $("#audioUrl").value=""; aStop(); log("üßπ ƒê√£ x√≥a.");
    }

    // ====== BOOT ======
    window.addEventListener("DOMContentLoaded",()=>{
      // n√∫t
      $("#btnPiLogin").addEventListener("click", piLogin);
      $("#btnCheckPremium").addEventListener("click", checkPremium);
      $("#btnPayPremium").addEventListener("click", payPremium);

      $("#btnLoadDemo1").addEventListener("click", ()=>loadDemo(1));
      $("#btnLoadDemo2").addEventListener("click", ()=>loadDemo(2));
      $("#btnClear").addEventListener("click", clearAll);

      $("#btnCompile").addEventListener("click", compilePreview);
      $("#btnExportSrt").addEventListener("click", exportSRT);
      $("#btnExportPdf").addEventListener("click", exportPDF);

      $("#btnLoadAudio").addEventListener("click", loadAudio);
      $("#btnPlayAudio").addEventListener("click", aPlay);
      $("#btnPauseAudio").addEventListener("click", aPause);
      $("#btnStopAudio").addEventListener("click", aStop);
      $("#btnMetro").addEventListener("click", metronome16);

      setInterval(()=>{ const p = ensurePlayer(); $("#time").textContent = new Date(p.currentTime*1000).toISOString().substr(14,5); }, 250);

      piInit();
      log("‚úÖ DOM loaded. JS ƒëang ch·∫°y.");
    });
  </script>
</head>

<body>
  <header>
    <div class="row" style="gap:10px;align-items:center">
      <h1>PiChordify Kingdom</h1>
      <span class="badge" id="tier">Free</span>
    </div>
    <div class="row">
      <button class="ghost" id="btnCheckPremium">Ki·ªÉm tra Premium</button>
      <button class="ok" id="btnPayPremium">Thanh to√°n Premium</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- C·ªòT TR√ÅI -->
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <span class="muted">Demo Core v0.4</span>
          <div class="row">
            <button class="ghost" id="btnLoadDemo1">T·∫£i demo 1</button>
            <button class="ghost" id="btnLoadDemo2">T·∫£i demo 2</button>
            <button class="bad"   id="btnClear">X√≥a</button>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="ghost" id="btnPiLogin">Pi Login</button>
          <span id="who" style="margin-left:8px;opacity:.7">@</span>
        </div>

        <label for="title">Ti√™u ƒë·ªÅ</label>
        <input id="title" type="text" placeholder="T√™n b√†i‚Ä¶">

        <label for="lyrics">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian)</label>
        <textarea id="lyrics" placeholder="mm:ss   n·ªôi dung / h·ª£p √¢m‚Ä¶"></textarea>

        <div class="row" style="margin-top:10px">
          <button class="primary" id="btnCompile">Bi√™n d·ªãch & xem tr∆∞·ªõc</button>
          <button class="ghost"   id="btnExportSrt">Export .srt</button>
          <button class="primary" id="btnExportPdf">Export PDF (Premium)</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label for="bpm">BPM (nh·ªãp)</label>
            <input id="bpm" type="number" value="80" min="40" max="220" />
          </div>
          <div style="flex:1">
            <label for="offset">Offset (gi√¢y, +/-)</label>
            <input id="offset" type="number" value="0" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <label for="audioUrl">URL audio (mp3)</label>
          <input id="audioUrl" type="url" placeholder="https://.../song.mp3" />
          <div class="row" style="margin-top:8px">
            <button class="ghost" id="btnLoadAudio">T·∫£i nh·∫°c</button>
            <button class="ghost" id="btnPlayAudio">‚ñ∂ Play</button>
            <button class="ghost" id="btnPauseAudio">‚è∏ Pause</button>
            <button class="ghost" id="btnStopAudio">‚èπ Stop</button>
            <button class="warn"  id="btnMetro">Ph√°t nh·ªãp th·ª≠</button>
          </div>
          <audio id="player" preload="none" style="width:100%;margin-top:8px;display:block;outline:none;appearance:none;"></audio>
          <div id="time" style="text-align:right;opacity:.7">00:00</div>
        </div>
      </section>

      <!-- C·ªòT PH·∫¢I -->
      <section class="card">
        <div class="kara" id="preview">S·∫µn s√†ng. Nh·∫•n ‚ÄúBi√™n d·ªãch & xem tr∆∞·ªõc‚Äù.</div>
        <div id="status" class="status" style="margin-top:12px">üñ§ Ready.</div>
      </section>
    </div>
  </main>

  <footer>¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù v0.4</footer>
</body>
</html>
