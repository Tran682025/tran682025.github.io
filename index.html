<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PiChordify Kingdom ‚Äî v7.1</title>
  <!-- Pi SDK: ch·ªâ c√≥ hi·ªáu l·ª±c trong Pi Browser -->
  <script src="https://sdk.minepi.com/pi-sdk.js" defer></script>
  <style>
    :root{
      --bg:#0f1320; --panel:#151a2b; --ink:#dfe7ff; --muted:#99a3c4;
      --pi:#6c5ce7; --pi2:#76e4d7; --ok:#65e3a6; --err:#ff7b7b; --line:#26304b;
      --focus:#9aa8ff; --btn:#2a3253; --btn2:#3a4371;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0e1220,#11162a 40%,#101529);
      color:var(--ink); font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto;
    }
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    header{display:flex;align-items:flex-start;gap:16px;justify-content:space-between;margin-bottom:14px}
    h1{margin:0;font-size:28px;letter-spacing:.3px}
    small.badge{background:var(--btn2);color:#fff;padding:3px 8px;border-radius:10px;margin-left:6px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    label{display:block;color:var(--muted);font-size:13px;margin:6px 0 4px}
    input[type="text"], input[type="number"], select, textarea{
      width:100%; background:#0f1430; color:var(--ink); border:1px solid var(--line);
      border-radius:10px; padding:10px 12px; outline:none;
    }
    textarea{min-height:260px; font:14px/1.6 ui-monospace,Consolas,monospace}
    @media (max-width: 600px){ textarea{min-height:360px} }
    .btn{cursor:pointer; user-select:none; background:var(--btn); color:#fff; border:1px solid var(--line);
      padding:10px 14px; border-radius:12px; font-weight:600; box-shadow:0 0 0 0 rgba(0,0,0,0);
    }
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:linear-gradient(90deg,var(--pi),var(--pi2))}
    .btn.ghost{background:transparent;border-color:var(--btn2)}
    .btn.danger{background:#e45656}
    .stack>*{margin-right:8px}
    .panel{background:#0e142b;color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:12px}
    #log{height:300px;overflow:auto;font:13px/1.5 ui-monospace,Consolas,monospace}
    #preview{height:340px;overflow:auto;border:1px dashed var(--line);border-radius:12px;padding:12px;background:#0c1226}
    @media (max-width:600px){#preview{height:360px}}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#23305d;padding:6px 10px;border-radius:16px;font-size:13px}
    .meter{display:flex;align-items:center;gap:8px}
    .muted{color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .right{display:flex;justify-content:flex-end;gap:10px}
    .range{accent-color:var(--pi)}
    .note{font-size:12px;color:var(--muted)}
    .chip{background:#1e2747;border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    footer{opacity:.6;text-align:center;padding:18px 6px}
    /* chord tokens */
    .chord{display:inline-block;padding:2px 6px;background:#1f2a4d;border:1px solid #3a4a7a;border-radius:6px;margin:0 2px}
    .bar{display:inline-block;padding:2px 6px;background:#163542;border:1px solid #2b6374;border-radius:6px;margin:0 2px}
    .warn{color:#ffd38a}
    .ok{color:#8ff5c9}
    .err{color:#ff9c9c}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>PiChordify Kingdom <small class="badge">v7.1</small></h1>
      <div class="pill">Theme: <b>t√≠m‚Äìng·ªçc</b></div>
    </div>
    <div class="row">
      <button id="btnLogin" class="btn">Pi Login</button>
      <button id="btnCheck" class="btn ghost">Ki·ªÉm tra Premium</button>
      <button id="btnPay" class="btn primary">Pi Pay (sandbox)</button>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="row">
        <div class="kv">
          <div>
            <label>Gi·ªçng (key) & ti·∫øn tr√¨nh</label>
            <select id="selKey">
              <option>C</option><option>Db</option><option>D</option><option>Eb</option>
              <option>E</option><option>F</option><option>Gb</option><option>G</option>
              <option>Ab</option><option>A</option><option>Bb</option><option>B</option>
              <option>Am</option><option>Bm</option><option>Cm</option><option>Dm</option>
              <option>Em</option><option>Fm</option><option>Gm</option><option>Abm</option>
              <option>Dbm</option><option>Ebm</option><option>F#m</option><option>Bbm</option>
            </select>
          </div>
          <div>
            <label>Ti√™u ƒë·ªÅ</label>
            <input id="title" type="text" placeholder="T√™n b√†i‚Ä¶"/>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="kv">
          <div>
            <label>Ti·∫øn tr√¨nh</label>
            <select id="selProg" title="Chord progression">
              <option>I‚ÄìV‚Äìvi‚ÄìIV</option>
              <option>I‚Äìvi‚ÄìIV‚ÄìV</option>
              <option>vi‚ÄìIV‚ÄìI‚ÄìV</option>
              <option>ii‚ÄìV‚ÄìI</option>
              <option>12-bar-blues</option>
            </select>
          </div>
          <div class="right">
            <button id="btnAutoChord" class="btn">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
          </div>
        </div>
      </div>

      <small class="muted">App s·∫Ω ph√°t nh·ªãp theo v√≤ng 4/4. Tr·∫´m c√≥ th·ªÉ ch·ªânh l·∫°i sau khi d√†nh.</small>

      <label>L·ªùi + h·ª£p √¢m <span class="muted">(m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî ƒë·ªãnh d·∫°ng: <b>mm:ss n·ªôi dung / h·ª£p √¢m</b>, v√≠ d·ª•: <b>00:12 Em / D</b>)</span></label>
      <textarea id="lyrics" placeholder="mm:ss  n·ªôi dung / h·ª£p √¢m‚Ä¶"></textarea>

      <div class="kv" style="margin-top:12px">
        <div>
          <div class="kv">
            <div>
              <label>BPM (nh·ªãp)</label>
              <input id="bpm" type="number" value="80" min="30" max="220"/>
            </div>
            <div>
              <label>Offset (gi√¢y, +/-)</label>
              <input id="offset" type="number" step="0.1" value="0"/>
            </div>
          </div>

          <div class="sep"></div>

          <div class="kv">
            <div>
              <label>Transpose nh·∫°c c·ª•</label>
              <div class="meter">
                <input id="transpose" class="range" type="range" min="-12" max="12" step="1" value="0"/>
                <span id="transposeLabel" class="chip">0</span>
              </div>
            </div>
            <div>
              <label>Nh·∫°c c·ª•</label>
              <div class="row">
                <label class="pill"><input type="radio" name="inst" value="guitar" checked> guitar</label>
                <label class="pill"><input type="radio" name="inst" value="piano"> piano</label>
                <label class="pill"><input type="radio" name="inst" value="ukulele"> ukulele</label>
              </div>
            </div>
          </div>

          <div class="sep"></div>
          <div class="row stack">
            <button id="btnMetro" class="btn">Ph√°t nh·ªãp th·ª≠</button>
            <button id="btnCompile" class="btn ghost">Bi√™n d·ªãch & xem tr∆∞·ªõc</button>
            <button id="btnExportSvg" class="btn ghost">Export .svg</button>
          </div>

          <div class="sep"></div>
          <label>Audio (mp3)</label>
          <input id="audioUrl" type="text" placeholder="https://‚Ä¶/song.mp3"/>
          <div class="row stack" style="margin-top:6px">
            <input id="filePick" type="file" accept="audio/mpeg" />
            <button id="btnPlay" class="btn">Play</button>
            <button id="btnPause" class="btn">Pause</button>
            <button id="btnStop" class="btn">Stop</button>
          </div>
          <audio id="player" preload="none" style="width:100%;margin-top:8px" controls></audio>

          <div class="sep"></div>
          <div class="row stack">
            <button id="btnSave" class="btn">Save</button>
            <button id="btnLoad" class="btn ghost">Load</button>
            <button id="btnShare" class="btn ghost">Share link</button>
          </div>
          <div class="note">L∆∞u c·ª•c b·ªô (localStorage). ‚ÄúShare link‚Äù ch·ªâ hi·ªÉn th·ªã d·ªØ li·ªáu m√£ h√≥a trong URL.</div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between;align-items:baseline">
            <div class="pill" id="ppill">Transpose: <b id="ppillv">0</b> ‚Ä¢ Nh·∫°c c·ª•: <b id="ppilli">guitar</b></div>
          </div>
          <div id="preview"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="row" style="justify-content:space-between">
        <div class="pill">Log</div>
        <div class="pill muted">Sandbox</div>
      </div>
      <div id="log" class="panel"></div>
    </aside>
  </div>

  <footer>¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù v7.1</footer>
</div>

<script>
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
function log(msg, lvl){ 
  const el = byId('log'); 
  const span = document.createElement('div');
  span.innerHTML = (lvl==='ok'?'‚úÖ ':'') + (lvl==='err'?'‚ùå ':'') + msg;
  el.appendChild(span); el.scrollTop = el.scrollHeight;
}
function setText(id, t){ byId(id).textContent = t }

/* ---------- Pi SDK ---------- */
const state = { pi:null, user:null };

function piAvailable(){
  return (typeof window.Pi !== 'undefined');
}

async function initPi(){
  // ch·ªù Pi SDK t·ªëi ƒëa ~4s
  let tries = 0;
  const h = setInterval(()=>{
    if (piAvailable() || tries++>40){
      clearInterval(h);
      if(!piAvailable()){
        log('Kh√¥ng c√≥ Pi SDK. M·ªü b·∫±ng Pi Browser t·∫°i subdomain .minepi.app');
        byId('btnPay').disabled = true;
        return;
      }
      try{
        window.Pi.init({version:'2.0', sandbox:true});
        state.pi = window.Pi;
        log('Pi SDK init xong.','ok');
      }catch(e){ log('Pi SDK init l·ªói: '+e.message,'err'); }
  function piAvailable(){
  return (typeof window.Pi !== 'undefined');
}

async function initPi(){
  let tries = 0;
  const h = setInterval(async ()=>{
    if(piAvailable() || tries++ > 40){
      clearInterval(h);
      if(!piAvailable()){
        log('‚ö†Ô∏è Kh√¥ng c√≥ Pi SDK. M·ªü trong Pi Browser t·∫°i subdomain *.minepi.app');
        document.getElementById('btnPay').disabled = true;
        return;
      }
      try{
        // ‚úÖ Kh·ªüi t·∫°o SDK v·ªõi allowedOrigins
        await Pi.init({
          version: "2.0",
          sandbox: true,
          allowedOrigins: [
            "https://tran682025.github.io",
            "https://tranmusickingdom1067.minepi.app"
          ]
        });
        state.pi = window.Pi;
        log('‚úÖ Pi SDK init xong.');
      }catch(e){
        log('‚ùå Pi SDK init l·ªói: '+e.message);
      }
    }
  },100);
}

async function piLogin(){
  if(!piAvailable()) return log('‚ö†Ô∏è Pi SDK ch∆∞a s·∫µn s√†ng.');
  try{
    const scopes = ['username','payments'];
    const onIncomplete = (paymentId)=>log('üü£ Giao d·ªãch ch∆∞a ho√†n t·∫•t: '+paymentId);
    const auth = await Pi.authenticate(scopes,onIncomplete);
    state.user = auth.user;
    log('‚úÖ ƒêƒÉng nh·∫≠p Pi: @'+auth.user.username);
  }catch(e){
    log('‚ùå Pi Login l·ªói: '+e.message);
  }
}

async function checkPremium(){
  log('checkPremium (demo) ‚Üí ch∆∞a c√≥ backend ‚Üí false');
}

async function piPay(){
  if(!piAvailable()) return log('‚ö†Ô∏è Pi SDK ch∆∞a s·∫µn s√†ng.');
  try{
    const paymentData = {
      amount: 1,
      memo: "üéµ PiChordify Premium",
      metadata: {purpose:"demo"}
    };
    const callbacks = {
      onReadyForServerApproval:(p)=>log('‚è≥ ƒê·ª£i duy·ªát: '+p.identifier),
      onReadyForServerCompletion:(p)=>log('‚úÖ Thanh to√°n xong: '+p.identifier),
      onCancel:(p)=>log('‚ùå H·ªßy giao d·ªãch: '+p.identifier),
      onError:(e)=>log('üí• L·ªói thanh to√°n: '+e.message)
    };
    await Pi.createPayment(paymentData, callbacks);
  }catch(e){
    log('‚ùå Pi Pay l·ªói: '+e.message);
  }
}

    const cb = {
      onReadyForServerApproval: async(p)=>{ log('onReadyForServerApproval: '+p.identifier); },
      onReadyForServerCompletion: async(p)=>{ log('onReadyForServerCompletion: '+p.identifier); },
      onCancel: (p)=> log('Payment b·ªã h·ªßy.'),
      onError: (e)=> log('Payment l·ªói: '+e?.message, 'err')
    };
    const pay = await window.Pi.createPayment(paymentData, cb);
    log('T·∫°o payment Id: '+pay.identifier,'ok');
  }catch(e){ log('Pi Pay l·ªói: '+e.message,'err'); }
}

/* ---------- Audio & Metronome ---------- */
const player = byId('player');
function primeAudioPolicy(){
  // m·ªìi policy m·ªôt l·∫ßn
  const fire = ()=>{ player.play().then(()=>player.pause()).catch(()=>{}); };
  ['click','touchstart'].forEach(ev=> document.body.addEventListener(ev, fire, {once:true}));
}
function loadAudio(){
  const f = byId('filePick').files?.[0];
  const url = byId('audioUrl').value.trim();
  if(f){
    player.src = URL.createObjectURL(f);
    log('ƒê√£ n·∫°p file mp3: '+f.name);
  }else if(url){
    player.crossOrigin='anonymous'; player.src = url;
    log('ƒê√£ n·∫°p audio URL.');
  }
  player.load();
}
byId('audioUrl').addEventListener('change',loadAudio);
byId('filePick').addEventListener('change',loadAudio);
byId('btnPlay').addEventListener('click',()=>player.play().catch(e=>log('Play l·ªói: '+e.message,'err')));
byId('btnPause').addEventListener('click',()=>player.pause());
byId('btnStop').addEventListener('click',()=>{player.pause();player.currentTime=0;});

let metroCtx=null, metroOsc=null, metroGain=null, metroTimer=null;
function metroStart(){
  const bpm = Math.max(30, Math.min(220, Number(byId('bpm').value||80)));
  const intervalMs = 60000/bpm;
  if(!metroCtx) metroCtx = new (window.AudioContext||window.webkitAudioContext)();
  if(!metroGain){ metroGain = metroCtx.createGain(); metroGain.gain.value = .08; metroGain.connect(metroCtx.destination)}
  log('B·∫≠t metronome '+bpm+' BPM');
  metroTimer = setInterval(()=>{
    metroOsc = metroCtx.createOscillator();
    metroOsc.frequency.value = 880;
    metroOsc.connect(metroGain);
    metroOsc.start(); setTimeout(()=>{ try{metroOsc.stop()}catch{} }, 60);
  }, intervalMs);
}
function metroStop(){ if(metroTimer){ clearInterval(metroTimer); metroTimer=null; log('T·∫Øt metronome'); } }
byId('btnMetro').addEventListener('click',()=> metroTimer?metroStop():metroStart());

/* ---------- Chords & Transpose ---------- */
const NOTE_SEQ = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
const NOTE_SEQ_SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
function normNote(n){
  return n.replace('‚ôØ','#').replace('‚ô≠','b');
}
function shiftNote(note, semis){
  // t√°ch root + suffix (Cm7/G ‚Üí C + m7/G gi·ªØ nguy√™n bass nh∆∞ng transpose root & bass)
  const m = normNote(note).match(/^([A-G](?:#|b)?)(.*?)(?:\/([A-G](?:#|b)?))?$/);
  if(!m) return note;
  const [_, root, suf='', bass] = m;
  const seq = root.includes('#') ? NOTE_SEQ_SHARP : NOTE_SEQ;
  const idx = seq.indexOf(root.replace('b','#')==='E#'?'F':root);
  let out = seq[(idx+12+semis)%12] || root;
  let b = bass;
  if(b){ 
    const seq2 = b.includes('#')?NOTE_SEQ_SHARP:NOTE_SEQ;
    const idx2 = seq2.indexOf(b.replace('b','#')==='E#'?'F':b);
    b = seq2[(idx2+12+semis)%12] || b;
  }
  return out + suf + (b?('/'+b):'');
}
function transposeLineChords(text, semis){
  // ‚Äú... / Em D G7 ...‚Äù ‚Üí d·ªãch t·ª´ng token c√≥ d·∫°ng h·ª£p √¢m
  return text.replace(/([A-G](?:#|b)?(?:m|maj|min|dim|aug|sus|add)?\d*(?:\/[A-G](?:#|b)?)?)/g,
    (_,ch)=> shiftNote(ch, semis));
}
byId('transpose').addEventListener('input', ()=>{
  const v = Number(byId('transpose').value||0);
  setText('transposeLabel', v); setText('ppillv', v);
  compile();
});

/* ---------- Autosuggest chords ---------- */
const PROG_MAP = {
  'I‚ÄìV‚Äìvi‚ÄìIV':['I','V','vi','IV'],
  'I‚Äìvi‚ÄìIV‚ÄìV':['I','vi','IV','V'],
  'vi‚ÄìIV‚ÄìI‚ÄìV':['vi','IV','I','V'],
  'ii‚ÄìV‚ÄìI':['ii','V','I','I'],
  '12-bar-blues':['I','I','I','I','IV','IV','I','I','V','IV','I','V']
};
const DEGREE_TO_CHORD = {
  C: ['C','Dm','Em','F','G','Am','Bdim'],
  D: ['D','Em','F#m','G','A','Bm','C#dim'],
  Eb:['Eb','Fm','Gm','Ab','Bb','Cm','Ddim'],
  E: ['E','F#m','G#m','A','B','C#m','D#dim'],
  F: ['F','Gm','Am','Bb','C','Dm','Edim'],
  Gb:['Gb','Abm','Bbm','B','Db','Ebm','Fdim'],
  G: ['G','Am','Bm','C','D','Em','F#dim'],
  Ab:['Ab','Bbm','Cm','Db','Eb','Fm','Gdim'],
  A: ['A','Bm','C#m','D','E','F#m','G#dim'],
  Bb:['Bb','Cm','Dm','Eb','F','Gm','Adim'],
  B: ['B','C#m','D#m','E','F#','G#m','A#dim']
};
function degreeChord(key, deg){ // deg: I,ii,vi,IV...
  key = key.replace('m',''); // map sang major table ƒë·ªÉ demo
  const scale = DEGREE_TO_CHORD[key] || DEGREE_TO_CHORD.C;
  const map = {I:0,ii:1,iii:2,IV:3,V:4,vi:5,vii:6};
  const d = deg.replace('‚Äì','-');
  const idx = map[d.replace(/[^Iiv]/g,'').toLowerCase()] ?? 0;
  const chord = scale[idx];
  // case vi, ii, etc gi·ªØ th∆∞·ªùng ‚Üí chord ƒë√£ m/min s·∫µn
  if(/^[iv]+$/.test(deg)) return chord.toLowerCase().includes('m')?chord:chord+'m';
  return chord;
}
function autosuggest(){
  const key = byId('selKey').value.replace('m',''); // demo
  const prog = PROG_MAP[byId('selProg').value] || PROG_MAP['I‚ÄìV‚Äìvi‚ÄìIV'];
  const t = [];
  // sinh 8 d√≤ng m·∫´u v·ªõi m·ªëc 8s, offset theo BPM
  const bpm = Number(byId('bpm').value||80);
  const secPerBar = 60/bpm*4;
  for(let i=0;i<8;i++){
    const mm = String(Math.floor(i*secPerBar/60)).padStart(2,'0');
    const ss = String(Math.floor((i*secPerBar)%60)).padStart(2,'0');
    const d = prog[i % prog.length];
    const chord = degreeChord(key, d);
    t.push(`${mm}:${ss}  ‚Ä¶ / ${chord}`);
  }
  byId('lyrics').value = t.join('\n');
  compile();
  log(`ƒê√£ sinh h·ª£p √¢m theo ${byId('selKey').value} ‚Äì ${byId('selProg').value}.`);
}

/* ---------- Compile ‚Üí Preview ---------- */
function parseLines(txt){
  return txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map((l,i)=>{
    const m = l.match(/^(\d{2}):(\d{2})\s+(.*?)(?:\s*\/\s*(.+))?$/);
    if(!m) return {t:0, text:l, chord:''};
    const t = Number(m[1])*60 + Number(m[2]);
    return {t, text:m[3], chord:m[4]||''};
  });
}
function compile(){
  const raw = byId('lyrics').value;
  const items = parseLines(raw);
  const semis = Number(byId('transpose').value||0);
  const inst = (document.querySelector('input[name="inst"]:checked')||{}).value || 'guitar';
  setText('ppilli', inst);
  // render
  const out = [];
  const title = byId('title').value.trim();
  if(title) out.push(`<div class="muted">üéº <b>${title}</b></div><div class="sep"></div>`);
  items.forEach(it=>{
    const lineChord = semis ? transposeLineChords(it.chord, semis) : it.chord;
    const t = toMinSec(it.t + Number(byId('offset').value||0));
    const chordHtml = lineChord ? lineChord.split(/\s+/).map(c=>`<span class="chord">${c}</span>`).join(' ') : '';
    out.push(`<div><span class="muted">${t}</span> ‚Äî ${escapeHtml(it.text)} ${chordHtml}</div>`);
  });
  byId('preview').innerHTML = out.join('\n') || '<span class="muted">‚Äî Ch∆∞a c√≥ n·ªôi dung ‚Äî</span>';
}
function toMinSec(s){ s=Math.max(0,Math.floor(s)); return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }
function escapeHtml(x){ return x.replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s])) }

byId('btnCompile').addEventListener('click',compile);
['selKey','selProg','bpm','offset','lyrics','title'].forEach(id=>{
  byId(id).addEventListener('input', compile);
});
document.querySelectorAll('input[name="inst"]').forEach(r=>r.addEventListener('change',compile));
byId('btnAutoChord').addEventListener('click', autosuggest);

/* ---------- Export SVG (ƒë∆°n gi·∫£n) ---------- */
function exportSvg(){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1600">
  <style>
    .t{font:20px ui-monospace; fill:#dfe7ff}
    .m{fill:#0c1226}
    .c{font:18px ui-monospace; fill:#8ff5c9}
  </style>
  <rect class="m" x="0" y="0" width="1200" height="1600"/>
  <text x="40" y="60" class="t">PiChordify Sheet ‚Äî ${escapeHtml(byId('title').value||'')}</text>
  <foreignObject x="40" y="100" width="1120" height="1460">
    <div xmlns="http://www.w3.org/1999/xhtml" style="color:#dfe7ff;font:18px ui-monospace;white-space:pre-wrap;">${byId('preview').innerHTML.replaceAll('<span','\n<span')}</div>
  </foreignObject>
</svg>`;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([svg],{type:'image/svg+xml'}));
  a.download = (byId('title').value||'PiChordify') + '.svg';
  a.click();
}
byId('btnExportSvg').addEventListener('click', exportSvg);

/* ---------- Save / Load / Share ---------- */
function saveLocal(){
  const data = {
    title:byId('title').value, lyrics:byId('lyrics').value,
    key:byId('selKey').value, prog:byId('selProg').value,
    bpm:byId('bpm').value, offset:byId('offset').value,
    transpose:byId('transpose').value, inst:(document.querySelector('input[name="inst"]:checked')||{}).value||'guitar',
    audioUrl:byId('audioUrl').value
  };
  localStorage.setItem('pichordify_v71', JSON.stringify(data));
  log('ƒê√£ l∆∞u (local).','ok');
}
function loadLocal(){
  const s = localStorage.getItem('pichordify_v71'); if(!s) return log('Ch∆∞a c√≥ b·∫£n l∆∞u.');
  try{
    const d = JSON.parse(s);
    byId('title').value=d.title||''; byId('lyrics').value=d.lyrics||'';
    byId('selKey').value=d.key||'C'; byId('selProg').value=d.prog||'I‚ÄìV‚Äìvi‚ÄìIV';
    byId('bpm').value=d.bpm||80; byId('offset').value=d.offset||0;
    byId('transpose').value=d.transpose||0; setText('transposeLabel', d.transpose||0);
    (document.querySelector(`input[name="inst"][value="${d.inst||'guitar'}"]`)||{}).checked=true;
    byId('audioUrl').value=d.audioUrl||'';
    compile(); loadAudio();
    log('ƒê√£ load t·ª´ local.','ok');
  }catch(e){ log('Load l·ªói: '+e.message,'err'); }
}
function shareLink(){
  const d = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify({
    t:byId('title').value, l:byId('lyrics').value
  })))));
  const url = location.origin+location.pathname+'#s='+d;
  navigator.clipboard.writeText(url).then(()=> log('ƒê√£ copy share link.','ok'));
}
function tryOpenShared(){
  const m = location.hash.match(/#s=([^&]+)/);
  if(!m) return;
  try{
    const obj = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(m[1])))));
    byId('title').value=obj.t||''; byId('lyrics').value=obj.l||'';
    log('ƒê√£ m·ªü n·ªôi dung t·ª´ share link.','ok'); compile();
  }catch{}
}
byId('btnSave').addEventListener('click',saveLocal);
byId('btnLoad').addEventListener('click',loadLocal);
byId('btnShare').addEventListener('click',shareLink);

/* ---------- Wire Pi buttons ---------- */
byId('btnLogin').addEventListener('click', piLogin);
byId('btnCheck').addEventListener('click', checkPremium);
byId('btnPay').addEventListener('click', piPay);

/* ---------- boot ---------- */
window.addEventListener('load',()=>{
  primeAudioPolicy();
  initPi();
  compile();
  log('Ready.');
});
</script>
  <!-- Pi SDK (b·∫Øt bu·ªôc) -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<script>
/* ====== LOGGER: ghi ra m√†n h√¨nh + console ====== */
const $log = document.querySelector('#log, textarea#log, .log, [data-log]');
function log(...args){
  const line = `[${new Date().toLocaleTimeString()}] ` +
               args.map(x => (typeof x === 'string' ? x : JSON.stringify(x))).join(' ');
  if ($log){
    // h·ªó tr·ª£ c·∫£ <textarea> ho·∫∑c <div>
    if ($log.tagName === 'TEXTAREA') { $log.value += line + '\n'; $log.scrollTop = $log.scrollHeight; }
    else { $log.innerText += line + '\n'; $log.scrollTop = $log.scrollHeight; }
  }
  console.log(...args);
}
// B·∫Øt to√†n b·ªô l·ªói JS ƒë·ªÉ kh√¥ng ‚Äúch·∫øt l·∫∑ng‚Äù
window.onerror = (m, s, l, c, e)=>{ log('ERROR', m, s+':'+l, e?.stack||''); };
window.addEventListener('unhandledrejection', ev => { log('PROMISE REJECTION', ev.reason?.message||ev.reason); });

/* ====== PI SDK INIT ====== */
(async () => {
  try {
    // Sandbox: true ƒë·ªÉ test trong Hackathon (kh√¥ng t·ªën Pi th·∫≠t)
    await Pi.init({ version: '2.0', sandbox: true });
    log('Pi SDK: inited OK (v2, sandbox)');
  } catch (e) {
    log('Pi SDK: init FAILED ->', e.message);
  }
})();

/* ====== AUTH (Pi Login) ====== */
async function piLogin(){
  try {
    const scopes = ['payments','username','wallet_address']; // c·∫ßn thanh to√°n + th√¥ng tin c∆° b·∫£n
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
    log('Login OK:', { user: auth.user?.username, uid: auth.user?.uid });
    return auth;
  } catch(e){
    log('Login FAIL:', e.message);
  }
}

/* ====== PAYMENT (Pi Pay ‚Äì sandbox) ====== */
async function piPaySandbox(amount = 0.01){
  try {
    // ƒë·∫£m b·∫£o ƒë√£ login
    const auth = await piLogin();
    if (!auth) return;

    // metadata tu·ª≥ b·∫°n; developer_uid ch·ªâ l√† chu·ªói nh·∫≠n di·ªán ph√≠a server c·ªßa b·∫°n
    const payment = await Pi.createPayment({
      amount: String(amount),
      memo: 'PiChordify v7.1 sandbox test',
      metadata: { feature: 'premium_check', v: '7.1' },
      callbacks: {
        onReadyForServerApproval: (paymentId) => { log('onReadyForServerApproval', paymentId); },
        onReadyForServerCompletion: (paymentId, txid) => { log('onReadyForServerCompletion', paymentId, txid); },
        onCancel: (paymentId) => { log('onCancel', paymentId); },
        onError: (e) => { log('onError', e?.message||e); },
      },
      // (tu·ª≥ ch·ªçn) developer_uid: 'tran682025',
    });
    log('createPayment ->', payment);
  } catch(e){
    log('Payment FAIL:', e.message);
  }
}

/* ====== HANDLE INCOMPLETE PAYMENTS ====== */
function onIncompletePaymentFound(payment){
  log('onIncompletePaymentFound:', payment?.identifier || payment);
}

/* ====== G√ÅN S·ª∞ KI·ªÜN N√öT ====== */
/* ƒê·∫∑t id cho n√∫t trong HTML:
   <button id="btnPiLogin">Pi Login</button>
   <button id="btnPiPay">Pi Pay (sandbox)</button>
   <button id="btnCheckPremium">Ki·ªÉm tra Premium</button>
*/
document.getElementById('btnPiLogin')?.addEventListener('click', piLogin);
document.getElementById('btnPiPay')?.addEventListener('click', ()=>piPaySandbox(0.01));
document.getElementById('btnCheckPremium')?.addEventListener('click', ()=>log('Premium: demo only (sandbox)'));
</script>
<!-- ===== Pi SDK integration v2.0 sandbox ===== -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
async function initPiSDK() {
  try {
    await Pi.init({ version: "2.0", sandbox: true });
    log("‚úÖ Pi SDK initialized (sandbox mode)");
  } catch (e) {
    log("‚ùå Pi SDK init failed:", e.message);
  }
}

async function piLogin() {
  try {
    const scopes = ["payments", "username", "wallet_address"];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
    log("‚úÖ Login OK:", auth.user?.username || "(unknown)");
    return auth;
  } catch (e) {
    log("‚ùå Login error:", e.message);
  }
}

async function piPaySandbox(amount = 0.01) {
  try {
    const auth = await piLogin();
    if (!auth) return;
    const payment = await Pi.createPayment({
      amount: String(amount),
      memo: "PiChordify v7.1 sandbox test",
      metadata: { feature: "premium_check", version: "7.1" },
      callbacks: {
        onReadyForServerApproval: (pid) => log("ü™ô Ready for approval:", pid),
        onReadyForServerCompletion: (pid, txid) => log("‚úÖ Payment completed:", pid, txid),
        onCancel: (pid) => log("üö´ Payment canceled:", pid),
        onError: (err) => log("‚ö†Ô∏è Payment error:", err),
      },
    });
    log("createPayment ->", payment);
  } catch (e) {
    log("‚ùå Payment failed:", e.message);
  }
}

function onIncompletePaymentFound(payment) {
  log("‚ö†Ô∏è Incomplete payment found:", payment.identifier || payment);
}

// g√°n s·ª± ki·ªán cho c√°c n√∫t
document.getElementById("btnPiLogin")?.addEventListener("click", piLogin);
document.getElementById("btnPiPay")?.addEventListener("click", () => piPaySandbox(0.01));
document.getElementById("btnCheckPremium")?.addEventListener("click", () =>
  log("Premium check (sandbox demo)")
);

// kh·ªüi ƒë·ªông Pi SDK khi trang load
window.addEventListener("load", initPiSDK);
</script>

</body>
</html>
