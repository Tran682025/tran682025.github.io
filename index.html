<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tranmusickingdom Pi App [DEBUG]</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { margin: 10px; padding: 12px 20px; font-size: 16px; }
    #log { margin-top: 30px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto; background: #f5f5f5; padding: 15px; border-radius: 10px; font-size: 14px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>[DEBUG] Tranmusickingdom Pi App</h1>
  <button onclick="login()">ƒêƒÉng nh·∫≠p b·∫±ng Pi</button>
  <button onclick="pay()">Thanh to√°n 0.01 Pi</button>
  <div id="log">[LOG b·∫Øt ƒë·∫ßu...]\n</div>

  <script>
    let authUser = null; // L∆∞u k·∫øt qu·∫£ login

    function log(msg) {
      console.log(msg);
      document.getElementById("log").textContent += msg + "\n";
    }

    // B∆∞·ªõc 1: Init SDK
    log("üîÜ B∆∞·ªõc 1: ƒêang kh·ªüi t·∫°o Pi SDK...");
    try {
      Pi.init({ version: "2.0", sandbox: true });
      log("‚úÖ SDK kh·ªüi t·∫°o xong (sandbox: true)");
    } catch (e) {
      log("‚ùå L·ªói khi init Pi SDK: " + e);
    }

    // B∆∞·ªõc 2: Login
    function login() {
      log("‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Pi.authenticate()...");
      alert("B·∫Øt ƒë·∫ßu login...");
      Pi.authenticate(['username', 'payments'], (payment) => {
        log("üîÅ Incomplete payment: " + JSON.stringify(payment));
      })
      .then(auth => {
        authUser = auth;
        log("‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng: " + JSON.stringify(auth));
        alert("Xin ch√†o, " + auth.user.username);
      })
      .catch(err => {
        log("‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + err);
        alert("ƒêƒÉng nh·∫≠p l·ªói: " + err);
      });
    }

    // B∆∞·ªõc 3: Thanh to√°n
    function pay() {
      if (!authUser) {
        alert("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi thanh to√°n.");
        log("‚ùå Kh√¥ng th·ªÉ thanh to√°n: ch∆∞a login.");
        return;
      }

      log("‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu thanh to√°n th·ª≠...");
      alert("B·∫Øt ƒë·∫ßu thanh to√°n test...");

      const paymentData = {
        amount: 0.01,
        memo: "Test Pi Payment",
        metadata: { orderId: 314 }
      };

      try {
        Pi.createPayment(paymentData, {
          onReadyForServerApproval: (paymentId) => log("üü° Ch·ªù duy·ªát: " + paymentId),
          onReadyForServerCompletion: (paymentId, txid) => log("‚úÖ Thanh to√°n ho√†n t·∫•t: " + paymentId + " | txid: " + txid),
          onCancel: (paymentId) => log("‚ö™ H·ªßy thanh to√°n: " + paymentId),
          onError: (error, paymentId) => log("‚ùå L·ªói thanh to√°n: " + error + " | ID: " + paymentId)
        });
      } catch (e) {
        log("‚ùå L·ªói JS trong pay(): " + e);
      }
    }
  </script>
</body>
</html>
