<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PiChordify Kingdom ‚Äî v7.2.2</title>
  <style>
    :root{
      --bg:#0b1120; --card:#111827; --muted:#9ca3af; --pill:#8b5cf6;
      --text:#e5e7eb; --accent:#67e8f9; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --br:12px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto; color:var(--text);
         background:radial-gradient(1200px at 10% 0%,#1f2937 0%,#0b1120 62%,#060b16 100%)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .title{display:flex;align-items:center;gap:6px}
    .title .pill{background:#111827;border:1px solid #374151;color:#a78bfa;padding:4px 8px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid #374151;border-radius:var(--br);padding:12px}
    label{color:#9ca3af;font-size:.9rem}
    select,input,textarea,button{width:100%;padding:10px;border:1px solid #374151;border-radius:10px;background:#0f172a;color:var(--text)}
    textarea{min-height:140px;resize:vertical;line-height:1.4}
    button{background:#0ea5e9;cursor:pointer}
    .btn-accent{background:linear-gradient(135deg,#635bff,#00d4ff)}
    .btn-muted{background:#1f2937;color:#cbd5e1}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap}
    .mini{font-size:.9rem;color:#a1a1aa}
    .range{accent-color:#22d3ee}
    .right{display:grid;grid-template-rows:auto 1fr}
    .logbox{height:260px;overflow:auto;padding:10px;background:#0b1220;border:1px solid #334155;border-radius:10px}
    .footer{opacity:.75;margin-top:12px;text-align:center}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <h1 style="margin:0">PiChordify Kingdom</h1>
    <span class="pill">v7.2.2</span>
    <span class="pill">theme: t√≠m-ng·ªçc</span>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label for="selKey">Gi·ªçng (key)</label>
          <select id="selKey">
            <option>C</option><option>Db</option><option>D</option><option>Eb</option>
            <option>E</option><option>F</option><option>Gb</option><option>G</option>
            <option>Ab</option><option>A</option><option>Bb</option><option>B</option>
          </select>
        </div>
        <div style="flex:1">
          <label for="selProg">Ti·∫øn tr√¨nh</label>
          <select id="selProg">
            <option>I-V-vi-IV</option><option>vi-IV-I-V</option>
            <option>I-IV-V-I</option><option>ii-V-I</option>
          </select>
        </div>
        <button id="btnSuggest" style="width:auto">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
      </div>

      <div class="row" style="margin-top:12px">
        <div style="flex:1">
          <label for="title">Ti√™u ƒë·ªÅ</label>
          <input id="title" placeholder="T√™n b√†i"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div style="flex:1">
          <label for="lyrics">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî d·∫°ng: mm:ss   Em   /  D)</label>
          <textarea id="lyrics" placeholder="00:12   Em   /  D ..."></textarea>
        </div>
        <div style="flex:1">
          <label for="suggest">G·ª£i √Ω h·ª£p √¢m</label>
          <textarea id="suggest" readonly placeholder="Nh·∫•n 'T·ª± g·ª£i √Ω h·ª£p √¢m'..."></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card" style="flex:1">
          <label for="audioUrl">Audio (mp3)</label>
          <input id="audioUrl" placeholder="https://.../song.mp3"/>
          <div class="row" style="margin-top:8px">
            <button id="btnPlay" class="btn-muted" style="width:auto">Play</button>
            <button id="btnPause" class="btn-muted" style="width:auto">Pause</button>
            <button id="btnStop" class="btn-muted" style="width:auto">Stop</button>
            <span id="timeLbl" class="mini" style="margin-left:auto">0:00 / 0:00</span>
          </div>
          <input type="range" min="0" max="1000" value="0" id="progress" class="range"/>
          <div class="row">
            <div style="flex:1"><label for="bpm">BPM</label><input id="bpm" type="number" value="68"/></div>
            <div style="flex:1"><label for="offset">Offset (gi√¢y, ¬±)</label><input id="offset" type="number" value="0"/></div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card" style="flex:1">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="mini">Xu·∫•t/Nh·∫≠p</div>
            <span class="pill">L∆∞u c·ª•c b·ªô (localStorage)</span>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSave" class="btn-muted" style="width:auto">Save</button>
            <button id="btnLoad" class="btn-muted" style="width:auto">Load</button>
            <button id="btnShare" class="btn-accent" style="width:auto">Share link</button>
          </div>
        </div>
      </div>

      <div class="footer mini">¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù</div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">ƒêƒÉng nh·∫≠p & thanh to√°n</h3>
          <span class="pill">Sandbox</span>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnPiLogin" class="btn-muted" style="width:auto">Pi Login</button>
          <button id="btnPremium" class="btn-muted" style="width:auto">Ki·ªÉm tra Premium</button>
          <button id="btnPiPay" class="btn-accent" style="width:auto">Pi Pay (sandbox)</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="mini">Log</div>
          <span class="pill small">Console mirror</span>
        </div>
        <div id="log" class="logbox mono"></div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden audio element -->
<audio id="audio" preload="auto"></audio>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
/* ========= Helpers & Logger ========= */
const $ = (id)=>document.getElementById(id);
const logBox = $('log');
function log(...args){
  const t = new Date().toLocaleTimeString();
  const line = `[${t}] ` + args.map(x => typeof x==='string'? x : JSON.stringify(x)).join(' ');
  logBox.textContent += line + '\n';
  logBox.scrollTop = logBox.scrollHeight;
  console.log(...args);
}
window.onerror = (m, s, l, c, e)=>{ log('‚ùå', m, s+':'+l, e?.stack||''); };
window.addEventListener('unhandledrejection', ev=>log('‚ùå promise:', ev.reason?.message||ev.reason));

/* ========= Chords Engine ========= */
const KEYS = {
  C:['C','Dm','Em','F','G','Am','Bdim'],
  Db:['Db','Ebm','Fm','Gb','Ab','Bbm','Cdim'],
  D:['D','Em','F#m','G','A','Bm','C#dim'],
  Eb:['Eb','Fm','Gm','Ab','Bb','Cm','Ddim'],
  E:['E','F#m','G#m','A','B','C#m','D#dim'],
  F:['F','Gm','Am','Bb','C','Dm','Edim'],
  Gb:['Gb','Abm','Bbm','B','Db','Ebm','Fdim'],
  G:['G','Am','Bm','C','D','Em','F#dim'],
  Ab:['Ab','Bbm','Cm','Db','Eb','Fm','Gdim'],
  A:['A','Bm','C#m','D','E','F#m','G#dim'],
  Bb:['Bb','Cm','Dm','Eb','F','Gm','Adim'],
  B:['B','C#m','D#m','E','F#','G#m','A#dim'],
};
const DEG = { 'I':0,'ii':1,'iii':2,'IV':3,'V':4,'vi':5,'VII¬∞':6 };

function suggestChords(){
  const key = $('selKey').value;
  const prog = $('selProg').value;           // v√≠ d·ª•: I-V-vi-IV
  const bank = KEYS[key] || KEYS.C;
  const parts = prog.replace(/\s+/g,'').split(/[‚Äì\-]/g);
  const out = parts.map(p=>{
    const d = DEG[p] ?? null;
    return d==null ? '?' : bank[d];
  }).join(' ¬∑ ');
  $('suggest').value = `${key} major ¬∑ ${prog}\n${out}`;
  log('üéº suggest:', out);
}

/* ========= Audio Player ========= */
const audio = $('audio');
const progress = $('progress');
const timeLbl = $('timeLbl');

audio.addEventListener('timeupdate', ()=>{
  if(!isFinite(audio.duration)) return;
  progress.value = Math.floor(1000*audio.currentTime/audio.duration);
  timeLbl.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`;
});
audio.addEventListener('play', ()=>log('‚ñ∂Ô∏è AUDIO play'));
audio.addEventListener('pause', ()=>log('‚è∏ AUDIO pause'));
audio.addEventListener('stalled', ()=>log('üõë AUDIO stalled'));
audio.addEventListener('error', e=>log('‚ùå AUDIO error', audio.error?.code));

function fmt(n){ const m=Math.floor(n/60); const s=Math.floor(n%60).toString().padStart(2,'0'); return `${m}:${s}`; }
function setSrc(){
  try{
    const url = new URL(($('audioUrl').value||'').trim());
    audio.crossOrigin='anonymous';
    audio.src = url.href;
    audio.play().catch(()=>{ /* silent */ });
  }catch(e){ log('‚ùå setSrc', e.message); }
}

$('btnPlay').addEventListener('click', ()=>{ setSrc(); audio.play(); });
$('btnPause').addEventListener('click', ()=>audio.pause());
$('btnStop').addEventListener('click', ()=>{ audio.pause(); audio.currentTime=0; });

progress.addEventListener('input', ()=>{ if(isFinite(audio.duration)) audio.currentTime = (progress.value/1000)*audio.duration; });

/* ========= Save/Load/Share ========= */
const LSKEY='pichordify_state';
function stateOf(){
  return {
    title:$('title').value, key:$('selKey').value, prog:$('selProg').value,
    lyrics:$('lyrics').value, audioUrl:$('audioUrl').value,
    bpm:$('bpm').value, offset:$('offset').value,
  };
}
function apply(st){
  if(!st) return;
  $('title').value = st.title||'';
  $('selKey').value = st.key||'C';
  $('selProg').value = st.prog||'I-V-vi-IV';
  $('lyrics').value = st.lyrics||'';
  $('audioUrl').value = st.audioUrl||'';
  $('bpm').value = st.bpm||'68';
  $('offset').value = st.offset||'0';
}
$('btnSave').addEventListener('click', ()=>{ localStorage.setItem(LSKEY, JSON.stringify(stateOf())); log('üíæ save ok'); });
$('btnLoad').addEventListener('click', ()=>{ const st = JSON.parse(localStorage.getItem(LSKEY)||'null'); apply(st); log('üìÇ load ok'); });
$('btnShare').addEventListener('click', ()=>{
  const enc = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(stateOf())))));
  const url = location.origin+location.pathname+'#d='+enc;
  navigator.clipboard.writeText(url);
  log('üîó copied share link');
});
(function tryOpen(){
  const m = location.hash.match(/#d=([^#]+)/); if(!m) return;
  try{ const st = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(m[1]))))); apply(st); log('üîì open share ok'); }
  catch(e){ log('‚ùå open share', e.message); }
})();

/* ========= Pi SDK & Payments ========= */
function isPiBrowser(){
  // An to√†n: kh√¥ng crash khi Pi ch∆∞a inject
  const t = (typeof window!=='undefined' && 'Pi' in window) ? typeof window.Pi : 'undefined';
  return (t==='object' || t==='function') && !!(window.Pi?.isPiBrowser?.() ?? false);
}

async function initPi(){
  try{
    await Pi.init({ version:'2.0', sandbox:true });
    log('‚úÖ Pi SDK initialized (sandbox)');
  }catch(e){
    log('‚ùå Pi init:', e.message);
  }
  // KH√îNG kh√≥a n√∫t n·ªØa ‚Äì force sandbox test
  if(!isPiBrowser()){
    log('‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c Pi Browser ‚Äî v·∫´n cho ph√©p test sandbox.');
  }
}

async function piLogin(){
  try{
    const scopes=['payments','username','wallet_address'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
    log('üîê Login OK:', auth?.user?.username||'(unknown)');
    return auth;
  }catch(e){ log('‚ùå Login:', e.message); }
}

async function piPaySandbox(amount=0.01){
  try{
    const auth = await piLogin(); if(!auth) return;
    const pay = await Pi.createPayment({
      amount:String(amount),
      memo:'PiChordify v7.2.2 sandbox test',
      metadata:{feature:'premium', ver:'7.2.2'},
      callbacks:{
        onReadyForServerApproval:(pid)=>log('ü™ô readyForApproval', pid),
        onReadyForServerCompletion:(pid,txid)=>log('‚úÖ completed', pid, txid),
        onCancel:(pid)=>log('üö´ canceled', pid),
        onError:(err)=>log('‚ö†Ô∏è onError', err?.message||err),
      },
    });
    log('createPayment ->', pay);
  }catch(e){ log('‚ùå Payment:', e.message); }
}
function onIncompletePaymentFound(p){ log('‚ö†Ô∏è incomplete payment:', p?.identifier||p); }

/* ========= Wire UI ========= */
$('btnSuggest').addEventListener('click', suggestChords);
$('btnPiLogin').addEventListener('click', piLogin);
$('btnPiPay').addEventListener('click', ()=>piPaySandbox(0.01));
$('btnPremium').addEventListener('click', ()=>log('üîí Premium locked (demo sandbox)'));

/* ========= Boot ========= */
window.addEventListener('load', ()=>{
  suggestChords();
  initPi();
  log('üü£ Ready (Pi SDK loaded)');
});
</script>

<!-- √î test nhanh JS (v√≠ d·ª•: typeof Pi) -->
<input placeholder="Test JS (vd: typeof Pi)" onkeydown="if(event.key==='Enter'){try{log(eval(this.value))}catch(e){log('‚ùå',e.message)}}" style="width:100%;background:#111;color:#fff;font-size:14px;margin:10px 0"/>
</body>
</html>
