<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PiChordify Kingdom ‚Äî v7.2 (fresh)</title>

  <style>
    :root{
      --bg:#0b1120; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#7c3aed;
      --pill:#1f2937; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --pi:#a78bfa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b1120,#0c122b 45%,#0b1120); color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
    h1{margin:0 0 4px 0;font-size:40px;line-height:1.1}
    .tag{display:inline-block;background:var(--pill);padding:6px 10px;border-radius:999px;font-size:12px;color:#cbd5e1;margin-left:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    .card{background:rgba(17,24,39,.86);backdrop-filter:blur(6px);border:1px solid #23314d;border-radius:14px;padding:12px}
    label{font-size:12px;color:#9CA3AF}
    select,input,textarea,button{border:1px solid #334155;border-radius:10px;background:#0b1324;color:var(--text);padding:10px}
    input[type="number"]{width:90px}
    textarea{resize:vertical;min-height:140px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    button{cursor:pointer}
    .btn{padding:10px 14px}
    .btn-primary{background:linear-gradient(135deg,#4f46e5,#06b6d4);border:none}
    .btn-accent{background:linear-gradient(135deg,#7c3aed,#06b6d4);border:none}
    .btn-ghost{background:#0b1324}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap}
    .small{font-size:12px;color:#9CA3AF}
    .footer{opacity:.7;margin-top:8px}
    .pill{background:#111827;border:1px solid #23314d;color:#cbd5e1;border-radius:999px;padding:4px 8px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1324;border:1px solid #334155}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)} .pi{color:var(--pi)}
    .range{width:100%}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="col" style="gap:16px">
      <div>
        <h1>PiChordify Kingdom <span class="tag">v7.2</span></h1>
        <span class="pill">Theme: t√≠m-ng·ªçc</span>
      </div>

      <!-- Key & progression -->
      <div class="card grid">
        <div class="col">
          <label>Gi·ªçng (key)</label>
          <select id="selKey">
            <option>C</option><option>Db</option><option>D</option><option>Eb</option>
            <option>E</option><option>F</option><option>Gb</option><option>G</option>
            <option>Ab</option><option>A</option><option>Bb</option><option>B</option>
          </select>
        </div>
        <div class="col">
          <label>Ti·∫øn tr√¨nh</label>
          <select id="selProg">
            <option>I-V-vi-IV</option>
            <option>I-vi-IV-V</option>
            <option>ii-V-I</option>
            <option>I-IV-V-I</option>
            <option>vi-IV-I-V</option>
          </select>
        </div>
        <div class="col" style="grid-column:1/3">
          <button id="btnSuggest" class="btn btn-ghost">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
        </div>
      </div>

      <!-- Lyrics & suggestion -->
      <div class="card grid">
        <div class="col">
          <label>Ti√™u ƒë·ªÅ</label>
          <input id="title" placeholder="T√™n b√†i" />
          <label>L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî mm:ss  Em / D ...)</label>
          <textarea id="lyrics" placeholder="00:12  Em / D ‚Ä¶"></textarea>
        </div>
        <div class="col">
          <label>G·ª£i √Ω h·ª£p √¢m</label>
          <textarea id="suggest" readonly class="mono" placeholder="Nh·∫•n 'T·ª± g·ª£i √Ω h·ª£p √¢m'..."></textarea>
        </div>
      </div>

      <!-- Audio -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row">
            <label>Audio (mp3)</label>
          </div>
          <span class="small badge"><span>üîí</span><span id="badgePremium">Premium locked</span></span>
        </div>
        <input id="audioUrl" placeholder="https://‚Ä¶/song.mp3" />
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="btnPlay"  class="btn btn-ghost">Play</button>
          <button id="btnPause" class="btn btn-ghost">Pause</button>
          <button id="btnStop"  class="btn btn-ghost">Stop</button>
          <span id="timeLbl" class="small">0:00 / 0:00</span>
        </div>
        <input type="range" id="progress" min="0" max="1000" value="0" class="range" />
        <div class="row" style="margin-top:8px">
          <label>BPM</label><input id="bpm" type="number" value="68" />
          <label style="margin-left:12px">Offset (gi√¢y, ¬±)</label><input id="offset" type="number" value="0" />
        </div>
      </div>

      <!-- Save / Load -->
      <div class="card grid">
        <div class="row">
          <button id="btnSave" class="btn">Save</button>
          <button id="btnLoad" class="btn">Load</button>
          <button id="btnShare" class="btn btn-primary">Share link</button>
        </div>
        <div class="small">L∆∞u c·ª•c b·ªô (localStorage). ‚ÄúShare link‚Äù ch·ªâ hi·ªÉn th·ªã d·ªØ li·ªáu m√£ h√≥a trong URL.</div>
      </div>

      <div class="footer small">¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù</div>
    </div>

    <!-- RIGHT -->
    <div class="col" style="gap:16px">
      <!-- Auth & payments -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="lab">ƒêƒÉng nh·∫≠p & thanh to√°n</div>
          <span class="pill">Sandbox</span>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnPiLogin"  class="btn">Pi Login</button>
          <button id="btnPremium"  class="btn">Ki·ªÉm tra Premium</button>
          <button id="btnPiPay"    class="btn btn-accent">Pi Pay (sandbox)</button>
        </div>
      </div>

      <!-- Log -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="lab">Log</div>
          <span class="pill small">Console mirror</span>
        </div>
        <div id="log" class="mono" style="height:360px;overflow:auto;background:#0a1020;border:1px solid #23314d;border-radius:10px;padding:10px"></div>
      </div>
    </div>
  </div>

  <!-- Hidden audio -->
  <audio id="audio" preload="auto"></audio>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
  /* ===== Helpers & logger ===== */
  const $ = (id)=>document.getElementById(id);
  const logBox = $('log');
  function log(...args){
    const line = `[${new Date().toLocaleTimeString()}] ` + args.map(x=> typeof x==='string'?x:JSON.stringify(x)).join(' ');
    logBox.textContent += (logBox.textContent? '\n':'') + line;
    logBox.scrollTop = logBox.scrollHeight;
    console.log(...args);
  }
  window.onerror=(m,s,l,c,e)=>{ log('‚ùå', m, s+':'+l, e?.stack||''); }
  window.addEventListener('unhandledrejection', ev=>log('‚ùå promise:', ev.reason?.message||ev.reason));

  /* ===== Chords engine ===== */
  const KEYS = {
    C:  ['C','Dm','Em','F','G','Am','Bdim'],
    Db: ['Db','Ebm','Fm','Gb','Ab','Bbm','Cdim'],
    D:  ['D','Em','F#m','G','A','Bm','C#dim'],
    Eb: ['Eb','Fm','Gm','Ab','Bb','Cm','Ddim'],
    E:  ['E','F#m','G#m','A','B','C#m','D#dim'],
    F:  ['F','Gm','Am','Bb','C','Dm','Edim'],
    Gb: ['Gb','Abm','Bbm','B','Db','Ebm','Fdim'],
    G:  ['G','Am','Bm','C','D','Em','F#dim'],
    Ab: ['Ab','Bbm','Cm','Db','Eb','Fm','Gdim'],
    A:  ['A','Bm','C#m','D','E','F#m','G#dim'],
    Bb: ['Bb','Cm','Dm','Eb','F','Gm','Adim'],
    B:  ['B','C#m','D#m','E','F#','G#m','A#dim'],
  };
  const DEG = { 'I':0,'ii':1,'II':1,'iii':2,'III':2,'IV':3,'V':4,'vi':5,'VI':5,'vii¬∞':6,'VII¬∞':6 };

  function suggestChords(){
    const key = $('selKey').value;
    const prog = $('selProg').value;
    const bank = KEYS[key] || KEYS.C;
    const parts = prog.replace(/\s+/g,"").split(/[‚Äì-]/g);
    const out = parts.map(p=>{
      const d = DEG[p] ?? null;
      return d==null ? '?' : bank[d];
    }).join(' ¬∑ ');
    $('suggest').value = `${key} major ‚Ä¢ ${prog}\n‚Üí ${out}`;
    log('üéº suggest:', out);
  }

  /* ===== Audio player ===== */
  const audio = $('audio'), progress=$('progress'), timeLbl=$('timeLbl');
  function fmt(t){ const m=Math.floor(t/60), s=Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; }
  function setSrc(){
    const url=$('audioUrl').value.trim(); if(!url){audio.removeAttribute('src');return;}
    try{
      const clean=new URL(url).toString();
      audio.crossOrigin='anonymous'; audio.src=clean; audio.load();
      log('üéµ setSrc', clean);
    }catch(e){ log('‚ùå setSrc', e.message); }
  }
  audio.addEventListener('timeupdate', ()=>{
    if(!isFinite(audio.duration)) return;
    progress.value=Math.floor((audio.currentTime/audio.duration)*1000);
    timeLbl.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration||0)}`;
  });
  progress.addEventListener('input', ()=>{
    if(isFinite(audio.duration)) audio.currentTime = (progress.value/1000)*audio.duration;
  });

  $('btnPlay').addEventListener('click', ()=>{ setSrc(); audio.play().catch(e=>log('‚ùå play', e.message)); });
  $('btnPause').addEventListener('click', ()=>audio.pause());
  $('btnStop').addEventListener('click', ()=>{ audio.pause(); audio.currentTime=0; });

  /* ===== Save / Load / Share ===== */
  const LSKEY='pichordify_state';
  function stateGet(){
    return {
      title:$('title').value, key:$('selKey').value, prog:$('selProg').value,
      lyrics:$('lyrics').value, suggest:$('suggest').value,
      url:$('audioUrl').value, bpm:$('bpm').value, offset:$('offset').value,
    };
  }
  function apply(st){
    if(!st) return;
    $('title').value=st.title||'';
    $('selKey').value=st.key||'C';
    $('selProg').value=st.prog||'I-V-vi-IV';
    $('lyrics').value=st.lyrics||'';
    $('suggest').value=st.suggest||'';
    $('audioUrl').value=st.url||'';
    $('bpm').value=st.bpm||'68';
    $('offset').value=st.offset||'0';
  }
  $('btnSave').addEventListener('click', ()=>{ localStorage.setItem(LSKEY, JSON.stringify(stateGet())); log('üíæ save ok'); });
  $('btnLoad').addEventListener('click', ()=>{ const s=localStorage.getItem(LSKEY); if(s){ apply(JSON.parse(s)); log('üìÇ load ok'); }});
  $('btnShare').addEventListener('click', ()=>{
    const enc = encodeURIComponent( btoa( encodeURIComponent(JSON.stringify(stateGet())) ) );
    const url = location.origin+location.pathname+'#d='+enc;
    navigator.clipboard.writeText(url); log('üîó copied share link');
  });
  (function tryOpen(){
    const m = location.hash.match(/#d=(.+)$/); if(!m) return;
    try{ const obj=JSON.parse(decodeURIComponent(atob(decodeURIComponent(m[1])))); apply(obj); log('üîì open share link ok'); }
    catch(e){ log('‚ùå open share', e.message); }
  })();

  /* ===== Pi SDK & Payments ===== */
  function isPiBrowser(){ return typeof window.Pi !== 'undefined' && Pi?.isPiBrowser?.(); }
  async function initPi(){
    try{
      // Pi SDK global (script above) exposes window.Pi
      await Pi.init({ version:"2.0", sandbox:true });
      log('‚úÖ Pi SDK initialized (sandbox)');
      if(!isPiBrowser()){
        log('‚ö†Ô∏è H√£y m·ªü trang n√†y trong Pi Browser ƒë·ªÉ d√πng Pi Login / Pi Pay.');
        $('btnPiLogin').disabled = $('btnPiPay').disabled = true;
      }
    }catch(e){ log('‚ùå Pi init:', e.message); }
  }
  async function piLogin(){
    try{
      const scopes=['payments','username','wallet_address'];
      const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
      log('üîê Login OK:', auth.user?.username||'(unknown)');
      return auth;
    }catch(e){ log('‚ùå Login:', e.message); }
  }
  async function piPaySandbox(amount=0.01){
    try{
      const auth = await piLogin(); if(!auth) return;
      const pay = await Pi.createPayment({
        amount:String(amount),
        memo:'PiChordify v7.2 sandbox test',
        metadata:{feature:'premium', ver:'7.2'},
        callbacks:{
          onReadyForServerApproval:(pid)=>log('ü™ô readyForApproval', pid),
          onReadyForServerCompletion:(pid,txid)=>log('‚úÖ completed', pid, txid),
          onCancel:(pid)=>log('üö´ canceled', pid),
          onError:(err)=>log('‚ö†Ô∏è onError', err?.message||err),
        },
      });
      log('createPayment ->', pay);
    }catch(e){ log('‚ùå Payment', e.message); }
  }
  function onIncompletePaymentFound(p){ log('‚ö†Ô∏è incomplete payment:', p?.identifier||p); }

  // Wire UI
  $('btnSuggest').addEventListener('click', suggestChords);
  $('btnPiLogin').addEventListener('click', piLogin);
  $('btnPiPay').addEventListener('click', ()=>piPaySandbox(0.01));
  $('btnPremium').addEventListener('click', ()=>log('üîí Premium locked'));

  // Boot
  window.addEventListener('load', ()=>{
    suggestChords();
    initPi();
    log('üü£ Ready (Pi SDK loaded)');
  });
  </script>
</body>
</html>
