<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PiChordify Kingdom ‚Äî Premium Demo</title>
  <link rel="icon" href="data:,"/>

  <!-- Theme -->
  <style>
    :root{--pi:#7b2bf9;--ink:#261b39;--bg:#f7f3ff}
    *{box-sizing:border-box} html,body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
    .wrap{max-width:980px;margin:auto;padding:16px}
    h1{margin:12px 0 8px;color:#2d1b5a}
    .topbar{display:flex;align-items:center;gap:.75rem;padding:.6rem 1rem;background:#efe7ff;border-bottom:1px solid #e5d9ff;position:sticky;top:0;z-index:10}
    .brand{font-weight:800;color:var(--pi)} .grow{flex:1}
    .badge{background:#10b981;color:#fff;font-weight:700;border-radius:999px;padding:.2rem .6rem} .hidden{display:none} .muted{color:#6b7280}
    label{display:block;margin:10px 0;font-weight:600}
    input,textarea,button{font:inherit} input,textarea{width:100%;padding:.6rem;border:1px solid #d7d7e8;border-radius:.6rem;background:#fff}
    textarea{resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 200px 1fr;gap:12px}
    .actions{display:flex;flex-wrap:wrap;gap:12px;margin:12px 0} .group{display:flex;gap:8px;flex-wrap:wrap}
    button{border:1px solid #d9d9e7;background:#fff;padding:.55rem .9rem;border-radius:.7rem;cursor:pointer}
    button.primary{background:var(--pi);color:#fff;border-color:transparent}
    button.ghost{background:#fff;border:1px solid #e2e8f0} button[disabled]{opacity:.5;pointer-events:none}
    .out{background:#fff;border:1px dashed #d9d9e7;border-radius:.7rem;padding:.7rem;white-space:pre-wrap}
  </style>

  <!-- Pi SDK (th·∫≠t) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>Pi?.init?.({ version:"2.0" });</script>

  <!-- jsPDF (xu·∫•t PDF th·∫≠t) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">BUILD NEW CHORDIFY</div>
    <div class="grow"></div>
    <div id="premiumBadge" class="badge hidden">Premium</div>
    <button id="btnLogin"  type="button" class="ghost">ƒêƒÉng nh·∫≠p</button>
    <button id="btnLogout" type="button" class="ghost hidden">ƒêƒÉng xu·∫•t</button>
    <button id="btnBuyPremium" type="button" class="primary">Mua Premium</button>
  </header>

  <main class="wrap">
    <h1>PiChordify Kingdom ‚Äî Premium Demo</h1>
    <p>Nh·∫≠p b√†i + h·ª£p √¢m (m·ªói d√≤ng m·ªôt m·ª•c), r·ªìi <b>Export .srt</b> ho·∫∑c <b>PDF</b>.</p>

    <div class="grid">
      <label>Ti√™u ƒë·ªÅ b√†i h√°t
        <input id="titleEl" type="text" placeholder="V√≠ d·ª•: Hallelujah"/>
      </label>
      <label>Duration m·ªói m·ª•c (gi√¢y)
        <input id="durEl" type="number" min="0.1" step="0.1" value="2"/>
      </label>
      <label>ID hi·ªán h√†nh
        <input id="projIdEl" type="text" placeholder="auto-filled‚Ä¶"/>
      </label>
    </div>

    <label>L·ªùi/Chord (m·ªói d√≤ng m·ªôt m·ª•c)
      <textarea id="chartEl" rows="12" placeholder="Am
F
C
G
..."></textarea>
    </label>

    <section class="actions">
      <div class="group">
        <button id="btnSaveProject" type="button">G·ª≠i Save Project</button>
        <button id="btnOpenLast"   type="button">Open last (KV)</button>
        <button id="btnList"       type="button">Danh s√°ch Project</button>
      </div>

      <div class="group">
        <button id="btnDelete"  type="button" disabled>Xo√° Project</button>
        <button id="btnTrash"   type="button">Th√πng r√°c</button>
        <button id="btnRestore" type="button" disabled>Kh√¥i ph·ª•c</button>
        <button id="btnPurge"   type="button" disabled>Xo√° vƒ©nh vi·ªÖn</button>
      </div>

      <div class="group">
        <button id="btnExportSrt" type="button">Export .srt (hi·ªán t·∫°i)</button>
        <button id="btnExportPdf" type="button" class="primary" disabled>Export PDF (Premium)</button>
      </div>
    </section>

    <small id="idTip" class="muted">üí° H√£y <b>Save</b> tr∆∞·ªõc ƒë·ªÉ t·∫°o ID, r·ªìi m·ªõi Xo√°/Kh√¥i ph·ª•c/Export theo Project.</small>
    <pre id="out" class="out">S·∫µn s√†ng.</pre>
  </main>

  <!-- Logic all-in-one -->
  <script>
  // ====== CONFIG (ƒëi·ªÅn khi c√≥ backend th·∫≠t) ======
  const VERIFY_URL = ''; // v√≠ d·ª•: 'https://pichordify-worker.yourname.workers.dev/verify'

  // ====== Helpers / state
  const LS_USER='pchord.user', LS_PREM='pchord.premium', PREFIX='pchord.project.', TRASH='pchord.trash.';
  const $=(s,r=document)=>r.querySelector(s); const out=$('#out');
  const slug=s=>(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  const currentId=()=>$('#projIdEl')?.value?.trim()||localStorage.getItem('pchord.currId')||''; 
  const setCurrentId=id=>{localStorage.setItem('pchord.currId',id||''); if($('#projIdEl')) $('#projIdEl').value=id||''; uiRefresh();};
  const toast=m=>{out.textContent=m; console.log(m);};

  const getUser=()=>{try{return JSON.parse(localStorage.getItem(LS_USER)||'null')}catch{return null}};
  const setUser=u=>localStorage.setItem(LS_USER,JSON.stringify(u));
  const hasPrem=()=>localStorage.getItem(LS_PREM)==='1';
  const setPrem=v=>localStorage.setItem(LS_PREM,v?'1':'0');

  // ====== Init
  document.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('form').forEach(f=>f.addEventListener('submit',e=>e.preventDefault()));
    $('#btnLogin') .addEventListener('click',onLogin);
    $('#btnLogout').addEventListener('click',onLogout);
    $('#btnBuyPremium').addEventListener('click',onBuyPremium);

    $('#btnSaveProject').addEventListener('click',onSaveProject);
    $('#btnOpenLast').addEventListener('click',onOpenLast);
    $('#btnList')     .addEventListener('click',onList);

    $('#btnDelete').addEventListener('click',onDelete);
    $('#btnTrash') .addEventListener('click',onTrashList);
    $('#btnRestore').addEventListener('click',onRestore);
    $('#btnPurge')  .addEventListener('click',onPurge);

    $('#btnExportSrt').addEventListener('click',onExportSrt);
    $('#btnExportPdf').addEventListener('click',onExportPdf);

    uiRefresh();
  });

  function uiRefresh(){
    const user=getUser(), premium=hasPrem(), hasId=!!currentId();
    $('#premiumBadge').classList.toggle('hidden',!premium);
    $('#btnBuyPremium').toggleAttribute('disabled', premium);
    $('#btnLogin').classList.toggle('hidden',!!user);
    $('#btnLogout').classList.toggle('hidden',!user);
    ['#btnDelete','#btnRestore','#btnPurge'].forEach(sel=>$(sel)?.toggleAttribute('disabled',!hasId));
    $('#btnExportPdf').toggleAttribute('disabled',!premium);
    $('#idTip')?.classList.toggle('hidden',hasId);
  }

  // ====== Auth (Pi SDK th·∫≠t c√≥ fallback)
  async function onLogin(){
    try{
      if(window.Pi && Pi.authenticate){
        const scopes=['username','payments'];
        const user = await Pi.authenticate(scopes, (p)=>console.log('incomplete payment',p));
        setUser({username:user.username, uid:user.uid}); 
        toast(`Xin ch√†o, ${user.username}!`);
      }else{
        setUser({username:'Tranmarket', uid:'demo-'+Date.now()});
        toast('Pi SDK kh√¥ng s·∫µn: d√πng login demo.');
      }
    }catch(e){ toast('ƒêƒÉng nh·∫≠p l·ªói: '+e.message); }
    uiRefresh();
  }
  function onLogout(){ localStorage.removeItem(LS_USER); setPrem(false); toast('ƒê√£ ƒëƒÉng xu·∫•t.'); uiRefresh(); }

  // ====== Buy Premium (Pi SDK + verify; fallback demo n·∫øu ch∆∞a c√≥ backend)
  async function onBuyPremium(){
    const u=getUser(); if(!u){ toast('H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc.'); return; }
    try{
      if(window.Pi && Pi.createPayment){
        const res = await Pi.createPayment({ amount:1, memo:'PiChordify Premium', metadata:{plan:'premium-1m'} }, {
          onReadyForServerApproval: async (paymentId)=>{
            if(VERIFY_URL){
              await fetch(VERIFY_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId})});
            }
          },
          onReadyForServerCompletion:(paymentId,txid)=>{},
          onCancel:()=>toast('ƒê√£ hu·ª∑ thanh to√°n'), onError:(err)=>toast('L·ªói thanh to√°n: '+err)
        });
        if(!VERIFY_URL){
          setPrem(true); toast('Premium DEMO b·∫≠t (ch∆∞a c·∫•u h√¨nh VERIFY_URL).');
        }else{
          // ·ªû b·∫£n th·∫≠t: backend tr·∫£ v·ªÅ token r·ªìi m·ªõi setPrem(true).
          setPrem(true); toast('Premium ƒë√£ k√≠ch ho·∫°t (gi·∫£ l·∫≠p).');
        }
      }else{
        // kh√¥ng c√≥ Pi SDK ‚Üí b·∫≠t demo
        setPrem(true); toast('Premium DEMO b·∫≠t (kh√¥ng c√≥ Pi SDK).');
      }
    }catch(e){ toast('Mua Premium l·ªói: '+e.message); }
    uiRefresh();
  }

  // ====== Project (localStorage)
  function read(id){return JSON.parse(localStorage.getItem(PREFIX+id)||'null')}
  function write(rec){localStorage.setItem(PREFIX+rec.id,JSON.stringify(rec))}
  function del(id){const r=read(id); if(r){localStorage.setItem(TRASH+id,JSON.stringify(r)); localStorage.removeItem(PREFIX+id);}}
  function purge(id){localStorage.removeItem(PREFIX+id); localStorage.removeItem(TRASH+id);}
  function onSaveProject(){
    const title=$('#titleEl').value.trim()||'Untitled', raw=$('#chartEl').value||'';
    let id=currentId(); if(!id) id=`${slug(title)||'untitled'}-${Date.now().toString(36)}`;
    const rec={id,title,raw,ts:Date.now()}; write(rec); setCurrentId(id); localStorage.setItem('pchord.last',id);
    toast(`ƒê√£ l∆∞u: ${title}\nID: ${id}`);
  }
  function onOpenLast(){
    const id=localStorage.getItem('pchord.last'); if(!id){toast('Ch∆∞a c√≥ b·∫£n l∆∞u n√†o.'); return;}
    const rec=read(id); if(!rec){toast('Kh√¥ng t√¨m th·∫•y project.'); return;}
    $('#titleEl').value=rec.title; $('#chartEl').value=rec.raw; setCurrentId(rec.id); toast('ƒê√£ m·ªü b·∫£n g·∫ßn nh·∫•t.');
  }
  function onList(){
    const keys=Object.keys(localStorage).filter(k=>k.startsWith(PREFIX));
    if(!keys.length){toast('Ch∆∞a c√≥ project n√†o.'); return;}
    const list=keys.map(k=>JSON.parse(localStorage.getItem(k))).sort((a,b)=>b.ts-a.ts);
    const pick=prompt('Ch·ªçn ID:\n'+list.map(x=>`${x.id} ‚Äî ${x.title}`).join('\n'));
    if(pick){const rec=read(pick); if(rec){$('#titleEl').value=rec.title; $('#chartEl').value=rec.raw; setCurrentId(rec.id); toast('ƒê√£ m·ªü '+rec.title);}}
  }
  function onDelete(){const id=currentId(); if(!id){toast('Ch∆∞a c√≥ ID.'); return;} del(id); setCurrentId(''); toast('ƒê√£ ƒë∆∞a v√†o Th√πng r√°c.');}
  function onTrashList(){
    const keys=Object.keys(localStorage).filter(k=>k.startsWith(TRASH));
    if(!keys.length){toast('Th√πng r√°c tr·ªëng.'); return;}
    const list=keys.map(k=>JSON.parse(localStorage.getItem(k)));
    toast('Trong th√πng r√°c:\n'+list.map(x=>`${x.id} ‚Äî ${x.title}`).join('\n'));
  }
  function onRestore(){const id=currentId(); if(!id){toast('Ch∆∞a c√≥ ID.'); return;}
    const rec=JSON.parse(localStorage.getItem(TRASH+id)||'null'); if(!rec){toast('Kh√¥ng c√≥ trong th√πng r√°c.'); return;}
    write(rec); localStorage.removeItem(TRASH+id); toast('ƒê√£ kh√¥i ph·ª•c.');
  }
  function onPurge(){const id=currentId(); if(!id){toast('Ch∆∞a c√≥ ID.'); return;} purge(id); setCurrentId(''); toast('ƒê√£ xo√° vƒ©nh vi·ªÖn.');}

  // ====== Export
  function parseLines(text,dur){ const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    return lines.map((line,i)=>({i:i+1,t:i*dur,d:dur,text:line})); }
  function fmtTs(sec){ const s=Math.max(0,Math.floor(sec)),ms=Math.round((sec-s)*1000);
    const hh=String(Math.floor(s/3600)).padStart(2,'0'), mm=String(Math.floor((s%3600)/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'), mss=String(ms).padStart(3,'0');
    return `${hh}:${mm}:${ss},${mss}`;}
  function download(name,blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

  async function onExportSrt(){
    const title=$('#titleEl').value.trim()||'Chord Sheet', dur=Number($('#durEl').value||2), raw=$('#chartEl').value||'';
    const items=parseLines(raw,dur); if(!items.length){toast('Kh√¥ng th·∫•y d√≤ng h·ª£p l·ªá.'); return;}
    const srt=items.map((it,idx)=>`${idx+1}\n${fmtTs(it.t)} --> ${fmtTs(it.t+it.d)}\n${it.text}\n`).join('\n');
    download(`${title}.srt`, new Blob([srt],{type:'text/plain;charset=utf-8'})); toast('ƒê√£ t·∫£i .srt');
  }

  async function onExportPdf(){
    if(!hasPrem()){toast('T√≠nh nƒÉng PDF d√†nh cho Premium.'); return;}
    const title=$('#titleEl').value.trim()||'Chord Sheet', dur=Number($('#durEl').value||2), raw=$('#chartEl').value||'';
    const items=parseLines(raw,dur); if(!items.length){toast('Kh√¥ng th·∫•y d√≤ng h·ª£p l·ªá.'); return;}
    const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'}); const W=595,H=842,M=42,rowH=22;
    const col={idx:40,idxW:30,ts:80,tsW:110,txt:200,txtW:W-M-200}; let page=1,y=M+56;
    function header(){ doc.setFont('Helvetica','bold'); doc.setFontSize(18); doc.text(title,M,M+18);
      doc.setFont('Helvetica','normal'); doc.setFontSize(10); doc.text(`Generated by PiChordify ‚Ä¢ ${new Date().toLocaleString()}`,M,M+34);
      doc.setDrawColor(220); doc.line(M,M+40,W-M,M+40); }
    function footer(){ doc.setFontSize(10); doc.setTextColor(120); doc.text(`Page ${page}`,W-M-50,H-M+14); }
    function tableHeader(){ doc.setFont('Helvetica','bold'); doc.setFontSize(12); doc.setFillColor(245,240,255); doc.setDrawColor(220);
      doc.roundedRect(M,y,W-2*M,rowH,4,4,'FD'); doc.text('#',M+col.idx,y+15); doc.text('Timestamp',M+col.ts,y+15); doc.text('Lyric / Chord',M+col.txt,y+15); y+=rowH; }
    function newPage(){ if(page>1){footer(); doc.addPage();} header(); tableHeader(); }
    newPage(); doc.setFont('Courier','normal'); doc.setFontSize(11); doc.setDrawColor(230);
    items.forEach((it,i)=>{ if(y>H-M-20){page++; y=M+56; newPage();}
      if(i%2===1){ doc.setFillColor(252,250,255); doc.rect(M,y,W-2*M,rowH,'F'); }
      doc.setTextColor(60); doc.text(String(it.i||i+1),M+col.idx,y+15);
      doc.text(`${fmtTs(it.t)} ‚Üí ${fmtTs(it.t+it.d)}`,M+col.ts,y+15);
      const lines=doc.splitTextToSize(it.text||' ',col.txtW-10);
      lines.forEach((ln,k)=>{ if(y>H-M-20){page++; y=M+56; newPage();} doc.text(ln,M+col.txt,y+15);
        if(k<lines.length-1){ y+=rowH; if(i%2===1){doc.setFillColor(252,250,255); doc.rect(M,y,W-2*M,rowH,'F');}}
      });
      doc.setDrawColor(235); doc.line(M,y+rowH,W-M,y+rowH); y+=rowH;
    });
    footer(); doc.save(`${title}.pdf`); toast('ƒê√£ t·∫£i PDF ‚Äúƒë·∫πp‚Äù ‚úÖ');
  }
  </script>
</body>
</html>
