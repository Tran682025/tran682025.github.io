<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PiChordify Kingdom ‚Äî v7.5</title>

<style>
:root{
  --bg:#0b1022; --panel:#121933; --ink:#eaf0ff; --muted:#aab4cf;
  --accent1:#8b5cf6; --accent2:#22d3ee; --line:#26304d;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:15px/1.55 system-ui,Segoe UI,Roboto,Inter,Arial;
  color:var(--ink); background:radial-gradient(1200px 900px at 10% 0%,#1b1f3f 0,#0b1022 60%);
  letter-spacing:.2px;
}
.wrap{max-width:1080px;margin:36px auto;padding:0 16px}
h1{margin:0 0 10px;font-size:48px;line-height:.95;font-weight:800;letter-spacing:.5px}
.badge{display:inline-block;margin-left:10px;padding:.25rem .6rem;border-radius:999px;background:#1b1037;color:#c7b9ff;border:1px solid #2e2355;font-size:14px}
.topbar{display:flex;gap:12px;align-items:center;margin:8px 0 18px}

.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:18px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.col{display:flex;flex-direction:column;gap:6px}
label{color:var(--muted);font-size:13px}
input[type=text],select,textarea{
  width:100%;background:#0f1530;border:1px solid #26304d;color:var(--ink);
  border-radius:12px;padding:10px 12px;outline:none
}
textarea{min-height:180px;resize:vertical}
kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,monospace;color:#bcc7e7}

.btn{
  background:linear-gradient(120deg,var(--accent1),var(--accent2));
  border:1px solid #38446a;color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer;
  font-weight:600; letter-spacing:.2px; box-shadow:0 6px 22px rgba(0,0,0,.25);
}
.btn:disabled{cursor:not-allowed; opacity:.7; color:#e6ecff; background:#2c3140; border-color:#404758}
.btn.alt{background:#202844}
.btn.ghost{background:#0f1530;border-color:#334059}
.btn.solid{background:#334059}

.switcher{display:flex;gap:10px}
.switcher .opt{
  flex:1;display:flex;align-items:center;gap:10px;justify-content:flex-start;
  padding:12px 14px;border-radius:14px;background:#0f1530;border:1px solid #2b3554;
  cursor:pointer; user-select:none; font-weight:600;
}
.switcher .opt.active{outline:2px solid #6753f7;border-color:#6753f7;background:#171c3a}
.switcher .opt .ico{font-size:18px;opacity:.85}

.stack{display:grid;gap:12px}
.inline{display:flex;gap:10px;align-items:center}
.small{font-size:13px;color:#aab4cf}

#log{background:#0b1526;border-radius:14px;padding:12px;font:14px/1.5 ui-monospace,Consolas,monospace;border:1px solid #24314e;white-space:pre-wrap;min-height:150px}
.mono{font:14px/1.55 ui-monospace,Consolas,monospace}
.mini{font-size:12px;color:#90a2c7}

.footer{color:#7e8bb0;text-align:center;margin-top:12px}
.footer .brand{display:inline-flex;align-items:center;gap:8px}
.logoPi{width:28px;height:28px;vertical-align:middle}
hr.sep{border:0;border-top:1px dashed #2a3554;margin:6px 0 14px}

.filewrap{display:flex;gap:10px; align-items:center}
input[type="file"]{display:none}
.filewrap label{display:inline-flex;gap:10px;align-items:center}
.filebtn{padding:10px 14px;border-radius:12px;background:#0f1530;border:1px solid #2b3554;color:#eaf0ff;cursor:pointer}
.filebtn:hover{border-color:#3c4b74}

.bad{color:var(--err)} .ok{color:var(--ok)} .warn{color:var(--warn)}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <h1>PiChordify Kingdom</h1>
    <span class="badge">v7.5</span>
  </div>

  <div class="grid">
    <!-- LEFT: Composer -->
    <div class="card stack">

      <div class="row">
        <div class="col" style="flex:1">
          <label>Nh·∫°c c·ª•</label>
          <div class="switcher" id="insts">
            <div class="opt active" data-inst="piano"><span class="ico">üéπ</span>Piano</div>
            <div class="opt" data-inst="guitar"><span class="ico">üé∏</span>Guitar</div>
            <div class="opt" data-inst="uke"><span class="ico">ü™ï</span>Ukulele</div>
          </div>
          <div class="mini" id="instName">Piano</div>
        </div>

        <div class="col" style="width:180px">
          <label>Gi·ªçng (key)</label>
          <select id="selKey">
            <option>C</option><option>Db</option><option>D</option><option>Eb</option><option>E</option>
            <option>F</option><option>Gb</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
          </select>
        </div>

        <div class="col" style="width:220px">
          <label>Ti·∫øn tr√¨nh</label>
          <select id="selProg">
            <option>I‚ÄìV‚Äìvi‚ÄìIV</option>
            <option>vi‚ÄìIV‚ÄìI‚ÄìV</option>
            <option>I‚Äìvi‚ÄìIV‚ÄìV</option>
            <option>ii‚ÄìV‚ÄìI‚Äìvi</option>
            <option>12-bar</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1">
          <label>Ti√™u ƒë·ªÅ</label>
          <input id="title" type="text" placeholder="T√™n b√†i"/>
        </div>
        <div class="col" style="width:180px">
          <label>&nbsp;</label>
          <button id="btnSuggest" class="btn" title="G·ª£i √Ω h·ª£p √¢m">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1">
          <label>L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî d·∫°ng: mm:ss Em / D)</label>
          <textarea id="lyrics" placeholder="00:12   Em / D ..."></textarea>
        </div>
        <div class="col" style="flex:1">
          <label>G·ª£i √Ω h·ª£p √¢m</label>
          <textarea id="suggest" class="mono" readonly>Nh·∫•n 'T·ª± g·ª£i √Ω h·ª£p √¢m'‚Ä¶</textarea>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1">
          <label>Audio (mp3)</label>
          <div class="filewrap">
            <input id="fileMp3" type="file" accept="audio/mpeg"/>
            <button id="btnPick" class="filebtn">üìÇ Ch·ªçn file mp3</button>
            <input id="audioUrl" type="text" placeholder="https://‚Ä¶/song.mp3"/>
            <button id="btnLoadAudio" class="btn ghost">Load</button>
          </div>
          <div class="inline" style="margin-top:8px">
            <button id="btnPlay" class="btn solid">Play</button>
            <button id="btnPause" class="btn alt">Pause</button>
            <button id="btnStop" class="btn alt">Stop</button>
            <span class="mini" id="time">0:00 / 0:00</span>
          </div>
          <input id="progress" type="range" min="0" max="1000" value="0" style="width:100%;margin-top:8px"/>
          <div class="inline">
            <div class="col" style="width:120px">
              <label class="small">BPM</label>
              <input id="bpm" type="text" value="68"/>
            </div>
            <div class="col" style="width:160px">
              <label class="small">Offset (gi√¢y, ¬±)</label>
              <input id="offset" type="text" value="0"/>
            </div>
          </div>
        </div>

        <div class="col" style="width:280px">
          <label>L∆∞u c·ª•c b·ªô (localStorage). ‚ÄúShare link‚Äù ch·ªâ hi·ªÉn th·ªã d·ªØ li·ªáu m√£ h√≥a trong URL.</label>
          <div class="stack">
            <button id="btnSave" class="btn alt">Save</button>
            <button id="btnLoad" class="btn alt">Load</button>
            <button id="btnShare" class="btn">Share link</button>
          </div>
        </div>
      </div>

      <div class="footer mini">
        <span class="brand">
          <!-- Pi logo -->
          <svg class="logoPi" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-label="Pi logo">
            <defs><linearGradient id="pi-g" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="#8b5cf6"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs>
            <rect width="64" height="64" rx="14" fill="#1b1037"/>
            <circle cx="32" cy="32" r="23" fill="url(#pi-g)" opacity=".25"/>
            <path d="M19 25a3 3 0 0 1 0-6h26a3 3 0 0 1 0 6h-6v18a4 4 0 1 1-8 0V25h-4v18a4 4 0 1 1-8 0V25h-.1z" fill="#c7b9ff"/>
          </svg>
          ¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù
        </span>
      </div>
    </div>

    <!-- RIGHT: Auth & Payments -->
    <div class="card stack">
      <div class="inline" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">ƒêƒÉng nh·∫≠p & thanh to√°n</h3>
        <span class="badge">Sandbox</span>
      </div>
      <div class="row">
        <button id="btnPiLogin" class="btn ghost" disabled>Pi Login</button>
        <button id="btnCheckPrem" class="btn alt" disabled>Ki·ªÉm tra Premium</button>
        <button id="btnPiPay" class="btn" disabled>Pi Pay (sandbox)</button>
      </div>
      <div>
        <label>Log</label>
        <div id="log" class="mono"></div>
        <div class="mini">Console mirror ‚Äî copy/paste ƒë∆∞·ª£c.</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Hidden audio element ===== -->
<audio id="audio" preload="auto"></audio>

<!-- ===== Pi SDK ===== -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<script>
/* ===== Helpers ===== */
const $ = (id) => document.getElementById(id);
const logBox = $('log');
function log(...args){
  const t = new Date().toLocaleTimeString();
  const line = `[${t}] ` + args.map(x => typeof x==='string'? x : JSON.stringify(x)).join(' ');
  logBox.textContent = (logBox.textContent? logBox.textContent + '\n' : '') + line;
  logBox.scrollTop = logBox.scrollHeight;
  console.log(...args);
}
window.onerror = (m,s,l,c,e)=>{ log('‚ùå', m, s+':'+l, e?.stack||''); };
window.addEventListener('unhandledrejection', ev=>log('‚ùå promise:', ev.reason?.message||ev.reason));

/* ====== Instruments (affects voicing hint only) ====== */
let INSTRUMENT = 'piano';
$('insts').addEventListener('click', (e)=>{
  const opt = e.target.closest('.opt'); if(!opt) return;
  [...$('insts').children].forEach(n=>n.classList.remove('active'));
  opt.classList.add('active');
  INSTRUMENT = opt.dataset.inst;
  $('instName').textContent = (INSTRUMENT==='guitar'?'Guitar':INSTRUMENT==='uke'?'Ukulele':'Piano');
  log('üéöÔ∏è instrument:', INSTRUMENT);
});

/* ====== Chords Engine ====== */
const KEYS = {
  C:['C','Dm','Em','F','G','Am','Bdim'], Db:['Db','Ebm','Fm','Gb','Ab','Bbm','Cdim'],
  D:['D','Em','F#m','G','A','Bm','C#dim'], Eb:['Eb','Fm','Gm','Ab','Bb','Cm','Ddim'],
  E:['E','F#m','G#m','A','B','C#m','D#dim'], F:['F','Gm','Am','Bb','C','Dm','Edim'],
  Gb:['Gb','Abm','Bbm','B','Db','Ebm','Fdim'], G:['G','Am','Bm','C','D','Em','F#dim'],
  Ab:['Ab','Bbm','Cm','Db','Eb','Fm','Gdim'], A:['A','Bm','C#m','D','E','F#m','G#dim'],
  Bb:['Bb','Cm','Dm','Eb','F','Gm','Adim'], B:['B','C#m','D#m','E','F#','G#m','A#dim'],
};
const DEG = {'I':0,'ii':1,'iii':2,'IV':3,'V':4,'vi':5,'VII¬∞':6};

function parseProg(s){
  if(s==='12-bar') return ['I','I','I','I','IV','IV','I','I','V','IV','I','V'];
  return s.split(/[\s‚Äì-]+/g);
}
function suggestChords(){
  const key = $('selKey').value;
  const degs = parseProg($('selProg').value);
  const bank = KEYS[key] || KEYS.C;
  const out = degs.map(d=>{
    if(d==='') return '';
    if(d.toLowerCase()==='vi') return bank[5];
    if(d.toLowerCase()==='ii') return bank[1];
    if(d.toLowerCase()==='iii') return bank[2];
    if(d.toUpperCase()==='IV') return bank[3];
    if(d.toUpperCase()==='V') return bank[4];
    if(d.toUpperCase()==='I') return bank[0];
    return bank[0];
  });
  const voicing = INSTRUMENT==='guitar'?'(voicing: open shapes)':
                  INSTRUMENT==='uke'   ?'(voicing: C6 tuning)'    :
                                         '(voicing: triads)';
  $('suggest').value = `${key} major ¬∑ ${$('selProg').value}\n` + out.join(' ¬∑ ') + `\n${voicing}`;
  log('üéº suggest:', out.join(' ¬∑ '));
}

/* ====== Save/Load/Share ====== */
const LSKEY = 'pichordify_state_v75';
function stateObj(){
  return {
    title:$('title').value, key:$('selKey').value, prog:$('selProg').value,
    lyrics:$('lyrics').value, suggest:$('suggest').value,
    audioUrl:$('audioUrl').value, bpm:$('bpm').value, offset:$('offset').value,
    inst:INSTRUMENT,
  };
}
function applyState(o){
  if(!o) return;
  $('title').value = o.title||'';
  $('selKey').value = o.key||'C';
  $('selProg').value = o.prog||'I‚ÄìV‚Äìvi‚ÄìIV';
  $('lyrics').value = o.lyrics||'';
  $('suggest').value = o.suggest||'';
  $('audioUrl').value = o.audioUrl||'';
  $('bpm').value = o.bpm||'68';
  $('offset').value = o.offset||'0';
  if(o.inst){ INSTRUMENT=o.inst; [...$('insts').children].forEach(n=>n.classList.toggle('active', n.dataset.inst===INSTRUMENT)); $('instName').textContent = INSTRUMENT==='guitar'?'Guitar':INSTRUMENT==='uke'?'Ukulele':'Piano';}
}
$('btnSave').addEventListener('click', ()=>{
  localStorage.setItem(LSKEY, JSON.stringify(stateObj()));
  log('üíæ saved');
});
$('btnLoad').addEventListener('click', ()=>{
  const o = JSON.parse(localStorage.getItem(LSKEY)||'null');
  if(!o) return log('‚ö†Ô∏è ch∆∞a c√≥ g√¨ ƒë·ªÉ load');
  applyState(o); log('üì• loaded');
});
$('btnShare').addEventListener('click', ()=>{
  const enc = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(stateObj())))));
  const url = location.origin+location.pathname+'#d='+enc;
  navigator.clipboard.writeText(url);
  log('üîó copied share link');
});
(function tryOpen(){
  const m = location.hash.match(/d=([^&]+)/); if(!m) return;
  try{
    const o = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(m[1])))));
    applyState(o); log('üîì opened from share link');
  }catch(e){ log('‚ùå open share', e?.message||e); }
})();

/* ====== Audio ====== */
const audio = $('audio');
function sec(n){ return Math.max(0, Number(n)||0); }
function fmt(t){ t=Math.max(0,Math.floor(t)); const m=Math.floor(t/60), s=t%60; return `${m}:${String(s).padStart(2,'0')}`; }

$('btnPick').addEventListener('click', ()=> $('fileMp3').click());
$('fileMp3').addEventListener('change', ()=>{
  const f = $('fileMp3').files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  $('audioUrl').value = url; loadAudio();
});
$('btnLoadAudio').addEventListener('click', loadAudio);
function loadAudio(){
  const url = $('audioUrl').value.trim(); if(!url) return;
  audio.src = url; audio.load(); audio.play().catch(()=>{});
}
$('btnPlay').addEventListener('click', ()=> audio.play());
$('btnPause').addEventListener('click', ()=> audio.pause());
$('btnStop').addEventListener('click', ()=> { audio.pause(); audio.currentTime = 0; });

audio.addEventListener('timeupdate', ()=>{
  $('time').textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration||0)}`;
  $('progress').value = ((audio.currentTime/(audio.duration||1))*1000)|0;
});
$('progress').addEventListener('input', ()=>{
  if(!isFinite(audio.duration)) return;
  audio.currentTime = (Number($('progress').value)/1000)*(audio.duration||0);
});

/* ====== Pi SDK & Payments (sandbox) ====== */
async function initPi(){
  try{
    await Pi.init({ version:'2.0', sandbox:true });
    log('üü£ Ready (Pi SDK loaded)');
    log('‚úÖ Pi SDK initialized (sandbox)');

    // b·∫≠t n√∫t
    ['btnPiLogin','btnPiPay','btnCheckPrem'].forEach(id=>$(id).removeAttribute('disabled'));

    // nh·∫≠n di·ªán Pi Browser (UA cho ch·∫Øc)
    const ua = (navigator.userAgent||'').toLowerCase();
    const inPiBrowser = ua.includes('pibrowser');
    if(!inPiBrowser){
      log('‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c Pi Browser ‚Äî v·∫´n cho ph√©p test sandbox.');
    }
  }catch(e){
    log('‚ùå Pi init', e?.message||e);
  }
}

async function piLogin(){
  log('üëÜ click: Pi Login');
  try{
    const scopes = ['payments','username','wallet_address'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
    log('üîê Login OK:', auth?.user?.username || '(unknown)');
    return auth;
  }catch(e){
    log('‚ùå Login', e?.message||e);
  }
}

async function piPaySandbox(amount=0.01){
  log('üëÜ click: Pi Pay (sandbox)');
  try{
    const auth = await piLogin(); if(!auth){ log('üîí Ch∆∞a login, h·ªßy thanh to√°n.'); return; }
    const pay = await Pi.createPayment({
      amount: String(amount),
      memo: 'PiChordify v7.5 sandbox test',
      metadata: { feature:'premium', ver:'7.5' },
      callbacks:{
        onReadyForServerApproval: (pid)=>log('ü™ô readyForApproval', pid),
        onReadyForServerCompletion: (pid,txid)=>{ log('‚úÖ completed', pid, txid); premiumOn(); },
        onCancel:(pid)=>log('üö´ canceled', pid),
        onError:(err)=>log('‚ö†Ô∏è onError', err?.message||err),
      },
    });
    log('üëâ createPayment ->', pay);
  }catch(e){
    log('‚ùå Payment', e?.message||e);
  }
}
function onIncompletePaymentFound(p){ log('‚ö†Ô∏è incomplete payment:', p?.identifier||p); }

function premiumOn(){
  // demo: ch·ªâ g·∫Øn nh√£n; b·∫£n th·∫≠t th√¨ m·ªü kh√≥a Save/Load cloud, export‚Ä¶ 
  const tag = document.createElement('div');
  tag.textContent = 'Premium unlocked ‚úÖ';
  tag.className = 'mini ok';
  document.querySelector('.card .row .col').appendChild(tag);
}

/* ====== Wire UI ====== */
$('btnSuggest').addEventListener('click', suggestChords);
$('btnPiLogin').addEventListener('click', piLogin);
$('btnPiPay').addEventListener('click', ()=>piPaySandbox(0.01));
$('btnCheckPrem').addEventListener('click', ()=>log('‚≠ê Premium (demo): h√£y thanh to√°n ƒë·ªÉ m·ªü kh√≥a.'));

window.addEventListener('load', ()=>{
  suggestChords();
  initPi();
  log('üü£ Ready');
});
</script>
</body>
</html>
