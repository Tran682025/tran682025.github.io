<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiChordify Kingdom v0.52</title>
  <!-- Pi SDK: chỉ hoạt động trong Pi Browser -->
  <script src="https://sdk.minepi.com/pi-sdk.js" defer></script>

  <style>
    :root{
      --ink:#0f0f1f; --bg:#f9f9ff; --card:#ffffff; --line:#e5e7eb;
      --pi:#6f3cff; --pi2:#5b32d4; --ok:#16a34a; --warn:#ca8a04; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:500 16px/1.6 system-ui,-apple-system,Segoe UI,Roboto;
      color:var(--ink); background:var(--bg);
    }
    .wrap{max-width:1120px;margin:auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin:8px 0 16px}
    h1{margin:0;font:800 34px/1 system-ui}
    small.badge{padding:4px 10px;background:#eef;margin-left:8px;border-radius:999px}
    .flex1{flex:1}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    input,select,textarea,button{font:600 15px/1.5 system-ui}
    input,select,textarea{width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px}
    textarea{min-height:180px;font:600 15px/1.45 ui-monospace,Consolas,Menlo,monospace}
    button{cursor:pointer;border:0;border-radius:12px;padding:11px 16px}
    .btn{background:#111;color:#fff}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--line)}
    .btn.primary{background:var(--pi)}
    .btn.danger{background:var(--danger)}
    .panel{background:#0b0f1a;color:#cde; border:1px solid #1e2737; border-radius:14px;padding:14px;min-height:240px;white-space:pre-wrap}
    footer{margin-top:22px;color:#667;text-align:center}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef;font:700 12px/1 ui-monospace}
    .col2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#64748b}
    audio{width:100%}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row">
      <div class="flex1">
        <h1>PiChordify Kingdom <small class="badge">v0.52</small></h1>
      </div>
      <div class="row" style="margin-left:auto">
        <button id="btnLogin" class="btn">Pi Login</button>
        <button id="btnCheck" class="btn secondary">Kiểm tra Premium</button>
        <button id="btnPay"   class="btn primary">Thanh toán Premium</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <h3 style="margin:6px 0 12px">Demo Core</h3>

        <div class="row">
          <div class="col2">
            <div>
              <label>Giọng (key) & tiến trình</label>
              <div class="row">
                <select id="selKey" title="Key">
                  <option>C</option><option>G</option><option>D</option><option>A</option><option>E</option>
                  <option>B</option><option>F#</option><option>C#</option><option>F</option><option>Bb</option>
                  <option>Eb</option><option>Ab</option><option>Db</option><option>Gb</option><option>Cb</option>
                  <option>Am</option><option>Em</option><option>Bm</option><option>F#m</option><option>C#m</option>
                  <option>G#m</option><option>D#m</option><option>A#m</option><option>Dm</option><option>Gm</option>
                  <option>Cm</option><option>Fm</option><option>Bbm</option><option>Ebm</option><option>Abm</option>
                </select>
                <select id="selProg" title="Chord progression">
                  <option value="I-V-vi-IV">I–V–vi–IV</option>
                  <option value="vi-IV-I-V">vi–IV–I–V</option>
                  <option value="I-IV-V-IV">I–IV–V–IV</option>
                  <option value="ii-V-I-vi">ii–V–I–vi</option>
                  <option value="I-V-IV-V">I–V–IV–V</option>
                  <option value="I-vi-ii-V">I–vi–ii–V</option>
                </select>
              </div>
              <button id="btnAutoChord" class="btn secondary" type="button">Tự gợi ý hợp âm</button>
              <div class="muted" style="margin-top:6px"><small>App sẽ nhét hợp âm theo vòng 4/4. Trẫm chỉnh lại sau khi sẵn.</small></div>
            </div>

            <div>
              <label for="title">Tiêu đề</label>
              <input id="title" type="text" placeholder="Tên bài…" />
            </div>
          </div>
        </div>

        <label for="lyrics">Lời + hợp âm <span class="muted">(mỗi dòng có mốc thời gian → định dạng: <b>mm:ss  nội dung / hợp âm</b>, ví dụ: <b>00:12 Em / D</b>)</span></label>
        <textarea id="lyrics" placeholder="mm:ss  nội dung / hợp âm…"></textarea>

        <div class="col2" style="margin-top:12px">
          <div class="col">
            <div class="row">
              <div style="flex:1">
                <label for="bpm">BPM (nhịp)</label>
                <input id="bpm" type="number" value="80" />
              </div>
              <div style="flex:1">
                <label for="offset">Offset (giây, +/-)</label>
                <input id="offset" type="number" value="0" step="0.1" />
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <button id="btnMetro" class="btn secondary">Phát nhịp thử</button>
              <button id="btnCompile" class="btn secondary">Biên dịch & xem trước</button>
              <button id="btnExport" class="btn secondary">Export .svg</button>
            </div>
          </div>

          <div class="col">
            <label>Audio (mp3)</label>
            <input id="audioUrl" type="url" placeholder="https://…/song.mp3" />
            <div class="row" style="margin-top:8px">
              <input id="fileMp3" type="file" accept="audio/mpeg" />
            </div>
            <audio id="player" preload="none" controls></audio>
            <div class="row" style="margin-top:8px">
              <button id="btnPlay"  class="btn">Play</button>
              <button id="btnPause" class="btn secondary">Pause</button>
              <button id="btnStop"  class="btn secondary">Stop</button>
              <div id="clock" class="pill">00:00</div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h3 style="margin:6px 0 12px">Log</h3>
        <div id="log" class="panel">Ready.</div>
      </aside>
    </div>

    <footer>© PiChordify Kingdom — Hackathon demo “có nhạc thật” v0.52</footer>
  </div>

<script>
/* ============ UTIL & LOG ============ */
const $ = s => document.querySelector(s);
const logBox = $('#log');
function log(...msg){
  const line = "• " + msg.join(" ");
  logBox.textContent += (logBox.textContent ? "\n" : "") + line;
  logBox.scrollTop = logBox.scrollHeight;
}
function setMuted(sel, msg){ const el=$(sel); if(!el) return; el.textContent = msg; }

/* ============ PI SDK INIT ============ */
let state = { pi:null, isPi:false };
function isPiBrowser(){
  // thô sơ: Pi Browser đặt userAgent có "PiBrowser" + SDK object
  return typeof window.Pi !== "undefined" || /PiBrowser/i.test(navigator.userAgent);
}
async function initPI(){
  if(!isPiBrowser()){
    setMuted("#btnPay","Không ở Pi Browser → ẩn thanh toán.");
    $('#btnPay').style.display = "none";
    log("Không có Pi SDK. Mở trong Pi Browser để test thanh toán.");
    return;
  }
  state.pi = window.Pi;
  state.isPi = true;
  setMuted("#btnPay","Pi Pay (sandbox)");
  try{
    state.pi.init({ version: "2.0", sandbox: true });
    log("Pi SDK init xong.");
  }catch(err){
    log("Pi SDK init lỗi:", err?.message||err);
  }
}

$('#btnLogin').addEventListener('click', async ()=>{
  if(!state.isPi) return log("Login lỡ hẹn: Pi SDK chưa sẵn.");
  try{
    const scopes = ['username','payments'];
    const res = await state.pi.authenticate(scopes, onIncomplete=>log("Incomplete:",onIncomplete?.identifier));
    log("User:", res?.user?.username);
  }catch(e){ log("Login lỗi:", e?.message||e); }
});
$('#btnCheck').addEventListener('click', async ()=>{
  log("checkPremium (demo) chưa có backend → false");
});
$('#btnPay').addEventListener('click', async ()=>{
  if(!state.isPi) return log("Tạo payment lỗi: Pi SDK chưa sẵn.");
  try{
    const payment = await state.pi.createPayment({
      amount: 0.01, memo: "PiChordify Premium (demo)", metadata:{ plan:"demo" }
    });
    log("createPayment ok:", JSON.stringify(payment));
    payment.on("completed", async (p)=>{ log("Payment completed:", p?.identifier); });
    payment.on("error", (err)=>{ log("Payment error:", err?.message||err); });
  }catch(e){ log("createPayment lỗi:", e?.message||e); }
});

/* ============ AUDIO PLAYER ============ */
const player = $('#player');
let rafTimer = null;

function connectPlayerSrc(src){
  if(!src) return;
  player.src = src;
  player.load();
  log("Đã nạp file mp3:", src.split('/').pop());
}
$('#audioUrl').addEventListener('change', e=> connectPlayerSrc(e.target.value.trim()));
$('#fileMp3').addEventListener('change', e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  connectPlayerSrc(url);
});

$('#btnPlay').addEventListener('click', async ()=>{
  try{ await player.play(); }catch(e){}
});
$('#btnPause').addEventListener('click', ()=> player.pause());
$('#btnStop').addEventListener('click', ()=>{
  try{ player.pause(); player.currentTime = 0; }catch(e){}
});

function tickClock(){
  const t = Math.floor(player.currentTime||0);
  const m = String(Math.floor(t/60)).padStart(2,'0');
  const s = String(t%60).padStart(2,'0');
  $('#clock').textContent = `${m}:${s}`;
  rafTimer = requestAnimationFrame(tickClock);
}
player.addEventListener('play', ()=>{ cancelAnimationFrame(rafTimer); tickClock(); });
player.addEventListener('pause', ()=> cancelAnimationFrame(rafTimer));
player.addEventListener('ended', ()=> cancelAnimationFrame(rafTimer));

/* ============ METRONOME ============ */
let metro = { ctx:null, osc:null, gain:null, timer:null, isOn:false };
function metronomeStart(){
  const bpm = Number($('#bpm').value||80);
  const interval = 60_000/bpm; // ms
  if(!metro.ctx) metro.ctx = new (window.AudioContext||window.webkitAudioContext)();
  const click = ()=>{
    const t = metro.ctx.currentTime;
    const o = metro.ctx.createOscillator();
    const g = metro.ctx.createGain();
    o.frequency.value = 1000; g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.5,t+0.001);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.08);
    o.connect(g).connect(metro.ctx.destination);
    o.start(t); o.stop(t+0.09);
  };
  if(metro.timer) clearInterval(metro.timer);
  click(); metro.timer = setInterval(click, interval);
  metro.isOn = true; log(`Bật metronome ${bpm} BPM`);
}
function metronomeStop(){
  if(metro.timer) clearInterval(metro.timer);
  metro.timer = null; metro.isOn=false; log("Tắt metronome.");
}
$('#btnMetro').addEventListener('click', ()=> metro.isOn ? metronomeStop() : metronomeStart());

/* ============ AUTO CHORD SUGGESTION ============ */
const MAJOR_KEYS = {
  C:["C","D","E","F","G","A","B"],
  G:["G","A","B","C","D","E","F#"],
  D:["D","E","F#","G","A","B","C#"],
  A:["A","B","C#","D","E","F#","G#"],
  E:["E","F#","G#","A","B","C#","D#"],
  B:["B","C#","D#","E","F#","G#","A#"],
  "F#":["F#","G#","A#","B","C#","D#","E#"], "C#":["C#","D#","E#","F#","G#","A#","B#"],
  F:["F","G","A","Bb","C","D","E"],
  Bb:["Bb","C","D","Eb","F","G","A"],
  Eb:["Eb","F","G","Ab","Bb","C","D"],
  Ab:["Ab","Bb","C","Db","Eb","F","G"],
  Db:["Db","Eb","F","Gb","Ab","Bb","C"],
  Gb:["Gb","Ab","Bb","Cb","Db","Eb","F"], Cb:["Cb","Db","Eb","Fb","Gb","Ab","Bb"],
};
const MINOR_REL = { A:"Am", E:"Em", B:"Bm", "F#":"F#m", "C#":"C#m", "G#":"G#m", "D#":"D#m", "A#":"A#m",
  D:"Dm", G:"Gm", C:"Cm", F:"Fm", Bb:"Bbm", Eb:"Ebm", Ab:"Abm" };

function romanToChord(key, token){
  // token: I ii V vi etc.
  const isMinorKey = /m$/.test(key);
  const baseKey = isMinorKey ? key.replace(/m$/,'').toUpperCase() : key.toUpperCase();
  const scale = MAJOR_KEYS[baseKey] || MAJOR_KEYS.C;
  const map = { "I":0,"ii":1,"II":1,"iii":2,"III":2,"IV":3,"iv":3,"V":4,"v":4,"vi":5,"VI":5,"vii":6,"VII":6 };
  let deg = map[token] ?? 0;
  let chordRoot = scale[deg] || scale[0];
  // hóa/thường theo token
  let chord = /ii|iii|iv|v|vi|vii/.test(token) ? chordRoot+"m" : chordRoot;
  if(/°/.test(token)) chord = chord.replace(/m?$/,"dim");
  return chord;
}
function parseProg(str){ return str.split(/[-–—\s]+/).map(s=>s.trim()).filter(Boolean); }

function wireAutoChord(){
  $('#btnAutoChord').addEventListener('click', ()=>{
    const key = $('#selKey').value;
    const progTokens = parseProg($('#selProg').value);
    const bpm = Number($('#bpm').value||80);
    // tạo 8 ô 4/4 (tối giản): mỗi hợp âm kéo 1 ô (1 bar)
    const bars = 8;
    const lines = [];
    for(let i=0;i<bars;i++){
      const token = progTokens[i % progTokens.length];
      const chord = romanToChord(key, token);
      const t = i * (60/bpm)*4; // giây
      const mm = String(Math.floor(t/60)).padStart(2,'0');
      const ss = String(Math.floor(t%60)).padStart(2,'0');
      lines.push(`${mm}:${ss}  … / ${chord}`);
    }
    const cur = $('#lyrics').value.trim();
    $('#lyrics').value = (cur ? cur+"\n" : "") + lines.join("\n");
    log("Đã sinh hợp âm theo", key, "→", progTokens.join("-"));
  });
}

/* ============ COMPILE & EXPORT (stub) ============ */
$('#btnCompile').addEventListener('click', ()=>{
  // chỗ này có thể render preview SVG/Canvas; để stub log cho nhẹ.
  const n = $('#lyrics').value.trim().split(/\n/).filter(Boolean).length;
  log(`Compile xong: ${n} dòng.`);
});
$('#btnExport').addEventListener('click', ()=>{
  log("Export .svg (demo) — sẽ gắn sau khi hoàn thiện preview.");
});

/* ============ BOOT ============ */
window.addEventListener('load', ()=>{
  initPI();
  wireAutoChord();

  // tick đồng hồ mỗi 250ms khi đang play
  setInterval(()=>{ if(!player.paused){ const t=player.currentTime||0;
    const m=String(Math.floor(t/60)).padStart(2,'0');
    const s=String(Math.floor(t%60)).padStart(2,'0');
    $('#clock').textContent = `${m}:${s}`;
  } }, 250);

  log("DOM loaded. JS đang chạy.");
});
</script>
</body>
</html>
