<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiChordify Kingdom</title>
  <link rel="icon" href="data:," />
  <style>
    :root{--pi:#7d3cff;--bg:#f6edff;--ink:#261b39;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:40px;color:var(--pi);letter-spacing:.5px}
    .note{opacity:.7}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px;margin:14px 0}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn{background:var(--pi);color:#fff}
    .btn.outline{background:#fff;border:2px solid var(--pi);color:var(--pi)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eee;margin:4px 6px 0 0;font-family:ui-monospace,Consolas,monospace}
    .mono{font-family:ui-monospace,Consolas,monospace}
    label{font-size:14px;opacity:.9}
    input,select{padding:10px;border:1px solid #ddd;border-radius:10px}
    .muted{opacity:.6}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PiChordify Kingdom</h1>
    <div class="note">B·∫£n minh ho·∫° <b>thanh to√°n Pi</b> + <b>m·ªü kho√° h·ª£p √¢m</b> k√®m transposer. (Sandbox h·ªó tr·ª£ test)</div>

    <!-- ƒêƒÉng nh·∫≠p & tr·∫°ng th√°i -->
    <div class="card">
      <div class="row">
        <button class="btn" id="loginBtn">üîê ƒêƒÉng nh·∫≠p v·ªõi Pi</button>
        <button class="btn outline" id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button>
        <div id="hello" class="pill mono">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
      </div>
      <div style="margin-top:8px">
        <b>Premium:</b>
        <span id="premium-status" class="pill">üîí Ch∆∞a mua Premium</span>
      </div>
      <div style="margin-top:10px">
        <button class="btn" id="buyBtn">üé∂ Mua Premium ‚Äì 1 Pi</button>
        <span class="muted mono">Tip: th√™m <code>?onSandbox=1</code> v√†o URL khi test.</span>
      </div>
    </div>

    <!-- Transposer & H·ª£p √¢m -->
    <div class="card">
      <div class="row">
        <label for="songSel">B√†i h√°t:</label>
        <select id="songSel"></select>

        <label for="shiftInp">Shift (¬±12):</label>
        <input id="shiftInp" type="number" step="1" value="0" class="mono" style="width:90px" />
        <button id="applyBtn" class="btn outline">√Åp d·ª•ng</button>
      </div>
      <div id="chordView" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    /***** CONFIG *****/
    // S·ª≠a URL n√†y th√†nh Worker c·ªßa Tr·∫´m:
    const WORKER_URL = "https://pichordifykingdom.workers.dev";

    // Sandbox: b·∫≠t khi c√≥ ?onSandbox=1
    const isSandbox = new URL(location.href).searchParams.get("onSandbox") === "1";
    Pi.init({ version: "2.0", sandbox: isSandbox });

    /***** UI HO√Å TR·∫†NG TH√ÅI *****/
    function updateHello(name) {
      const el = document.getElementById("hello");
      el.textContent = name ? `Xin ch√†o @${name} üëã` : "Ch∆∞a ƒëƒÉng nh·∫≠p";
    }
    function updatePremiumStatus(isPremium) {
      const el = document.getElementById("premium-status");
      if (isPremium) el.textContent = "‚úÖ ƒê√£ mua Premium";
      else el.textContent = "üîí Ch∆∞a mua Premium";
    }

    /***** SONG DATA + TRANSPOSER DEMO *****/
    const SONGS = {
      // Demo 2 b√†i (Tr·∫´m c√≥ th·ªÉ thay n·ªôi dung th·ª±c)
      "T√¨nh Ca Demo": "C G Am F | C G C | F G C",
      "Hello Pi": "Dm G C Am | F G C"
    };
    const CHORDS = ["C","C#","Db","D","D#","Eb","E","F","F#","Gb","G","G#","Ab","A","A#","Bb","B"];
    function normalize(ch){return ch.replace(/[^A-G#b]/g,"");}
    function shiftChord(ch, s){
      const base = normalize(ch);
      let i = CHORDS.indexOf(base);
      if (i<0) return ch;
      let j = (i + s + CHORDS.length) % CHORDS.length;
      return ch.replace(base, CHORDS[j]);
    }
    function transposeLine(line, shift){
      return line.split(/\s+/).map(t=>shiftChord(t,shift)).join(" ");
    }
    function renderChords(){
      const song = document.getElementById("songSel").value;
      const shift = parseInt(document.getElementById("shiftInp").value || "0", 10);
      const lines = SONGS[song].split("|").map(s=>s.trim());
      const box = document.getElementById("chordView");
      box.innerHTML = "";
      lines.forEach((ln,i)=>{
        const d = document.createElement("div");
        d.className = "pill mono";
        d.textContent = transposeLine(ln, shift);
        box.appendChild(d);
        if (i<lines.length-1){
          const sep = document.createElement("div");
          sep.className="pill";
          sep.textContent="|";
          box.appendChild(sep);
        }
      });
    }
    // fill select
    (function initSongs(){
      const sel = document.getElementById("songSel");
      Object.keys(SONGS).forEach(k=>{
        const opt=document.createElement("option");
        opt.value=k; opt.textContent=k;
        sel.appendChild(opt);
      });
      sel.value = Object.keys(SONGS)[0];
      renderChords();
    })();

    /***** HELPER G·ªåI WORKER *****/
    async function callAPI(path, body){
      const r = await fetch(`${WORKER_URL}${path}`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body||{})
      });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`API ${path} failed: ${r.status} ${t}`);
      }
      return r.json();
    }

    /***** LOGIN / LOGOUT *****/
    async function login(){
      try{
        const auth = await Pi.authenticate(["username","payments"], () => {});
        updateHello(auth.user.username);
        // c√≥ th·ªÉ fetch data c∆° b·∫£n sau login
      }catch(e){
        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + (e?.message||e));
      }
    }
    function logout(){
      updateHello("");
    }

    /***** MUA PREMIUM ‚Äì C√ì APPROVE/COMPLETE SERVER *****/
    async function payPremium(){
      try{
        await Pi.authenticate(["username","payments"], () => {});
        await Pi.createPayment(
          {
            amount: 1, // ƒë·ªïi gi√° t√πy √Ω
            memo: "PiChordify Premium Access",
            metadata: { type: "premium", item: "access" }
          },
          {
            onReadyForServerApproval: (paymentId) => {
              return callAPI("/approve",{ paymentId });
            },
            onReadyForServerCompletion: (paymentId, txid) => {
              return callAPI("/complete",{ paymentId, txid }).then(()=>{
                localStorage.setItem("pck_premium","true");
                updatePremiumStatus(true);
                alert("Thanh to√°n th√†nh c√¥ng ‚úÖ");
              });
            },
            onCancel: (paymentId) => {
              console.log("User cancelled", paymentId);
              alert("ƒê√£ hu·ª∑ thanh to√°n.");
            },
            onError: (error, paymentId) => {
              console.error("Payment error", error, paymentId);
              alert("L·ªói thanh to√°n: " + (error?.message||error));
            }
          }
        );
      }catch(e){
        alert("C√≥ l·ªói khi mua Premium: " + (e?.message||e));
      }
    }

    /***** EVENT BINDINGS *****/
    document.getElementById("loginBtn").onclick = login;
    document.getElementById("logoutBtn").onclick = logout;
    document.getElementById("buyBtn").onclick = payPremium;
    document.getElementById("applyBtn").onclick = renderChords;
    document.getElementById("songSel").onchange = renderChords;

    // Kh√¥i ph·ª•c tr·∫°ng th√°i premium ƒë√£ mua (n·∫øu c√≥)
    (function restorePremium(){
      const isPremium = localStorage.getItem("pck_premium")==="true";
      updatePremiumStatus(isPremium);
    })();
  </script>
</body>
</html>
