<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PiChordify Kingdom ‚Äî v7.1.3</title>
  <style>
    :root{
      --bg:#0b1120; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#a78bfa;
      --pill:#1f2937; --btn:#374151; --btn2:#4c1d95;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto;
      color:var(--text); background:radial-gradient(1200px 600px at 10% 0%,#0b132b 0,#0b1120 60%,#050816 100%)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .title{display:flex;align-items:end;gap:10px}
    .h1{font-weight:800;line-height:.95;font-size:clamp(28px,6vw,64px)}
    .badge{background:#312e81;color:#c7d2fe;border:1px solid #4338ca;padding:.25rem .55rem;border-radius:.6rem}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;margin-top:10px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:18px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .lab{color:var(--muted);font-size:.9rem}
    select,input,textarea,button{background:#0f172a;color:var(--text);border:1px solid #1f2937;border-radius:12px}
    select,input{height:40px;padding:0 12px}
    textarea{width:100%;min-height:160px;padding:12px;border-radius:14px;resize:vertical;line-height:1.5}
    button{height:40px;padding:0 14px;cursor:pointer}
    .btn{background:var(--btn)}
    .btn:hover{filter:brightness(1.12)}
    .btn-accent{background-image:linear-gradient(135deg,#8b5cf6,#06b6d4)}
    .pill{background:var(--pill);padding:.3rem .7rem;border-radius:999px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .right{display:flex;flex-direction:column;gap:18px}
    .logbox{height:220px;overflow:auto;white-space:pre-wrap;background:#0a0f1f;border:1px solid #1f2937;border-radius:14px;padding:12px}
    .small{font-size:.85rem;color:var(--muted)}
    .range{width:100%}
    .muted{color:var(--muted)}
    .footer{opacity:.7;text-align:center;margin-top:26px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div class="h1">PiChordify<br/>Kingdom</div>
      <span class="badge">v7.1.3</span>
      <span class="pill">Theme: t√≠m‚Äìng·ªçc</span>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row">
          <label class="lab">Gi·ªçng (key)</label>
          <select id="selKey">
            <option>C</option><option>Db</option><option>D</option><option>Eb</option><option>E</option>
            <option>F</option><option>Gb</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
          </select>

          <label class="lab">Ti·∫øn tr√¨nh</label>
          <select id="selProg">
            <option>I‚ÄìV‚Äìvi‚ÄìIV</option>
            <option>I‚Äìvi‚ÄìIV‚ÄìV</option>
            <option>ii‚ÄìV‚ÄìI</option>
            <option>I‚ÄìIV‚ÄìV‚ÄìIV</option>
            <option>vi‚ÄìIV‚ÄìI‚ÄìV</option>
          </select>

          <button class="btn" id="btnSuggest">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="title" placeholder="Ti√™u ƒë·ªÅ" style="flex:1"/>
          <span class="pill">Sandbox</span>
        </div>

        <div class="split" style="margin-top:12px">
          <div>
            <div class="lab">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî d·∫°ng: <span class="mono">mm:ss Em / D</span>)</div>
            <textarea id="lyrics" placeholder="00:12 Em / D ..."></textarea>
          </div>
          <div>
            <div class="lab">G·ª£i √Ω h·ª£p √¢m</div>
            <textarea id="suggest" placeholder="Nh·∫•n 'T·ª± g·ª£i √Ω h·ª£p √¢m'..." readonly></textarea>
          </div>
        </div>

        <div class="split" style="margin-top:12px">
          <div class="card" style="padding:12px">
            <div class="lab">Audio (mp3)</div>
            <input id="audioUrl" placeholder="https://.../song.mp3"/>
            <div class="toolbar" style="margin-top:10px">
              <button class="btn" id="btnPlay">Play</button>
              <button class="btn" id="btnPause">Pause</button>
              <button class="btn" id="btnStop">Stop</button>
              <span class="small" id="timeLbl">0:00 / 0:00</span>
            </div>
            <input type="range" min="0" max="1000" value="0" id="progress" class="range"/>
            <div class="row">
              <label class="lab">BPM</label><input id="bpm" type="number" value="60" style="width:90px"/>
              <label class="lab">Offset (gi√¢y, ¬±)</label><input id="offset" type="number" value="0" style="width:110px"/>
            </div>
          </div>

          <div class="card" style="padding:12px">
            <div class="lab">Xu·∫•t/Nh·∫≠p</div>
            <div class="toolbar" style="margin-top:8px">
              <button class="btn" id="btnSave">Save</button>
              <button class="btn" id="btnLoad">Load</button>
              <button class="btn" id="btnShare">Share link</button>
            </div>
            <div class="small" style="margin-top:8px">L∆∞u c·ª•c b·ªô (localStorage). ‚ÄúShare link‚Äù ch·ªâ hi·ªÉn th·ªã d·ªØ li·ªáu m√£ h√≥a trong URL.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div class="lab">ƒêƒÉng nh·∫≠p & thanh to√°n</div>
            <div class="toolbar">
              <button class="btn" id="btnPiLogin">Pi Login</button>
              <button class="btn" id="btnPremium">Ki·ªÉm tra Premium</button>
              <button class="btn btn-accent" id="btnPiPay">Pi Pay (sandbox)</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="lab">Log</div>
            <span class="pill small">Console mirror</span>
          </div>
          <div id="log" class="logbox mono"></div>
        </div>
      </div>
    </div>

    <div class="footer small">¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù v7.1.3</div>
  </div>

  <!-- Hidden audio -->
  <audio id="audio" preload="auto"></audio>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js" defer></script>
<script>
/* ===== Helpers ===== */
const $ = (id) => document.getElementById(id);
const logBox = $("log");
function log(...args){
  const t = `[${new Date().toLocaleTimeString()}] ` + args.map(x=>typeof x==="string"?x:JSON.stringify(x)).join(" ");
  if(logBox){ logBox.textContent += t + "\n"; logBox.scrollTop = logBox.scrollHeight; }
  console.log(...args);
}

/* ===== Chords Engine ===== */
const KEYS = {
  C:["C","Dm","Em","F","G","Am","Bdim"],
  D:["D","Em","F#m","G","A","Bm","C#dim"],
  E:["E","F#m","G#m","A","B","C#m","D#dim"],
  F:["F","Gm","Am","Bb","C","Dm","Edim"],
  G:["G","Am","Bm","C","D","Em","F#dim"],
  A:["A","Bm","C#m","D","E","F#m","G#dim"],
  B:["B","C#m","D#m","E","F#","G#m","A#dim"]
};
const DEG = {I:0,ii:1,iii:2,IV:3,V:4,vi:5,vii:6};

function suggestChords(){
  const key = $("selKey").value;
  const prog = $("selProg").value;
  const bank = KEYS[key] || KEYS.C;
  const parts = prog.replace(/\s+/g,"").split(/[-/]+/);
  const out = parts.map(p=>bank[DEG[p] ?? "?"]).join(" - ");
  $("suggest").value = `${key} major: ${out}`;
  log("üé∂", out);
}

/* ===== Audio Controls ===== */
const audio = $("audio");
const progress = $("progress");
if(audio){
  audio.addEventListener("timeupdate",()=>{
    if(audio.duration) progress.value = (audio.currentTime / audio.duration)*100;
  });
  $("btnPlay")?.addEventListener("click",()=>{ audio.play(); log("‚ñ∂Ô∏è Play"); });
  $("btnPause")?.addEventListener("click",()=>{ audio.pause(); log("‚è∏ Pause"); });
  $("btnStop")?.addEventListener("click",()=>{ audio.pause(); audio.currentTime=0; log("‚èπ Stop"); });
}

/* ===== Pi SDK Loader ===== */
function waitForPi(tries=0){
  if(window.Pi && typeof Pi.init==="function"){ startPi(); return; }
  if(tries>60){
    log("‚ùå Pi SDK ch∆∞a s·∫µn s√†ng. M·ªü b·∫±ng Pi Browser v√† ƒë·∫£m b·∫£o domain ƒë√£ khai b√°o trong Pi Dev Portal.");
    $("#btnPiLogin")?.setAttribute("disabled", true);
    $("#btnPiPay")?.setAttribute("disabled", true);
    return;
  }
  setTimeout(()=>waitForPi(tries+1),250);
}

/* ===== Main after SDK loaded ===== */
function startPi(){
  const Pi = window.Pi;
  if(!Pi.isPiBrowser || !Pi.isPiBrowser()){
    log("‚ö†Ô∏è Trang n√†y c·∫ßn m·ªü trong Pi Browser ƒë·ªÉ d√πng Login/Pay.");
    $("#btnPiLogin")?.setAttribute("disabled", true);
    $("#btnPiPay")?.setAttribute("disabled", true);
  }

  async function initPi(){
    try{
      await Pi.init({version:"2.0", sandbox:true});
      log("‚úÖ Pi SDK initialized (sandbox)");
    }catch(e){ log(`‚ùå Pi init: ${e.message}`); }
  }

  async function piLogin(){
    try{
      const scopes=["payments","username","wallet_address"];
      const auth=await Pi.authenticate(scopes,onIncompletePaymentFound);
      log(`üë§ User: ${auth?.user?.username || "unknown"}`);
      return auth;
    }catch(e){ log(`‚ùå Login: ${e.message}`); }
  }

  async function piPaySandbox(amount=0.01){
    try{
      const auth=await piLogin(); if(!auth) return;
      const pay=await Pi.createPayment({
        amount:String(amount),
        memo:"Tranmusickingdom Premium demo",
        metadata:{feature:"premium_demo",ver:"v7.1.3"}
      },onIncompletePaymentFound);
      await pay.approve(); await pay.complete();
      localStorage.setItem("tmk_premium","true");
      updatePremiumBadge();
      log("‚≠ê Premium (demo) activated!");
    }catch(e){ log(`‚ùå Payment: ${e.message}`); }
  }

  function onIncompletePaymentFound(p){
    log(`‚ö†Ô∏è incomplete: ${p?.identifier || ""}`);
  }

  function checkPremium(){
    const ok = localStorage.getItem("tmk_premium")==="true";
    log(ok?"‚úÖ Premium active":"üîí Premium locked");
    updatePremiumBadge();
  }
  function updatePremiumBadge(){
    const b=$("badgePremium"); if(!b) return;
    const ok=localStorage.getItem("tmk_premium")==="true";
    b.textContent=ok?"Premium":"Free";
    b.style.background=ok?"#7c3aed":"var(--bg)";
    b.style.color=ok?"#fff":"var(--text)";
  }

  /* ===== Wire buttons ===== */
  $("btnPiLogin")?.addEventListener("click",piLogin);
  $("btnPiPay")?.addEventListener("click",()=>piPaySandbox(0.01));
  $("btnPremium")?.addEventListener("click",checkPremium);
  $("btnSuggest")?.addEventListener("click",suggestChords);

  updatePremiumBadge();
  initPi();
  log("üü£ Ready (Pi SDK loaded)");
}

/* ===== Boot ===== */
window.addEventListener("load",()=>{ suggestChords(); waitForPi(); });
</script>

</body>
</html>
