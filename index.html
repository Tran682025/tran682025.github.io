<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiChordify Kingdom ‚Äî v0.5</title>

  <!-- Pi SDK (ch·ªâ ho·∫°t ƒë·ªông trong Pi Browser) -->
  <script src="https://sdk.minepi.com/pi-sdk.js" defer></script>

  <!-- jsPDF cho xu·∫•t PDF (gi·ªØ nh∆∞ b·∫£n v0.4) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

  <style>
    :root{
      --ink:#222; --bg:#fff; --muted:#6b7280; --warm:#f9fafb; --pi:#6d28d9; --pi2:#a78bfa; --danger:#ef4444; --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto; color:var(--ink); background:var(--warm); margin:0}
    header,main,footer{max-width:1200px;margin:auto;padding:16px}
    h1{font-weight:800}
    .grid{display:grid; gap:16px}
    .two{grid-template-columns:1fr 1fr}
    label{display:block;font-weight:600;margin:8px 0 6px}
    input[type="text"], input[type="number"], textarea{
      width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:12px; font:14px monospace;
      background:#fff;
    }
    textarea{min-height:210px; white-space:pre; overflow:auto}
    button{
      cursor:pointer; border:1px solid #e5e7eb; border-radius:10px; padding:11px 14px; font-weight:700; background:#fff;
    }
    button.pi{background:var(--pi); color:#fff}
    button.success{background:var(--ok); color:#fff}
    button.danger{background:var(--danger); color:#fff}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .card{background:#fff;border:1px dashed #e0e0e0;border-radius:16px;padding:12px}
    .log{font:12px/1.4 ui-monospace,Consolas,Menlo,monospace; white-space:pre-wrap;background:#111;color:#eee;border-radius:12px;padding:12px}
    footer{opacity:.7; text-align:center}
    .file-label{display:inline-block;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-weight:700}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .bd-ok{background:#e9f9ee;color:#065f46}
    .bd-warn{background:#fff7ed;color:#9a3412}
  </style>
</head>
<body>
<header>
  <h1>PiChordify Kingdom <span class="badge bd-warn">v0.5</span></h1>
  <div class="toolbar">
    <button id="btnLogin">Pi Login</button>
    <button id="btnCheck">Ki·ªÉm tra Premium</button>
    <button id="btnPay" class="pi">Thanh to√°n Premium</button>
    <span id="who" class="badge bd-ok" style="display:none"></span>
  </div>
</header>

<main class="grid two">
  <section class="card">
    <div class="toolbar" style="justify-content:space-between">
      <strong>Demo Core v0.5</strong>
      <div>
        <button id="btnLoad1">T·∫£i demo 1</button>
        <button id="btnLoad2">T·∫£i demo 2</button>
        <button id="btnClear" class="danger">X√≥a</button>
      </div>
    </div>

    <label for="title">Ti√™u ƒë·ªÅ</label>
    <input id="title" type="text" placeholder="T√™n b√†i...">

    <label for="lyrics">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian)</label>
    <textarea id="lyrics" placeholder="mm:ss  n·ªôi dung / h·ª£p √¢m..."></textarea>

    <div class="toolbar" style="margin-top:8px">
      <button id="btnPreview">Bi√™n d·ªãch & xem tr∆∞·ªõc</button>
      <button id="btnExport">Export .art</button>
      <button id="btnExportPDF" class="pi">Export PDF (Premium)</button>
    </div>

    <div class="grid two" style="margin-top:10px">
      <div>
        <label for="bpm">BPM (nh·ªãp)</label>
        <input id="bpm" type="number" value="80" min="20" max="240">
      </div>
      <div>
        <label for="offset">Offset (gi√¢y, +/-)</label>
        <input id="offset" type="number" value="0" step="0.01">
      </div>
    </div>

    <label for="urlAudio" style="margin-top:10px">URL audio (mp3)</label>
    <div class="toolbar">
      <input id="urlAudio" type="text" placeholder="https://.../song.mp3" style="flex:1">
      <label class="file-label" for="audioFile">üéµ Ch·ªçn file MP3</label>
      <input id="audioFile" type="file" accept="audio/mpeg" style="display:none">
    </div>

    <div class="toolbar" style="margin-top:8px">
      <button id="btnPlay">‚ñ∂Ô∏è Play</button>
      <button id="btnPause">‚è∏Ô∏è Pause</button>
      <button id="btnStop">‚èπÔ∏è Stop</button>
      <button id="btnMetro" class="success">Ph√°t nh·ªãp th·ª≠</button>
    </div>

    <audio id="player" preload="none" style="width:100%; margin-top:10px" controls></audio>
    <div id="clock" style="text-align:right; opacity:.7; margin-top:4px">00:00</div>
  </section>

  <section class="card">
    <div id="preview" style="min-height:220px">S·∫µn s√†ng. Nh·∫•n ‚ÄúBi√™n d·ªãch & xem tr∆∞·ªõc‚Äù.</div>
    <div id="log" class="log" style="margin-top:12px"></div>
  </section>
</main>

<footer>
  ¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù v0.5
</footer>

<script>
/* ===================== CONFIG ===================== */
// ƒê·∫∑t URL m√°y ch·ªß backend c·ªßa anh (Render/Vercel/Railway‚Ä¶)
// N·∫øu ch∆∞a c√≥ backend, ƒë·ªÉ chu·ªói r·ªóng: ch·ªâ ch·∫°y ph·∫ßn demo & audio local.
const BACKEND_BASE = ""; // v√≠ d·ª•: "https://pichordify-backend.onrender.com"

/* ================ TI·ªÜN √çCH LOG ==================== */
const $ = (sel)=>document.querySelector(sel);
const logEl = $("#log");
function say(txt){ logEl.textContent = (logEl.textContent ? logEl.textContent+"\n" : "") + txt; logEl.scrollTop = logEl.scrollHeight; }

/* ================ PI SDK ==================== */
const hasPi = typeof window.Pi !== "undefined";

async function piInit(){
  try{
    if(!hasPi){ say("‚ÑπÔ∏è Kh√¥ng c√≥ Pi SDK. M·ªü b·∫±ng Pi Browser ƒë·ªÉ test thanh to√°n."); return; }
    window.Pi.init({ version:"2.6", sandbox: false });
    say("‚úÖ Pi SDK s·∫µn s√†ng.");
  }catch(err){ say("‚ùå Pi init l·ªói: "+err.message); }
}

async function piLogin(){
  try{
    if(!hasPi) return say("‚ÑπÔ∏è Kh√¥ng c√≥ Pi SDK.");
    const scopes = ["username","payments"];
    const me = await window.Pi.authenticate(scopes, (e)=>say("‚ÑπÔ∏è Incomplete: "+e?.identifier));
    $("#who").style.display="inline-block";
    $("#who").textContent = "@"+(me?.user?.username || "user");
    say("‚úÖ ƒêƒÉng nh·∫≠p: @"+me?.user?.username);
  }catch(err){ say("‚ùå Login l·ªói: "+err.message); }
}

async function checkPremium(){
  try{
    if(!BACKEND_BASE){ say("‚ÑπÔ∏è Ch∆∞a c·∫•u h√¨nh BACKEND_BASE ‚Üí b·ªè qua check."); return false; }
    const id = $("#who").textContent.replace("@","") || "guest";
    const r = await fetch(BACKEND_BASE+"/api/check?id="+encodeURIComponent(id));
    const ok = await r.json();
    say(ok?.premium ? "‚úÖ T√†i kho·∫£n Premium." : "‚ÑπÔ∏è Ch∆∞a Premium.");
    return !!ok?.premium;
  }catch(err){ say("‚ùå L·ªói g·ªçi /check: "+err.message); return false; }
}

async function payPremium(){
  try{
    if(!hasPi) return say("‚ÑπÔ∏è Kh√¥ng c√≥ Pi SDK.");
    if(!BACKEND_BASE) return say("‚ÑπÔ∏è Ch∆∞a c·∫•u h√¨nh BACKEND_BASE ‚Üí kh√¥ng th·ªÉ t·∫°o payment.");
    const id = ($("#who").textContent || "").replace("@","") || "guest";

    const paymentData = { amount: 1, memo: "PiChordify Premium", metadata:{plan:"pro"} };
    const callbacks = {
      onReadyForServerApproval: async (paymentId)=>{
        say("üü£ onReadyForServerApproval: "+paymentId);
        await fetch(BACKEND_BASE+"/api/approve",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId,id})});
      },
      onReadyForServerCompletion: async (paymentId, txid)=>{
        say("üü£ onReadyForServerCompletion: "+paymentId);
        await fetch(BACKEND_BASE+"/api/complete",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId, txid, id})});
      },
      onCancel: (p)=>say("‚ö™ onCancel"),
      onError: (e)=>say("‚ùå onError: "+e)
    };

    const payment = await window.Pi.createPayment(paymentData, callbacks);
    say("‚úÖ Payment flow kh·ªüi t·∫°o.");
  }catch(err){ say("‚ùå payPremium l·ªói: "+err.message); }
}

/* ================ AUDIO & METRONOME ================== */
let userAudioURL = null;
const player = $("#player");

function ensurePlayer(){ return player; }

function loadAudio(){
  const url = $("#urlAudio").value.trim();
  const p = ensurePlayer();
  if(!url){ say("‚ÑπÔ∏è Ch∆∞a c√≥ URL/file mp3."); return; }
  p.src = url;
  say("üéß ƒê√£ n·∫°p audio: "+ (userAudioURL ? "(local file)" : url));
}

function play(){
  loadAudio();
  ensurePlayer().play().then(()=>say("‚ñ∂Ô∏è Play"))
  .catch(e=>say("‚ùå Play l·ªói: "+e.message));
}

function pause(){ ensurePlayer().pause(); say("‚è∏Ô∏è Pause"); }

function stop(){ const p=ensurePlayer(); p.pause(); p.currentTime=0; say("‚èπÔ∏è Stop"); }

function metronome(){
  const bpm = Number($("#bpm").value||0)||60;
  const interval = 60/bpm; // gi√¢y m·ªói nh·ªãp
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = "square";
  osc.frequency.value = 880;
  gain.gain.setValueAtTime(0, ctx.currentTime);
  osc.connect(gain).connect(ctx.destination);
  osc.start();

  let i=0; const ticks = 16;
  function tick(){
    const t = ctx.currentTime;
    gain.gain.cancelScheduledValues(t);
    gain.gain.setValueAtTime(0.001, t);
    gain.gain.exponentialRampToValueAtTime(0.4, t+0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, t+0.08);
    i++; if(i>=ticks){ osc.stop(t+0.12); say(`‚úÖ Ph√°t nh·ªãp ${ticks} l·∫ßn @ ${bpm} BPM`); return; }
    setTimeout(tick, interval*1000);
  }
  tick();
}

/* ================ PARSER & PREVIEW ================== */
function parseLines(txt){
  // mm:ss  content / chords
  const rows = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  for(const line of rows){
    const m = line.match(/^(\d{1,2}):(\d{2})\s+(.*?)(?:\s*\/\s*(.*))?$/);
    if(!m) continue;
    const t = Number(m[1])*60 + Number(m[2]);
    out.push({t, text:m[3], chords:m[4]||""});
  }
  return out;
}

function toMMSS(sec){
  const s = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

function compilePreview(){
  const data = parseLines($("#lyrics").value||"");
  const off = Number($("#offset").value||0);
  if(!data.length){ $("#preview").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu."; return; }

  const box = document.createElement("div");
  for(const row of data){
    const p = document.createElement("p");
    p.innerHTML = `<strong>${toMMSS(row.t + off)}</strong> ‚Äî ${row.text} <em style="opacity:.7">${row.chords}</em>`;
    box.appendChild(p);
  }
  $("#preview").innerHTML = "";
  $("#preview").appendChild(box);
  say("üß© ƒê√£ bi√™n d·ªãch preview.");
}

/* ================ EXPORTS ================== */
function exportArt(){
  const title = ($("#title").value||"").trim() || "PiChordify Sheet";
  const lines = $("#lyrics").value.split(/\r?\n/);
  const blob = new Blob([lines.join("\n")], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (title.replace(/\s+/g,"_"))+".art";
  a.click();
  say("üì¶ ƒê√£ xu·∫•t .art");
}

async function exportPDF(){
  try{
    const isPro = await checkPremium();
    if(BACKEND_BASE && !isPro){ return say("‚ÑπÔ∏è C·∫ßn Premium ƒë·ªÉ xu·∫•t PDF."); }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"a4"});
    const title = ($("#title").value||"").trim() || "PiChordify Sheet";
    const data = parseLines($("#lyrics").value||"");
    const off = Number($("#offset").value||0);

    doc.setFontSize(18); doc.text(title, 40, 50);
    doc.setFontSize(12);
    let y = 80;
    data.forEach(r=>{
      const line = `${toMMSS(r.t+off)}   ${r.text}${r.chords?(" / "+r.chords):""}`;
      doc.text(line, 40, y);
      y += 18; if(y > 760){ doc.addPage(); y=50; }
    });
    const fname = title.replace(/\s+/g,"_")+".pdf";
    doc.save(fname);
    say("üìÑ ƒê√£ xu·∫•t PDF.");
  }catch(err){ say("‚ùå PDF l·ªói: "+err.message); }
}

/* ================ DEMO LOADER ================== */
function demoLoad(k){
  $("#title").value = (k===1) ? "T√¨nh y√™u v·ª° √≤a" : "N·∫Øng tr√™n qu√™ h∆∞∆°ng";
  $("#lyrics").value = (k===1)
`00:05  Em ƒë·∫øn nh∆∞ c∆°n m∆∞a / C
00:15  Ru n·ªói nh·ªõ ƒëong ƒë·∫ßy / Am
00:24  Anh h√°t gi·ªØa ban mai / F
00:32  T√¨nh y√™u v·ª° √≤a / G`
:
`00:04  Con ƒë∆∞·ªùng x∆∞a ta qua / D
00:12  Gi√≥ h√°t l·ªùi hi·ªÅn h√≤a / Bm
00:21  N·∫Øng tr√™n qu√™ h∆∞∆°ng / G
00:30  D·∫°t d√†o c√¢u ca / A`;
  compilePreview();
  say("üéº ƒê√£ t·∫£i demo "+k+".");
}

/* ================ DRAG & DROP MP3 ================== */
document.body.addEventListener("dragover", e=>e.preventDefault());
document.body.addEventListener("drop", e=>{
  e.preventDefault();
  const f = e.dataTransfer.files?.[0];
  if(!f) return;
  if(f.type !== "audio/mpeg"){ alert("Vui l√≤ng th·∫£ file .mp3"); return; }
  const blobURL = URL.createObjectURL(f);
  userAudioURL = blobURL;
  $("#urlAudio").value = blobURL;
  say("üéß K√©o-th·∫£ file: "+f.name);
});

/* ================ BOOT ================== */
window.addEventListener("load", ()=>{
  piInit();

  $("#btnLogin").addEventListener("click", piLogin);
  $("#btnCheck").addEventListener("click", checkPremium);
  $("#btnPay").addEventListener("click", payPremium);

  $("#btnLoad1").addEventListener("click", ()=>demoLoad(1));
  $("#btnLoad2").addEventListener("click", ()=>demoLoad(2));
  $("#btnClear").addEventListener("click", ()=>{ $("#title").value=""; $("#lyrics").value=""; $("#preview").textContent=""; });

  $("#btnPreview").addEventListener("click", compilePreview);
  $("#btnExport").addEventListener("click", exportArt);
  $("#btnExportPDF").addEventListener("click", exportPDF);

  $("#btnPlay").addEventListener("click", play);
  $("#btnPause").addEventListener("click", pause);
  $("#btnStop").addEventListener("click", stop);
  $("#btnMetro").addEventListener("click", metronome);

  // Ch·ªçn file mp3
  $("#audioFile").addEventListener("change", (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    if(f.type !== "audio/mpeg"){ alert("Vui l√≤ng ch·ªçn file .mp3"); return; }
    const blobURL = URL.createObjectURL(f);
    userAudioURL = blobURL;
    $("#urlAudio").value = blobURL;
    say("üéß Ch·ªçn file: "+f.name);
  });

  // ƒê·ªìng h·ªì ph√°t
  setInterval(()=>{ const p=ensurePlayer(); $("#clock").textContent = toMMSS(p.currentTime||0); }, 250);

  // G·ª£i √Ω tr·∫°ng th√°i ƒë·∫ßu
  say("üñ§ Ready.");
  say(hasPi ? "‚úÖ Pi SDK kh·∫£ d·ª•ng (n·∫øu trong Pi Browser)." : "‚ÑπÔ∏è Kh√¥ng ·ªü Pi Browser ‚Üí ·∫©n thanh to√°n. V√†o Pi Browser ƒë·ªÉ test SDK.");
  if(!hasPi) $("#btnPay").disabled = true;
});
</script>
</body>
</html>
