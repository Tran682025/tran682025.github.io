<!-- 1) N·∫°p Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<script>
;(function () {
  // ==== C·∫§U H√åNH ====
  const APP_ID   = "pichordifykingdom";       // App ID tr√™n Pi Developer Portal (ƒë·ªïi ƒë√∫ng c·ªßa c·∫≠u)
  const AMOUNT_PI = 0.01;                     // s·ªë Pi thu ph√≠ (test)
  const MEMO      = "Pichordify Premium Export";
  const BASE_API  = "https://pichordifykingdom.workers.dev"; // ƒë·ªïi n·∫øu Worker URL kh√°c

  // Kh·ªüi t·∫°o SDK (g·ªçi 1 l·∫ßn khi trang load)
  window.Pi && window.Pi.init({ version: "2.0", appId: APP_ID });

  // Helper
  async function postJSON(url, data) {
    const r = await fetch(url, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(data)
    });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  // ====== LU·ªíNG THANH TO√ÅN PI ======
  // G·ªçi h√†m n√†y khi b·∫•m n√∫t "Export PDF (Premium)"
  async function payAndUnlockPremium() {
    try {
      // 1) T·∫°o payment tr√™n Pi Wallet
      const paymentData = {
        amount: AMOUNT_PI,
        memo: MEMO,
        metadata: { feature: "export-pdf" },
      };

      const payment = await window.Pi.createPayment(paymentData, {
        // v√≠ s·∫µn s√†ng ch·ªù server approve
        onReadyForServerApproval: async (paymentId) => {
          // 2) Approve tr√™n server (Cloudflare Worker)
          await postJSON(`${BASE_API}/api/pi/approve`, { identifier: paymentId });
        },
        // v√≠ ƒë√£ broadcast xong -> server complete
        onReadyForServerCompletion: async (paymentId, txid) => {
          // 3) Complete tr√™n server
          await postJSON(`${BASE_API}/api/pi/complete`, { identifier: paymentId, txid });
        },
        onCancel: (paymentId) => {
          throw new Error("B·∫°n ƒë√£ hu·ª∑ giao d·ªãch.");
        },
        onError: (err, paymentId) => {
          throw new Error("L·ªói v√≠ Pi: " + (err?.message || err));
        },
      });

      // N·∫øu t·ªõi ƒë√¢y l√† OK
      // üëâ set c·ªù premium, r·ªìi ch·∫°y export PDF nh∆∞ b√¨nh th∆∞·ªùng
      window.__isPremium = true;
      // G·ªåI H√ÄM EXPORT C√ì S·∫¥N C·ª¶A B·∫†N:
      if (typeof window.exportPDF === "function") {
        await window.exportPDF();          // v√≠ d·ª•: h√†m c·∫≠u ƒëang d√πng ƒë·ªÉ xu·∫•t PDF
      } else {
        alert("Thanh to√°n th√†nh c√¥ng. H√£y g·ªçi h√†m export PDF ·ªü ƒë√¢y.");
      }
    } catch (e) {
      alert(e.message || e);
    }
  }

  // ====== G·∫ÆN V√ÄO N√öT ======
  // N·∫øu n√∫t c·ªßa c·∫≠u c√≥ id="btnExportPremium"
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.querySelector("#btnExportPremium");
    if (btn) btn.addEventListener("click", payAndUnlockPremium);
  });

  // (Tu·ª≥ ch·ªçn) H√†m public ƒë·ªÉ g·ªçi ·ªü n∆°i kh√°c
  window.payAndUnlockPremium = payAndUnlockPremium;
})();
</script>
