<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PiChordify Kingdom ‚Äî v7.4</title>
<style>
:root{
  --bg:#0b1120; --card:#111827; --muted:#0c3a3f;
  --text:#e5e7eb; --sub:#94a3b8; --accent:#7c3aed; --accent2:#22d3ee;
  --border:#243146;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 10% 0%, #0f172a, #0b1120 55%),
    linear-gradient(0deg,#0b1120,#0b1120);
}
.wrap{max-width:1200px;margin:24px auto;padding:12px}
.title{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.h1{font-weight:900;font-size:clamp(28px,5vw,48px);letter-spacing:.5px}
.badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:#cbd5e1;font-size:12px}
.rightbar{margin-left:auto;display:flex;align-items:center;gap:10px}
.logoPi{width:42px;height:42px;border-radius:12px;box-shadow:0 0 0 1px #3d2a80 inset}
.grid{display:grid;grid-template-columns:1.2fr .9fr;gap:12px}
@media (max-width:960px){.grid{grid-template-columns:1fr}}
.card{background:#0f172a;border:1px solid var(--border);border-radius:12px;padding:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
label{color:#a5b4fc;font-size:.9rem}
select,input[type="number"],input[type="text"],textarea{
  width:100%; background:#0b1a2b; color:var(--text);
  border:1px solid #334155; border-radius:12px; padding:10px;
}
textarea{min-height:140px;resize:vertical;line-height:1.55}
.range{width:100%}
.btn{background:#111b2b;border:1px solid #334155;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn:hover{outline:1px solid #42526b}
.btn-accent{
  background: linear-gradient(135deg,#6d28d9,#4f46e5,#06b6d4);
  color:white;border-color:#5b21b6;
}
.btn-ghost{background:#0b1a2b}
.pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid #2b3650;border-radius:999px;color:#94a3b8;font-size:12px}
.small{font-size:12px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
#log{min-height:160px;white-space:pre-wrap;overflow:auto;color:#e8ecf1}
button[disabled],.btn:disabled{opacity:1;background:#2a2f3a;color:#e8ecf1 !important;border-color:#394353;cursor:not-allowed}
.split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:960px){.split{grid-template-columns:1fr}}
.iconbtn{display:flex;gap:8px;align-items:center}
.icon24{width:24px;height:24px}
footer{opacity:.7;text-align:center;margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <div class="h1">PiChordify Kingdom</div>
    <span class="badge">v7.4</span>
    <div class="rightbar">
      <!-- SVG logo Pi t√≠m-ng·ªçc -->
      <svg class="logoPi" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#8b5cf6"/>
            <stop offset="1" stop-color="#22d3ee"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="64" height="64" rx="14" fill="#1b1037"/>
        <circle cx="32" cy="32" r="27" fill="url(#g)" opacity=".2"/>
        <path d="M21 20v24h6V20h-6zm16 0v24h6V20h-6zM15 30v6h34v-6H15z" fill="#c4b5fd"/>
      </svg>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label>Gi·ªçng (key)</label>
          <select id="selKey">
            <option>C</option><option>Db</option><option>D</option><option>Eb</option><option>E</option>
            <option>F</option><option>Gb</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Ti·∫øn tr√¨nh</label>
          <select id="selProg">
            <option>I‚ÄìV‚Äìvi‚ÄìIV</option>
            <option>I‚Äìvi‚ÄìIV‚ÄìV</option>
            <option>ii‚ÄìV‚ÄìI</option>
            <option>vi‚ÄìIV‚ÄìI‚ÄìV</option>
            <option>I‚ÄìIV‚ÄìV‚ÄìIV</option>
          </select>
        </div>

        <!-- Nh·∫°c c·ª• -->
        <div style="flex:1">
          <label>Nh·∫°c c·ª•</label>
          <div class="row">
            <button class="btn btn-ghost iconbtn" id="instPiano" data-inst="piano" title="Piano">
              <svg class="icon24" viewBox="0 0 24 24"><rect width="24" height="14" y="5" rx="2" fill="#111827" stroke="#6b7280"/><path d="M3 5v14M9 5v14M15 5v14M21 5v14" stroke="#6b7280"/><rect x="5" y="5" width="2" height="9" fill="#e5e7eb"/><rect x="11" y="5" width="2" height="9" fill="#e5e7eb"/><rect x="17" y="5" width="2" height="9" fill="#e5e7eb"/></svg>
              Piano
            </button>
            <button class="btn btn-ghost iconbtn" id="instGuitar" data-inst="guitar" title="Guitar">
              <svg class="icon24" viewBox="0 0 24 24"><circle cx="9" cy="15" r="5" fill="#7c3aed"/><rect x="12" y="5" width="9" height="4" rx="2" fill="#a78bfa"/><path d="M17 5l4-3 1 1-3 4" stroke="#c4b5fd" stroke-width="1.2"/></svg>
              Guitar
            </button>
            <button class="btn btn-ghost iconbtn" id="instUke" data-inst="ukulele" title="Ukulele">
              <svg class="icon24" viewBox="0 0 24 24"><circle cx="9" cy="15" r="4.5" fill="#22d3ee"/><rect x="12" y="6" width="8" height="3.5" rx="1.6" fill="#67e8f9"/><circle cx="9" cy="15" r="1.6" fill="#0ea5b7"/></svg>
              Ukulele
            </button>
            <span class="pill" id="instLabel">Piano</span>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label>Ti√™u ƒë·ªÅ</label>
          <input id="title" placeholder="T√™n b√†i"/>
        </div>
        <div class="pill small" id="premTag">Premium locked</div>
      </div>

      <div class="split" style="margin-top:10px">
        <div>
          <label>L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî d·∫°ng: mm:ss  Em  /  D)</label>
          <textarea id="lyrics" placeholder="00:12 Em / D ..."></textarea>
        </div>
        <div>
          <label>G·ª£i √Ω h·ª£p √¢m</label>
          <textarea id="suggest" readonly placeholder="Nh·∫•n 'T·ª± g·ª£i √Ω h·ª£p √¢m'..."></textarea>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <label>Audio (mp3)</label>
          <div class="row">
            <input id="audioUrl" placeholder="https://.../song.mp3" style="width:360px;max-width:60vw"/>
            <button class="btn" id="btnPick" title="Ch·ªçn file MP3">Ch·ªçn file</button>
            <input type="file" id="filePicker" accept="audio/*" hidden/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnPlay">Play</button>
          <button class="btn" id="btnPause">Pause</button>
          <button class="btn" id="btnStop">Stop</button>
          <span class="pill small" id="timeLbl">0:00 / 0:00</span>
        </div>
        <input type="range" min="0" max="1000" value="0" id="progress" class="range"/>
        <div class="row">
          <label>BPM</label><input id="bpm" type="number" value="68" style="width:90px"/>
          <label style="margin-left:10px">Offset (gi√¢y, ¬±)</label><input id="offset" type="number" value="0" style="width:110px"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSuggest">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
        <div style="margin-left:auto" class="row">
          <button class="btn" id="btnSave">Save</button>
          <button class="btn" id="btnLoad">Load</button>
          <button class="btn btn-accent" id="btnShare">Share link</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="h5" style="font-weight:700">ƒêƒÉng nh·∫≠p & thanh to√°n</div>
        <span class="pill">Sandbox</span>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnPiLogin">Pi Login</button>
        <button class="btn" id="btnPremium" disabled>Ki·ªÉm tra Premium</button>
        <button class="btn btn-accent" id="btnPiPay">Pi Pay (sandbox)</button>
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <span class="pill small">Console mirror</span>
      </div>
      <div id="log" class="card mono" style="margin-top:6px"></div>
    </div>
  </div>

  <footer>¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù</footer>
</div>

<!-- Hidden audio element -->
<audio id="audio" preload="auto"></audio>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
/* ===== Helpers & logger ===== */
const $ = (id)=>document.getElementById(id);
function log(...args){
  const box = $('log'); if(!box) return;
  const ts = new Date().toTimeString().slice(0,8);
  const line = `[${ts}] `+args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' ');
  box.textContent += (box.textContent? '\\n':'') + line;
  box.scrollTop = box.scrollHeight;
}

/* ===== Chords Engine ===== */
const KEYS = {
C:['C','Dm','Em','F','G','Am','Bdim'], Db:['Db','Ebm','Fm','Gb','Ab','Bbm','Cdim'],
D:['D','Em','F#m','G','A','Bm','C#dim'], Eb:['Eb','Fm','Gm','Ab','Bb','Cm','Ddim'],
E:['E','F#m','G#m','A','B','C#m','D#dim'], F:['F','Gm','Am','Bb','C','Dm','Edim'],
Gb:['Gb','Abm','Bbm','B','Db','Ebm','Fdim'], G:['G','Am','Bm','C','D','Em','F#dim'],
Ab:['Ab','Bbm','Cm','Db','Eb','Fm','Gdim'], A:['A','Bm','C#m','D','E','F#m','G#dim'],
Bb:['Bb','Cm','Dm','Eb','F','Gm','Adim'], B:['B','C#m','D#m','E','F#','G#m','A#dim'],
};
const DEG = {'I':0,'ii':1,'iii':2,'IV':3,'V':4,'vi':5,'VII¬∞':6};

function suggestChords(){
  const key = $('selKey').value;
  const prog = $('selProg').value;               // v√≠ d·ª•: I‚ÄìV‚Äìvi‚ÄìIV
  const parts = prog.replace(/\s+/g,'').split(/[‚Äì-]/g);
  const bank = KEYS[key] || KEYS.C;
  const out = parts.map(p=>{
    const d = DEG[p] ?? null; return d==null ? '?' : bank[d];
  }).join(' ¬∑ ');
  $('suggest').value = `${key} major ¬∑ ${prog}\\n${out}`;
  log('üéº suggest:', out);
}

/* ===== Audio ===== */
const audio = $('audio'), progress = $('progress'), timeLbl = $('timeLbl'), audioUrl=$('audioUrl');

audio.addEventListener('timeupdate', ()=>{
  if(isFinite(audio.duration)){
    progress.value = Math.floor(1000*audio.currentTime/audio.duration);
    timeLbl.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`;
  }
});
audio.addEventListener('ended', ()=>{$('btnPlay').textContent='Play';});
progress.addEventListener('input', ()=>{
  if(!isFinite(audio.duration)) return;
  audio.currentTime = (progress.value/1000)*audio.duration;
});

function fmt(n){ const m=Math.floor(n/60), s=Math.floor(n%60).toString().padStart(2,'0'); return `${m}:${s}`; }
function setSrc(url){
  audio.src = url; audio.crossOrigin='anonymous';
  audio.play().catch(()=>{}); $('btnPlay').textContent='Pause';
}

$('btnPlay').addEventListener('click', ()=>{
  if(audio.paused){ audio.play(); $('btnPlay').textContent='Pause'; }
  else { audio.pause(); $('btnPlay').textContent='Play'; }
});
$('btnPause').addEventListener('click', ()=>{ audio.pause(); $('btnPlay').textContent='Play'; });
$('btnStop').addEventListener('click', ()=>{ audio.pause(); audio.currentTime=0; $('btnPlay').textContent='Play'; });

$('btnPick').addEventListener('click', ()=>$('filePicker').click());
$('filePicker').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  audioUrl.value = f.name; setSrc(url);
});
audioUrl.addEventListener('change', ()=>{ if(audioUrl.value.trim()) setSrc(audioUrl.value.trim()); });

/* ===== Save/Load/Share ===== */
const LSKEY='pichordify_state';
function stateObj(){
  return {
    title:$('title').value, key:$('selKey').value, prog:$('selProg').value,
    inst:$('instLabel').textContent, lyrics:$('lyrics').value, suggest:$('suggest').value,
    url:$('audioUrl').value, bpm:$('bpm').value, offset:$('offset').value
  };
}
function apply(obj){
  if(!obj) return;
  $('title').value=obj.title||''; $('selKey').value=obj.key||'C';
  $('selProg').value=obj.prog||'I‚ÄìV‚Äìvi‚ÄìIV'; $('instLabel').textContent=obj.inst||'Piano';
  $('lyrics').value=obj.lyrics||''; $('suggest').value=obj.suggest||'';
  $('audioUrl').value=obj.url||''; $('bpm').value=obj.bpm||'68'; $('offset').value=obj.offset||'0';
}
$('btnSave').addEventListener('click', ()=>{ localStorage.setItem(LSKEY, JSON.stringify(stateObj())); log('üíæ save ok'); });
$('btnLoad').addEventListener('click', ()=>{ const s=localStorage.getItem(LSKEY); if(s){ apply(JSON.parse(s)); log('üìÇ load ok'); } else log('‚ö†Ô∏è ch∆∞a c√≥ d·ªØ li·ªáu'); });
$('btnShare').addEventListener('click', ()=>{
  const enc = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(stateObj())))));
  const url = location.origin+location.pathname+'#'+enc; navigator.clipboard.writeText(url);
  log('üîó copied share link'); });

(function tryOpen(){
  const m=location.hash.match(/#(.+)/); if(!m) return;
  try{ const o=JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(m[1]))))); apply(o); log('üîì opened from share link'); }
  catch(e){ log('‚ùå open share',e.message); }
})();

/* ===== Instrument select ===== */
let currentInst='piano';
function pickInst(inst){
  currentInst=inst;
  $('instLabel').textContent = inst.charAt(0).toUpperCase()+inst.slice(1);
  ['instPiano','instGuitar','instUke'].forEach(id=>{
    $(id).style.outline = id.toLowerCase().includes(inst)? '2px solid #7c3aed':'none';
  });
}
$('instPiano').onclick=()=>pickInst('piano');
$('instGuitar').onclick=()=>pickInst('guitar');
$('instUke').onclick=()=>pickInst('ukulele');

/* ===== Pi SDK & Payments (sandbox) ===== */
async function initPi(){
  try{
    await Pi.init({ version:'2.0', sandbox:true });
    log('üü£ Ready (Pi SDK loaded)');
    log('‚úÖ Pi SDK initialized (sandbox)');
    // nh·∫≠n di·ªán Pi Browser (n·∫øu kh√¥ng c√≥ v·∫´n cho test sandbox)
    const isPI = !!window.Pi;
    const inPiBrowser = isPI && Pi.isPiBrowser?.()===true;
    if(!inPiBrowser){ log('‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c Pi Browser ‚Äî v·∫´n cho ph√©p test sandbox.'); }
  }catch(e){ log('‚ùå Pi init', e.message); }
}

async function piLogin(){
  try{
    const scopes=['payments','username','wallet_address'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
    log('üîê Login OK:', auth.user?.username||'(unknown)');
    return auth;
  }catch(e){ log('‚ùå Login', e.message); }
}

async function piPaySandbox(amount=0.01){
  try{
    const auth = await piLogin(); if(!auth) return;
    const pay = await Pi.createPayment({
      amount:String(amount),
      memo:'PiChordify v7.4 sandbox test',
      metadata:{feature:'premium', ver:'7.4'},
      callbacks:{
        onReadyForServerApproval:(pid)=>log('ü™ô readyForApproval', pid),
        onReadyForServerCompletion:(pid,txid)=>{ log('‚úÖ completed', pid, txid); premiumOn(); },
        onCancel:(pid)=>log('üö´ canceled', pid),
        onError:(err)=>log('‚ö†Ô∏è onError', err?.message||err),
      },
    });
    log('üëâ createPayment ->', pay);
  }catch(e){ log('‚ùå Payment', e.message); }
}
function onIncompletePaymentFound(p){ log('‚ö†Ô∏è incomplete payment:', p?.identifier||p); }
function premiumOn(){ $('premTag').textContent='Premium unlocked'; }

/* ===== Wire UI ===== */
$('btnSuggest').addEventListener('click', suggestChords);
$('btnPiLogin').addEventListener('click', piLogin);
$('btnPiPay').addEventListener('click', ()=>piPaySandbox(0.01));

/* ===== Boot ===== */
window.addEventListener('load', ()=>{
  suggestChords(); pickInst('piano'); initPi(); log('Ready');
});
</script>
</body>
</html>
