<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pichordify Kingdom ‚Äì Premium Demo</title>
  <style>
    :root { --pri:#6b46ff; --bg:#f6f3ff; --ok:#12b886; --err:#ef4444; }
    *{box-sizing:border-box} body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto}
    header{padding:16px 20px;background:var(--bg);display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px;color:#5526ff}
    header .badge{padding:4px 10px;border-radius:999px;background:#e9d8fd;color:#4c1d95;font-weight:600}
    main{max-width:920px;margin:24px auto;padding:0 16px}
    .row{display:grid;grid-template-columns:1fr 320px;gap:16px}
    textarea{width:100%;height:280px;padding:12px;border:1px solid #ddd;border-radius:12px}
    .panel{border:1px solid #eee;border-radius:16px;padding:14px;display:grid;gap:10px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .btn.pri{background:var(--pri);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #ddd}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.err{background:var(--err);color:#fff}
    .muted{color:#666;font-size:13px}
    .status{padding:10px 12px;border-radius:10px;background:#fafafa;border:1px dashed #ddd;font-family:ui-monospace,Consolas,monospace;white-space:pre-wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  </style>
  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <header>
    <h1>Pichordify Kingdom</h1>
    <span class="badge">Premium</span>
  </header>

  <main>
    <div class="row">
      <section>
        <label class="muted">Ti√™u ƒë·ªÅ</label>
        <input id="title" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:12px" value="T√¨nh N·ªìng Vi·ªát Kh√∫c Lan (sample)" />
        <div style="height:8px"></div>
        <label class="muted">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian)</label>
        <textarea id="lyrics">00:00 Am
00:05 F
00:10 C
00:15 G
00:20 Dm
00:25 E
00:30 Am</textarea>

        <div style="height:14px"></div>
        <div class="grid2">
          <button class="btn ghost" id="btnExportSrt">Export .srt (hi·ªán t·∫°i)</button>
          <button class="btn pri"   id="btnExportPdf">Export PDF (Premium)</button>
        </div>
        <div style="height:10px"></div>
        <div class="muted">G·ª£i √Ω: b·∫•m ‚ÄúExport PDF (Premium)‚Äù l·∫ßn ƒë·∫ßu s·∫Ω m·ªü v√≠ Pi ƒë·ªÉ thanh to√°n 0.01&nbsp;œÄ (demo), xong l√† m·ªü kh√≥a xu·∫•t PDF.</div>
      </section>

      <aside class="panel">
        <strong>Tr·∫°ng th√°i</strong>
        <div id="status" class="status">ƒêang kh·ªüi t·∫°o‚Ä¶</div>
        <div class="grid2">
          <button id="btnCheck" class="btn ghost">Ki·ªÉm tra Premium</button>
          <button id="btnLogin" class="btn ghost">Pi Login</button>
        </div>
        <div class="grid2">
          <button id="btnPay" class="btn ok">Thanh to√°n Premium</button>
          <button id="btnReset" class="btn err">Reset tr·∫°ng th√°i</button>
        </div>
        <div class="muted">N·∫øu kh√¥ng ch·∫°y trong Pi Browser, v·∫´n c√≥ th·ªÉ test flow: ƒëƒÉng nh·∫≠p ‚ûù thanh to√°n ‚ûù approve/complete qua Worker.</div>
      </aside>
    </div>
  </main>

  <script>
    /* ========= C·∫§U H√åNH B·∫ÆT BU·ªòC ========= */
    // ƒêi·ªÅn App ID c·ªßa c·∫≠u (Pi Dev Portal ‚Üí App ID / PiNet subdomain)
    const PI_APP_ID  = "pichordifykingdom7723"; // <-- THAY B·∫∞NG C·ª¶A C·∫¨U
    // Origin c·ªßa Cloudflare Worker backend (kh√¥ng c√≥ slash cu·ªëi)
    const WORKER_BASE = "https://pichordify-kingdom.workers.dev"; // <-- THAY B·∫∞NG C·ª¶A C·∫¨U

    /* ======== TI·ªÜN √çCH NH·ªé ======== */
    const $ = sel => document.querySelector(sel);
    const log = (...a)=>{ console.log(...a); appendStatus(a.map(x=>typeof x==='object'?JSON.stringify(x):x).join(' ')); }
    function appendStatus(line){
      const box = $('#status');
      box.textContent = (box.textContent ? box.textContent + "\n" : "") + line;
      box.scrollTop = box.scrollHeight;
    }
    function setStatus(text){ $('#status').textContent = text; }

    /* ======== STATE ======== */
    let accessToken = null;        // token sau khi Pi.authenticate()
    let premiumUnlocked = false;   // ƒë√£ m·ªü kh√≥a Premium sau khi complete
    const AMOUNT = 0.01;           // s·ªë Pi demo

    /* ======== KH·ªûI T·∫†O SDK ======== */
    try {
      Pi.init({ version: "2.0", sandbox: false }); // n·∫øu testnet, ƒë·ªïi sandbox:true
      Pi.authenticate && log("Pi SDK s·∫µn s√†ng.");
    } catch (e) {
      log("Kh√¥ng kh·ªüi t·∫°o ƒë∆∞·ª£c Pi SDK (c√≥ th·ªÉ kh√¥ng ch·∫°y trong Pi Browser).", e.message||e);
    }

    /* ======== H√ÄM LOGIN L·∫§Y accessToken ======== */
    async function piLogin(){
      try{
        const scopes = ['username','payments'];
        const res = await Pi.authenticate(scopes, onIncompletePaymentFound);
        accessToken = res?.accessToken || res?.authResult?.accessToken || null;
        log("ƒêƒÉng nh·∫≠p OK. C√≥ accessToken:", !!accessToken);
        return accessToken;
      }catch(e){
        log("Login l·ªói:", e?.message||e);
        throw e;
      }
    }
    function onIncompletePaymentFound(payment){ 
      log("onIncompletePaymentFound:", payment?.identifier || "");
    }

    /* ======== G·ªåI BACKEND ======== */
    async function callWorker(path, payload){
      const url = `${WORKER_BASE}${path}`;
      const r = await fetch(url, {
        method: "POST",
        headers: {
          "content-type":"application/json",
          // Pi y√™u c·∫ßu Bearer token t·ª´ Pi.authenticate ƒë·ªÉ backend x√°c minh
          ...(accessToken ? { "Authorization": `Bearer ${accessToken}` } : {})
        },
        body: JSON.stringify(payload||{})
      });
      if(!r.ok){
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      return r.json();
    }

    /* ======== T·∫†O THANH TO√ÅN ======== */
    async function payPremium(){
      if(!accessToken) await piLogin();

      return new Promise((resolve,reject)=>{
        Pi.createPayment(
          {
            amount: AMOUNT,
            memo: "Pichordify Premium ‚Äì Export PDF",
            metadata: { feature: "export_pdf", ts: Date.now() }
          },
          {
            onReadyForServerApproval: async (paymentId) => {
              try{
                log("onReadyForServerApproval:", paymentId);
                const ok = await callWorker("/api/pi/approve", { paymentId });
                log("approve ->", JSON.stringify(ok));
              }catch(e){ log("approve l·ªói:", e.message||e); reject(e); }
            },
            onReadyForServerCompletion: async (paymentId, txId) => {
              try{
                log("onReadyForServerCompletion:", paymentId, txId);
                const ok = await callWorker("/api/pi/complete", { paymentId, txId });
                log("complete ->", JSON.stringify(ok));
                premiumUnlocked = true;
                setStatus("‚úÖ Thanh to√°n xong, Premium ƒë√£ m·ªü kh√≥a!");
                resolve({ paymentId, txId });
              }catch(e){ log("complete l·ªói:", e.message||e); reject(e); }
            },
            onCancel: (reason) => { log("‚õî H·ªßy thanh to√°n:", reason||""); reject(new Error("cancelled")); },
            onError:  (err)    => { log("‚ùå L·ªói thanh to√°n:", err?.message||err); reject(err); },
          }
        );
      });
    }

    /* ======== CH·ª®C NƒÇNG DEMO EXPORT ======== */
    function exportSrtNow(){
      // demo xu·∫•t .srt hi·ªán t·∫°i (client)
      const title = $('#title').value.trim() || "Untitled";
      const lines = $('#lyrics').value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      const srt = lines.map((ln,i)=>{
        // chuy·ªÉn "00:05 F" -> block srt th√¥
        const [t, chord] = ln.split(/\s+/,2);
        const start = t + ",000";
        // +2s gi·∫£ l·∫≠p
        const ss = t.split(':').map(Number);
        const endSec = (ss[0]*60 + ss[1] + 2);
        const end = `${String(Math.floor(endSec/60)).padStart(2,'0')}:${String(endSec%60).padStart(2,'0')}:00,000`;
        return `${i+1}\n00:${start} --> 00:${end}\n${chord||''}\n`;
      }).join("\n");
      download(`${title}.srt`, srt);
      setStatus("ƒê√£ xu·∫•t .srt (demo).");
    }

    async function exportPdfPremium(){
      if(!premiumUnlocked){
        setStatus("C·∫ßn thanh to√°n Premium tr∆∞·ªõc khi xu·∫•t PDF‚Ä¶");
        try{
          await payPremium();
        }catch(e){
          setStatus("Thanh to√°n ch∆∞a xong. Kh√¥ng th·ªÉ export PDF.");
          return;
        }
      }
      // ·ªû ƒë√¢y g·ªçi logic export PDF th·∫≠t c·ªßa c·∫≠u (client ho·∫∑c g·ªçi Worker)
      // Demo: t·∫°o file txt gi·∫£ thay cho PDF
      const title = $('#title').value.trim() || "Untitled";
      const txt = `Pichordify Premium PDF (demo)\nTitle: ${title}\nItems: ${$('#lyrics').value.split(/\r?\n/).length}`;
      download(`${title}.pdf.txt`, txt);
      setStatus("‚úÖ ƒê√£ t·∫£i PDF (demo).");
    }

    function download(filename, content){
      const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    /* ======== ‚ÄúKI·ªÇM TRA PREMIUM‚Äù (t√πy ch·ªçn) ======== 
       N·∫øu c·∫≠u ƒë√£ vi·∫øt endpoint /api/premium/status trong Worker,
       b·∫≠t h√†m d∆∞·ªõi ƒë·ªÉ ki·ªÉm tra b·∫±ng X-Key ho·∫∑c Authorization.
    */
    async function checkPremium(){
      try{
        // v√≠ d·ª•: d√πng Authorization (accessToken) n·∫øu backend x√°c th·ª±c qua Pi
        if(!accessToken) await piLogin();
        const r = await fetch(`${WORKER_BASE}/api/premium/status`, {
          headers: { "Authorization": `Bearer ${accessToken}` }
        });
        const j = await r.json().catch(()=>({}));
        log("premium status:", JSON.stringify(j));
        if(j?.ok && j?.premium) {
          premiumUnlocked = true;
          setStatus("üîì Premium ƒë√£ ƒë∆∞·ª£c m·ªü s·∫µn theo backend.");
        } else {
          setStatus("üîí Ch∆∞a c√≥ Premium. H√£y thanh to√°n.");
        }
      }catch(e){
        log("checkPremium l·ªói:", e.message||e);
      }
    }

    /* ======== G√ÅN N√öT ======== */
    $('#btnExportSrt').onclick = exportSrtNow;
    $('#btnExportPdf').onclick = exportPdfPremium;
    $('#btnLogin').onclick    = piLogin;
    $('#btnPay').onclick      = payPremium;
    $('#btnCheck').onclick    = checkPremium;
    $('#btnReset').onclick    = ()=>{ premiumUnlocked=false; setStatus("ƒê√£ reset premiumUnlocked = false"); }

    // Kh·ªüi ƒë·ªông nh·∫π
    (async ()=>{
      setStatus("S·∫µn s√†ng. ƒêi·ªÅn c·∫•u h√¨nh ·ªü ƒë·∫ßu script n·∫øu ch∆∞a.");
    })();
  </script>
</body>
</html>
