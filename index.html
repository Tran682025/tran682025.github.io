<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>[FULL DEBUG] Tranmusickingdom Pi App</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    h1 { margin-bottom: 20px; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #log { background: #f5f5f5; padding: 10px; margin-top: 20px; text-align: left;
           border-radius: 8px; width: 90%; max-width: 600px; margin-left: auto; margin-right: auto;
           white-space: pre-wrap; font-size: 14px; }
  </style>
</head>
<body>
  <h1>[FULL DEBUG] Tranmusickingdom Pi App</h1>
  <button onclick="login()">ƒêƒÉng nh·∫≠p b·∫±ng Pi</button>
  <button onclick="pay()">Thanh to√°n 0.01 Pi</button>
  <div id="log">[LOG b·∫Øt ƒë·∫ßu...]\n</div>

  <script>
    let authUser = null; // L∆∞u th√¥ng tin login
    function addLog(msg) {
      console.log(msg);
      document.getElementById('log').textContent += msg + "\n";
    }

    // --- Kh·ªüi t·∫°o SDK ---
    try {
      addLog("üîÑ B∆∞·ªõc 1: ƒêang kh·ªüi t·∫°o Pi SDK...");
      Pi.init({ version: "2.0", sandbox: true });
      addLog("‚úÖ B∆∞·ªõc 2: Pi SDK ƒë√£ kh·ªüi t·∫°o th√†nh c√¥ng (sandbox: true).");
    } catch (e) {
      addLog("‚ùå L·ªói init Pi SDK: " + e);
    }

    // --- H√†m login ---
    function login() {
      addLog("‚ñ∂ B∆∞·ªõc 3: G·ªçi Pi.authenticate()...");
      alert("B·∫Øt ƒë·∫ßu login...");
      const scopes = ['username', 'payments'];
      const onIncompletePaymentFound = (payment) => {
        addLog("üîç Incomplete payment found: " + JSON.stringify(payment));
      };

      try {
        Pi.authenticate(scopes, onIncompletePaymentFound)
          .then(auth => {
            authUser = auth;
            addLog("‚úÖ B∆∞·ªõc 4: Login th√†nh c√¥ng: " + JSON.stringify(auth));
            alert("Xin ch√†o, " + auth.user.username);
          })
          .catch(err => {
            addLog("‚ùå B∆∞·ªõc 4: Login th·∫•t b·∫°i: " + err);
            alert("Login th·∫•t b·∫°i: " + err);
          });
      } catch (e) {
        addLog("‚ùå JS Error trong login(): " + e);
      }
    }

    // --- H√†m thanh to√°n ---
    function pay() {
      if (!authUser) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi thanh to√°n.");
        addLog("‚ö† Kh√¥ng th·ªÉ thanh to√°n: ch∆∞a login.");
        return;
      }
      addLog("‚ñ∂ B∆∞·ªõc 5: B·∫Øt ƒë·∫ßu thanh to√°n test...");
      alert("B·∫Øt ƒë·∫ßu thanh to√°n test...");

      const paymentData = {
        amount: 0.01,
        memo: "Thanh to√°n test sandbox",
        metadata: { orderId: 1234 }
      };

      try {
        Pi.createPayment(paymentData, {
          onReadyForServerApproval: (paymentId) => addLog("‚û° B∆∞·ªõc 6: onReadyForServerApproval: " + paymentId),
          onReadyForServerCompletion: (paymentId, txid) => addLog("‚úÖ B∆∞·ªõc 7: onReadyForServerCompletion: " + paymentId + " | txid: " + txid),
          onCancel: (paymentId) => addLog("‚ö† B∆∞·ªõc 8: Payment cancelled: " + paymentId),
          onError: (error, paymentId) => addLog("‚ùå B∆∞·ªõc 9: Payment error: " + error + " | paymentId: " + paymentId)
        });
      } catch (e) {
        addLog("‚ùå L·ªói JS trong pay(): " + e);
      }
    }
  </script>
</body>
</html>
