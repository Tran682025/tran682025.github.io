<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiChordify Kingdom</title>
  <link rel="icon" href="data:,"/>
  <style>
    :root{--pi:#7b2bf9;--ink:#261b39;--bg:#f3eaff}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:920px;margin:24px auto;padding:16px}
    .note{opacity:.7;margin:8px 0;font-size:14px;letter-spacing:.5px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);
      padding:16px;margin:14px 0}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{border:0;background:var(--pi);color:#fff;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-outline{background:#fff;color:var(--pi);border:2px solid var(--pi)}
    .mono{font-family:ui-monospace,Consolas,monospace}
    label{font-size:14px;opacity:.9}
    input,select{padding:10px;border:1px solid #ddd;border-radius:10px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eee;margin:4px;font-family:ui-monospace,Consolas,monospace}
    .muted{opacity:.65}
    .chords{line-height:1.9}
    .eagle{font-weight:800;letter-spacing:.6px}
  </style>

  <!-- Pi SDK v2 -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>PiChordify <span class="eagle">Kingdom</span></h1>
    <div class="note">
      Báº£n minh hoáº¡ <b>thanh toÃ¡n Pi</b> + <b>má»Ÿ khoÃ¡ há»£p Ã¢m</b> kÃ¨m transposer.
      <span class="muted mono">Máº¹o: thÃªm <code>?sandbox=1</code> vÃ o URL khi test Sandbox (Pi Browser).</span>
    </div>

    <!-- ÄÄƒng nháº­p & tráº¡ng thÃ¡i -->
    <div class="card">
      <div class="row" style="margin-top:2px">
        <button id="loginBtn">ğŸ” ÄÄƒng nháº­p vá»›i Pi</button>
        <button id="logoutBtn" class="btn-outline">ğŸšª ÄÄƒng xuáº¥t</button>
        <div id="hello" class="pill mono">ChÆ°a Ä‘Äƒng nháº­p</div>
      </div>

      <div style="margin-top:10px">
        <b>Premium:</b>
        <span id="premium-status" class="pill">ğŸ”’ ChÆ°a mua Premium</span>
      </div>

      <div style="margin-top:10px">
        <button id="buyBtn">ğŸ’ Mua Premium â€” 1 Pi</button>
        <span class="muted mono">Giao dá»‹ch gá»i Worker <code>/approve</code> & <code>/complete</code>.</span>
      </div>
    </div>

    <!-- Transposer & Há»£p Ã¢m -->
    <div class="card">
      <div class="row">
        <div>
          <label for="songSel">Chá»n bÃ i: </label>
          <select id="songSel"></select>
        </div>
        <div>
          <label for="shiftInp">Transpose (semitones): </label>
          <input id="shiftInp" class="mono" type="number" value="0" step="1" style="width:120px"/>
        </div>
        <button id="applyBtn" class="btn-outline">Ãp dá»¥ng</button>
      </div>
      <div id="lockMsg" class="note" style="margin-top:8px;display:none">
        ğŸ”’ ÄÃ¢y lÃ  ná»™i dung Premium. HÃ£y mua Ä‘á»ƒ má»Ÿ khoÃ¡ hÆ¡n 100+ tune (demo).
      </div>
      <div id="chords" class="chords" style="margin-top:12px"></div>
    </div>

    <div class="note">
      ğŸ¦… <b>Backend:</b> <code>https://pichordify-worker.pichordifykingdom.workers.dev</code>
      â†’ cÃ¡c endpoint <code>/approve</code>, <code>/complete</code>.
    </div>
  </div>

  <script>
  // ========= CONFIG =========
  // ğŸ‘‰ ÄÃºng tÃªn Worker cá»§a Tráº«m (theo logs deploy)
  const WORKER_BASE = 'https://pichordify-worker.pichordifykingdom.workers.dev';
  // Sandbox switch: ?sandbox=1
  const url = new URL(location.href);
  const forceSandbox = url.searchParams.get('sandbox') === '1';

  // ========= Pi SDK init =========
  try {
    if (!window.Pi || !Pi.init) throw new Error('Pi SDK chÆ°a sáºµn sÃ ng. Má»Ÿ báº±ng Pi Browser.');
    Pi.init({ version: "2.0", sandbox: forceSandbox });
  } catch(e){ console.warn(e); alert(e.message||e); }

  // ========= Mini songbook (demo) =========
  const SONGS = {
    free: [
      { id:'free_001', title:'Happy Day (Free)', lines:['C  G  Am  F','C  G  Am  F','F  G  C   -'] },
      { id:'free_002', title:'Sunny Road (Free)', lines:['Dm  G  C  Am','Dm  G  C  C','F   G  Em Am'] }
    ],
    premium: [
      { id:'pro_101', title:'Kingdom Anthem (Pro)', lines:['G   D   Em   C','G   D   C    C','Am  D   G    -'] },
      { id:'pro_102', title:'Eagle Flight (Pro)',  lines:['Bm  G  D  A','Bm  G  D  A','Em  A  D  -'] }
    ]
  };
  const ALL_SONGS = [...SONGS.free, ...SONGS.premium];
  const PREMIUM_IDS = new Set(SONGS.premium.map(s=>s.id));

  // ========= Helpers =========
  const $ = sel => document.querySelector(sel);
  const ORDER = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

  const isPremium = () => localStorage.getItem('pck_premium') === 'true';
  function updatePremiumStatus(flag){
    const el = $('#premium-status');
    if(flag){ el.textContent='âœ… ÄÃ£ mua Premium'; el.classList.add('pill'); }
    else     el.textContent='ğŸ”’ ChÆ°a mua Premium';
  }

  function transposeChord(ch, shift){
    const m = ch.match(/^([A-G](?:#|b)?)(.*)$/);
    if(!m) return ch;
    let [_, root, tail] = m;
    const flat = {Db:'C#', Eb:'D#', Gb:'F#', Ab:'G%', Bb:'A#'}; // Ab displayed as G%
    if(flat[root]) root = flat[root].replace('%','#');
    const idx = ORDER.indexOf(root);
    if(idx<0) return ch;
    const next = ORDER[(idx + shift + 12*1000) % 12];
    return next + tail;
  }
  const transposeLine = (line, shift) =>
    !shift ? line : line.split(/\s+/).map(tok => tok && transposeChord(tok, shift)).join('  ');

  function renderBasicChords(songObj){
    const shift = parseInt($('#shiftInp').value||'0',10);
    const html = songObj.lines.map(l => `<div class="mono">${transposeLine(l, shift)}</div>`).join('');
    $('#chords').innerHTML = html;
  }

  function buildSongSelect(){
    const sel = $('#songSel'); sel.innerHTML = '';
    ALL_SONGS.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.title + (PREMIUM_IDS.has(s.id)?' ğŸ”’':'');
      sel.appendChild(opt);
    });
    sel.value = ALL_SONGS[0].id;
  }

  function getSelectedSong(){
    const id = $('#songSel').value;
    return ALL_SONGS.find(s => s.id === id);
  }

  function renderSong(){
    const s = getSelectedSong();
    const locked = PREMIUM_IDS.has(s.id) && !isPremium();
    $('#lockMsg').style.display = locked ? 'block' : 'none';
    if (locked){
      $('#chords').innerHTML = `<div class="mono">ğŸ”’ Ná»™i dung Premium â€” hÃ£y mua Ä‘á»ƒ má»Ÿ khoÃ¡.</div>`;
      return;
    }
    renderBasicChords(s);
  }

  // ========= Backend call (Worker) =========
  async function callAPI(path, body){
    const r = await fetch(`${WORKER_BASE}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      credentials: 'omit',
      mode: 'cors'
    });
    const text = await r.text();
    try { return JSON.parse(text); } catch { if(!r.ok) throw new Error(text||r.statusText); return {}; }
  }

  // ========= Auth =========
  async function login(){
    try{
      const scopes = ['username','payments'];
      const auth = await Pi.authenticate(scopes, p => console.log('Incomplete payment:', p));
      $('#hello').textContent = `Xin chÃ o: @${auth.user.username} ğŸµ`;
      alert('ÄÄƒng nháº­p thÃ nh cÃ´ng!');
    }catch(e){
      alert('ÄÄƒng nháº­p tháº¥t báº¡i: ' + (e?.message||e));
    }
  }
  function logout(){ $('#hello').textContent = 'ChÆ°a Ä‘Äƒng nháº­p'; }

  // ========= Payment (Premium) =========
  async function payPremium(){
    try{
      await Pi.createPayment({
        amount: 1,
        memo: 'PiChordify Premium Access',
        metadata: { type:'premium', item:'access' }
      }, {
        onReadyForServerApproval: async function (paymentId) {
          await callAPI('/approve', { paymentId });
        },
        onReadyForServerCompletion: async function (paymentId, txid) {
          await callAPI('/complete', { paymentId, txid });
          localStorage.setItem('pck_premium','true');
          updatePremiumStatus(true);
          renderSong();
          alert('Thanh toÃ¡n thÃ nh cÃ´ng âœ…');
        },
        onCancel: function () { alert('ÄÃ£ huá»· thanh toÃ¡n.'); },
        onError: function (error) { alert('Lá»—i thanh toÃ¡n: ' + (error?.message||error)); }
      });
    }catch(e){
      alert('CÃ³ lá»—i khi mua Premium: ' + (e?.message||e));
    }
  }

  // ========= UI bindings =========
  $('#loginBtn').onclick = login;
  $('#logoutBtn').onclick = logout;
  $('#buyBtn').onclick = payPremium;
  $('#applyBtn').onclick = renderSong;
  $('#songSel').onchange = renderSong;

  // ========= Init view =========
  buildSongSelect();
  updatePremiumStatus(isPremium());
  renderSong();
  </script>
</body>
</html>
