
<!doctype html>  
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PiChordify Kingdom ‚Äî v7.6</title>

<!-- ===== Palette / Reset ===== -->
<style>
:root{
  --bg:#0f1320; --panel:#131a2a; --muted:#8892b0; --text:#e6e9ef;
  --brand1:#8a5cff; --brand2:#49c6ff; --accent:#9b7bff; --ok:#24d17e; --warn:#ffb347; --err:#ff5d73;
  --ring:rgba(138,92,255,.35);
  --mono:"SFMono-Regular","JetBrains Mono",ui-monospace,Consolas,monospace;
  --sans:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Noto Sans",sans-serif;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:var(--sans)}
h1,h2,h3{margin:0 0 .5rem}
small{color:var(--muted)}
a{color:var(--brand2);text-decoration:none}
.wrap{max-width:1200px;margin:auto;padding:20px}
.grid{display:grid;gap:16px}
@media(min-width:970px){.grid{grid-template-columns:1.2fr .9fr}}

.card{background:var(--panel);border:1px solid #1b2236;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
select,input,button,textarea{background:#0c1322;color:var(--text);border:1px solid #25304d;border-radius:12px;padding:10px 12px;font-size:15px}
select,input,textarea{outline:none}
select:focus,input:focus,textarea:focus,button:focus{box-shadow:0 0 0 3px var(--ring);border-color:#3b4b77}
button{cursor:pointer}
.btn{background:linear-gradient(90deg,var(--brand1),var(--brand2));border:none}
.btn.ghost{background:#0c1322}
.btn.bad{background:#2a0f18;border:1px solid #4b1122}
.btn.ok{background:#0f2a22;border:1px solid #11553c}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0e1629;border:1px solid #232e4a;font-size:13px;color:#cfd6e6}

h1.title{font-weight:800;letter-spacing:.5px;font-size:42px;line-height:1.05}
.ver{margin-left:10px;border-radius:999px;padding:6px 10px;background:#1a2033;border:1px solid #2a365d;color:#bfc7de;font-weight:600}

.mono{font-family:var(--mono);white-space:pre-wrap}
textarea{min-height:160px;width:100%;resize:vertical}
#suggest{min-height:112px}
.progress{height:8px;border-radius:999px;background:#0c1322;border:1px solid #25304d;position:relative}
.progress>i{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,#3e5cf5,#34d1ff);border-radius:999px}
.kbd{padding:2px 6px;border-radius:6px;border:1px solid #2a2f45;background:#0e1324;font-family:var(--mono);font-size:12px;color:#c6cee1}
.iconTab{display:flex;gap:10px}
.iconTab button{flex:1;display:flex;align-items:center;gap:10px;justify-content:center;padding:12px;border-radius:14px;background:#0e1629;border:1px solid #252c44}
.iconTab button.active{outline:2px solid var(--ring);border-color:#3b48ff;background:#121a30}
.iconTab img{height:18px;opacity:.9}
.rightBox{min-height:320px}
.hidden{display:none}
.small{font-size:13px;color:#9fb0d1}

/* === MK HERO (Musickingdom header) =================== */

.mk-hero {
  position: relative;
  padding: 2.5rem 1.5rem 2rem;
  background-image:
    linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(76, 29, 149, 0.96)),
    url("assets/musickingdom-christmas-bg.jpg");
  background-size: cover;
  background-position: center;
  border-bottom: 1px solid rgba(148, 163, 184, 0.4);
}

.mk-hero-inner {
  max-width: 960px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 1.75rem;
}

.mk-title-gradient{
  background:linear-gradient(90deg,#ff7bd5 0%,#6ea8ff 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.mk-hero-text h1 {
  margin: 0 0 0.35rem;
  font-size: clamp(1.9rem, 2.6vw, 2.4rem);
  font-weight: 800;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

.mk-hero-text p {
  margin: 0;
  color: #e5e7eb;
  font-size: 0.98rem;
  max-width: 30rem;
  line-height: 1.55;
}

/* Icon R√πa c·∫°nh version */
.mk-version-icon{
  width:46px;
  height:auto;
  margin-left:10px;
  border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,0.35);
  vertical-align:middle;
}
@media(min-width:768px){
  .mk-version-icon{width:56px;}
}
</style>
</head>

<body>

<header class="mk-hero">
  <div class="mk-hero-inner">
    <div class="mk-hero-text">
      <h1 class="mk-title-gradient">MUSICKINGDOM</h1>
      <p>
        C√¥ng c·ª• g·ª£i √Ω h·ª£p √¢m &amp; luy·ªán h√°t trong h·ªá sinh th√°i Pi ‚Äì
        kh√¥ng gian th·ªù ph∆∞·ª£ng v√† s√°ng t·∫°o d√†nh cho Pioneers.
      </p>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:10px">
    <h1 class="title">PiChordify Kingdom</h1>
    <div class="row">
      <span class="ver">v7.6</span>
      <img src="assets/musickingdom-golden-turtle.jpg" alt="Musickingdom Icon" class="mk-version-icon"/>
    </div>
  </div>

  <div class="grid">
    <!-- ===== Left: Editor ===== -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small" style="margin-bottom:8px">Nh·∫°c c·ª•</div>
          <div class="iconTab" role="tablist" aria-label="instrument">
            <button id="tabPiano" class="active" aria-selected="true"><img alt="piano" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Crect width='24' height='14' y='5' rx='3' fill='%23aab7ef'/%3E%3Crect x='3' y='5' width='3' height='14' fill='%230c1322'/%3E%3Crect x='8' y='5' width='2' height='14' fill='%230c1322'/%3E%3Crect x='12' y='5' width='2' height='14' fill='%230c1322'/%3E%3Crect x='16' y='5' width='2' height='14' fill='%230c1322'/%3E%3Crect x='19' y='5' width='3' height='14' fill='%230c1322'/%3E%3C/svg%3E"/>Piano</button>
            <button id="tabGuitar"><img alt="guitar" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M18 6l3-3 2 2-3 3a3 3 0 01-3 3l-2 2 2 2-3 3-4-4 3-3 2 2 2-2a3 3 0 003-3z' fill='%23ff7d7d'/%3E%3C/svg%3E"/>Guitar</button>
            <button id="tabUke"><img alt="ukulele" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Ccircle cx='8' cy='16' r='5' fill='%23b5e6ff'/%3E%3Crect x='12' y='14' width='8' height='4' rx='2' fill='%237bd1ff'/%3E%3Crect x='20' y='13' width='3' height='6' rx='1' fill='%237bd1ff'/%3E%3C/svg%3E"/>Ukulele</button>
          </div>
        </div>
        <div>
          <div class="small" style="margin-bottom:8px">Gi·ªçng (key)</div>
          <div class="row">
            <select id="selKey"></select>
            <div class="row">
              <button id="btnDown" class="btn ghost" title="Transpose -1">‚àí1</button>
              <button id="btnUp"   class="btn ghost" title="Transpose +1">+1</button>
              <span class="badge"><span id="transposeView">0</span> semitones</span>
            </div>
          </div>
        </div>
        <div>
          <div class="small" style="margin-bottom:8px">Ti·∫øn tr√¨nh</div>
          <select id="selProg">
            <option>I‚ÄìV‚Äìvi‚ÄìIV</option>
            <option>vi‚ÄìIV‚ÄìI‚ÄìV</option>
            <option>I‚Äìvi‚ÄìIV‚ÄìV</option>
            <option>ii‚ÄìV‚ÄìI</option>
            <option>12-bar</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <input id="title" placeholder="T√™n b√†i" style="flex:1"/>
        <button id="btnSuggest" class="btn">T·ª± g·ª£i √Ω h·ª£p √¢m</button>
      </div>

      <div class="row" style="margin-top:12px">
        <div style="flex:1">
          <div class="small">L·ªùi + h·ª£p √¢m (m·ªói d√≤ng c√≥ m·ªëc th·ªùi gian ‚Äî d·∫°ng: <span class="kbd">mm:ss Em / D</span>)</div>
          <textarea id="lyrics" placeholder="00:12   Em  /  D ..."></textarea>
        </div>
        <div style="flex:1">
          <div class="small">G·ª£i √Ω h·ª£p √¢m</div>
          <textarea id="suggest" class="mono" readonly></textarea>
        </div>
      </div>

      <!-- ===== Audio ===== -->
      <div style="margin-top:10px">
        <div class="row">
          <input id="audioUrl" placeholder="https://‚Ä¶/song.mp3" style="flex:1"/>
          <input id="filePick" type="file" accept="audio/mpeg" class="hidden"/>
          <button id="btnPick" class="btn ghost">Ch·ªçn MP3</button>
          <button id="btnLoad" class="btn ghost">Load</button>
        </div>
        <div class="row" style="margin-top:10px;align-items:center">
          <button id="btnPlay" class="btn">Play</button>
          <button id="btnPause" class="btn ghost">Pause</button>
          <button id="btnStop" class="btn bad">Stop</button>
          <span id="time" class="mono small">0:00 / 0:00</span>
        </div>
        <div class="progress" style="margin-top:8px"><i id="bar"></i></div>
      </div>

      <!-- ===== Local save / Export ===== -->
      <div class="row" style="margin-top:12px">
        <button id="btnSave" class="btn ghost">Save</button>
        <button id="btnLoadLocal" class="btn ghost">Load</button>
        <button id="btnShare" class="btn">Share link</button>
        <button id="btnPDF" class="btn ok">Export Lead Sheet (PDF)</button>
        <span class="small">L∆∞u c·ª•c b·ªô (localStorage). ‚ÄúShare link‚Äù m√£ ho√° trong URL.</span>
      </div>

      <audio id="audio" preload="auto"></audio>
    </div>

    <!-- ===== Right: Pi Login / Pay & Log ===== -->
    <div class="card rightBox">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>ƒêƒÉng nh·∫≠p & thanh to√°n</h3>
        <span class="badge">Pi Payment (LIVE)</span>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnPiLogin" class="btn ghost">Pi Login</button>
        <button id="btnCheck" class="btn ghost">Ki·ªÉm tra Premium</button>
        <button id="btnPiPay" class="btn">Pi Pay (LIVE)</button>
      </div>
     <div style="margin-top:10px; padding:6px; background:#151515; border-radius:6px;">
  <input id="txtBackend" placeholder="Backend URL" 
         style="width:75%; padding:6px; border-radius:6px; border:1px solid #333; background:#000; color:#fff;">
  <button onclick="localStorage.setItem('backend', txtBackend.value); location.reload()"
          style="padding:6px 12px; margin-left:4px; border-radius:6px; background:#4b7bff; border:none; color:white;">
    Save backend
  </button>
  <div style="margin-top:4px; font-size:12px; color:#aaa;">
    Current: <span id="backendNow"></span>
  </div>
</div>
<script>
  document.getElementById("backendNow").textContent = localStorage.getItem("backend") || "(none)";
</script>
      <div style="margin-top:12px">
        <div class="small">Log</div>
        <textarea id="log" class="mono" style="height:260px"></textarea>
        <div class="small">Console mirror (copy/paste ƒë∆∞·ª£c)</div>
      </div>
    </div>
  </div>

  <div class="small" style="margin-top:10px">¬© PiChordify Kingdom ‚Äî Hackathon demo ‚Äúc√≥ nh·∫°c th·∫≠t‚Äù</div>
  <!-- PI SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const logBox = $("log");
    function log(...args) {
      try {
        const now = new Date().toLocaleTimeString();
        const line =
          `[${now}] ` +
          args
            .map((x) => (typeof x === "string" ? x : JSON.stringify(x)))
            .join(" ");
        if (logBox) {
          logBox.value = (logBox.value ? logBox.value + "\n" : "") + line;
          logBox.scrollTop = logBox.scrollHeight;
        }
        console.log(...args);
      } catch (e) {
        console.error("log error", e);
      }
    }

    window.onerror = (m, s, l, c, e) => {
      log("‚ùå JS error:", m, "@", s, ":", l, c, e && e.stack);
    };
    window.addEventListener("unhandledrejection", (ev) => {
      log("‚ùå Promise error:", ev.reason && ev.reason.message || ev.reason);
    });
  </script>

  <script>
    // ===== Export PDF (Lead Sheet) =====
    document.getElementById("btnExportPdf").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const title = document.getElementById("title").value || "Untitled";
      const lines = [
        "Key: " + document.getElementById("selKey").value,
        "Progression: " + document.getElementById("selProg").value,
        "",
        "Suggestion:",
        ...document.getElementById("suggest").value.split("\n"),
        "",
        "Lyrics & Chords:",
        ...document.getElementById("lyrics").value.split("\n"),
      ];
      let y = 30;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text(title, 20, 20);
      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      for (const line of lines) {
        doc.text(line, 20, y);
        y += 7;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
      }
      doc.save((title || "lead-sheet") + ".pdf");
      log("‚úÖ exported PDF");
    });
  </script>

<script>
  // ======= Pi SDK & Payments (LIVE - mainnet) =======

  // URL backend l·∫•y t·ª´ localStorage (ƒë√£ ƒë∆∞·ª£c l∆∞u qua √¥ "Backend URL")
  const BACKEND_URL = (localStorage.getItem('backend') || '').replace(/\/$/, '');
  const API_BASE    = BACKEND_URL ? BACKEND_URL + '/api' : '';

  // ===== Pi init =====
  async function initPi() {
    if (!window.Pi) {
      log('‚ùå Pi SDK not found. H√£y m·ªü trong Pi Browser v√† ch·∫Øc script sdk.minepi.com ƒë√£ load.');
      return;
    }
    try {
      Pi.init({
        version: '2.0',
        sandbox: false,
        onIncompletePaymentFound(payment) {
          log('‚ö†Ô∏è  Incomplete payment (LIVE):', payment && payment.identifier);
        }
      });
      log('‚úÖ Pi SDK initialized (LIVE).');

      const isPiBrowser =
        typeof Pi.isPiBrowser === 'function' ? Pi.isPiBrowser() === true : false;
      if (!isPiBrowser) {
        log('‚ö†Ô∏è  Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c Pi Browser ‚Äì ch·ªâ n√™n test thanh to√°n th·∫≠t trong Pi Browser.');
      } else {
        log('‚úÖ ƒêang ch·∫°y trong Pi Browser (OK cho live payment).');
      }
    } catch (err) {
      log('‚ùå L·ªói init Pi SDK (LIVE):', err?.message || err);
    }
  }

  // ===== Helper: Pi Login =====
  async function piLogin() {
    try {
      const auth = await Pi.authenticate(
        ['username', 'payments'],
        (pin) => {
          log('üîê PIN callback ƒë∆∞·ª£c g·ªçi (LIVE).');
        }
      );
      if (!auth) {
        log('‚ùå Pi Login tr·∫£ v·ªÅ null/undefined.');
        return null;
      }
      log('‚úÖ Pi Login OK ‚Äì user:', auth.user && auth.user.username);
      log('‚ÑπÔ∏è  User info:', JSON.stringify({
        username: auth.user?.username,
        user_uid: auth.user?.uid
      }));
      return auth;
    } catch (err) {
      log('‚ùå Pi Login l·ªói (LIVE):', err?.message || err);
      return null;
    }
  }

  // ===== Helper: g·ªçi backend /create-payment =====
  async function backendCreatePayment(amount, username, user_uid) {
    if (!API_BASE) {
      log('‚ùå API_BASE r·ªóng ‚Äì ch∆∞a c·∫•u h√¨nh Backend URL.');
      throw new Error('API_BASE empty');
    }
    const payload = { amount, username, user_uid };

    const res = await fetch(API_BASE + '/create-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      log('‚ùå Backend /create-payment l·ªói:', data || await res.text());
      throw new Error(data.error || 'create-payment failed');
    }
    log('‚úÖ Backend /create-payment OK, payment:', data.payment && data.payment.identifier);
    return data.payment;
  }

  // ===== Pi Pay LIVE =====
  async function piPayLive(amount) {
    try {
      const auth = await piLogin();
      if (!auth || !auth.user) {
        log('‚ùå Kh√¥ng c√≥ th√¥ng tin user sau login, h·ªßy payment.');
        return;
      }

      const username = auth.user.username;
      const user_uid = auth.user.uid;

      log('‚û°Ô∏è  G·ª≠i d·ªØ li·ªáu t·∫°o payment l√™n backend:', username, user_uid);

      // 1) nh·ªù backend t·∫°o payment tr√™n Pi server
      const serverPayment = await backendCreatePayment(amount, username, user_uid);

      // 2) chu√¢Ãân b·ªã object cho Pi.createPayment
      const paymentDto = {
        amount: serverPayment.amount,
        memo:   serverPayment.memo,
        metadata: serverPayment.metadata,
        paymentId: serverPayment.identifier
      };

      const callbacks = {
        onReadyForServerApproval: async (paymentId) => {
          log('üü° readyForServerApproval (LIVE):', paymentId);
        },
        onReadyForServerCompletion: async (paymentId) => {
          log('üü° readyForServerCompletion (LIVE):', paymentId);
        },
        onCancel: (paymentId) => {
          log('‚õî PAYMENT CANCELLED (LIVE):', paymentId);
        },
        onError: (err) => {
          log('‚ùå PAYMENT ERROR (LIVE):', err?.message || err);
        }
      };

      log('‚ñ∂Ô∏è  B·∫Øt ƒë·∫ßu thanh to√°n LIVE, amount =', String(amount), 'Pi‚Ä¶');
      const payment = await Pi.createPayment(paymentDto, callbacks);
      log('‚úÖ createPayment (LIVE) ƒë√£ xong:', payment);
    } catch (e) {
      log('‚ùå X payment (LIVE) l·ªói:', e?.message || e);
    }
  }

<script>
  // ===== window.onload: ch·ªâ ch·∫°y khi DOM s·∫µn s√†ng =====
  window.addEventListener("load", () => {
    log("üì• window.load fired (LIVE section);");

    // C·∫≠p nh·∫≠t backend URL hi·ªán t·∫°i
    const span = document.getElementById("backendNow");
    if (span) {
      span.textContent = localStorage.getItem("backend") || "(none)";
    }

    // B·∫Øt event cho 3 n√∫t Pi
    const btnLogin  = document.getElementById("btnPiLogin");
    const btnPay    = document.getElementById("btnPiPay");
    const btnCheck  = document.getElementById("btnPiCheck");

    if (btnLogin) {
      btnLogin.addEventListener("click", () => {
        log("üîµ Pi Login button clicked");
        piLogin();
      });
    }

    if (btnPay) {
      btnPay.addEventListener("click", () => {
        log("üü£ Pi Pay (LIVE) button clicked");
        piPayLive(0.1); // amount test nh·ªè
      });
    }

    if (btnCheck) {
      btnCheck.addEventListener("click", async () => {
        log("üîç Check Premium: gi·∫£ l·∫≠p ki·ªÉm tra tr·∫°ng th√°i.");
        const auth = await piLogin();
        if (auth) {
          log(
            "‚≠ê Premium check demo cho user:",
            (auth.user && auth.user.username) || "(unknown)"
          );
        }
      });
    }
  });
</script>
</body>
</html>
